<!DOCTYPE html>
<html class='no-js'>
  <head>
    <meta charset='utf-8'>
    <meta content='IE=edge,chrome=1' http-equiv='X-UA-Compatible'>
    <title>Using rake for dataflow programming and data science | Blank Page Tech</title>
    <meta name="site" content="Blank Page Tech" />
    <meta name="og:site_name" content="Blank Page Tech" />
    <meta name="title" content="Using rake for dataflow programming and data science" />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="Using rake for dataflow programming and data science" />
    <meta name="twitter:site" content="@wschenk" />
    <meta name="og:title" content="Using rake for dataflow programming and data science" />
    <meta content='width=device-width' name='viewport'>
    <link href="../stylesheets/application-c2e1d785.css" rel="stylesheet" type="text/css" /><link href="../stylesheets/webicons-da5ecace.css" rel="stylesheet" type="text/css" /><link href="../stylesheets/googlecode-d3629bf4.css" rel="stylesheet" type="text/css" />
    <link href='//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.3/styles/default.min.css' rel='stylesheet'>
    <link rel="alternate" type="application/atom+xml" title="Atom Feed" href="/feed.xml" />
  </head>
  <body data-spy='scroll' data-target='.sidebar'>
    <nav class="navbar navbar-default navbar-fixed-top" role="navigation">
      <div class="container">
      <div class='visible-xs-block'>
      <div class="navbar-header">
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar-collapsable">
          <span class="sr-only">Toggle navigation</span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a href="/" class="navbar-brand">
        Blank Page Tech
      </a>
        
      </div>
    </div>
    <div class='hidden-xs'>
      <div class="navbar-header">
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar-collapsable">
          <span class="sr-only">Toggle navigation</span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a href="/" class="navbar-brand">
        Technology for the blank page
      </a>
        
      </div>
    </div>
    <div class="collapse navbar-collapse" id="navbar-collapsable">
      <ul class="nav navbar-nav navbar-right foo" id="menu">
      <li>
      <a href="/articles/">
        Articles
      </a>
    </li>
    <li class="dropdown">
      <a href="#" class="dropdown-toggle" data-toggle="dropdown">Topics <b class="caret"></b></a>
      <ul class="dropdown-menu">
        <li>
      <a href="/tags/howto/">
        Howtos
      </a>
    </li>
    <li>
      <a href="/tags/overview/">
        Overviews
      </a>
    </li>
    <li>
      <a href="/tags/product/">
        Product
      </a>
    </li>
    <li>
      <a href="/tags/tools/">
        Tools
      </a>
    </li>
    <li>
      <a href="/tags/socialinvestigator/">
        Social Investigator
      </a>
    </li>
    <li>
      <a href="/tags/ruby/">
        Ruby & Rails
      </a>
    </li>
    
      </ul>
    </li>
    <li class="dropdown">
      <a href="#" class="dropdown-toggle" data-toggle="dropdown">Tags <b class="caret"></b></a>
      <ul class="dropdown-menu">
        <li>
      <a href="/bootstrap-advanced-grid-tricks/">
        bootstrap (1)
      </a>
    </li>
    <li>
      <a href="/tags/bots/">
        bots (2)
      </a>
    </li>
    <li class="active">
      <a href="/using-rake-for-dataflow-programming-and-data-science/">
        data (1)
      </a>
    </li>
    <li>
      <a href="/osx-script-for-kiosk-mode/">
        gaze (1)
      </a>
    </li>
    <li>
      <a href="/using-seed-to-explore/">
        github (1)
      </a>
    </li>
    <li>
      <a href="/pulling-data-out-of-google-analytics/">
        googleanalytics (1)
      </a>
    </li>
    <li>
      <a href="/tags/happy_seed/">
        happy_seed (4)
      </a>
    </li>
    <li>
      <a href="/tags/howto/">
        howto (17)
      </a>
    </li>
    <li>
      <a href="/bower-with-rails/">
        javascript (1)
      </a>
    </li>
    <li>
      <a href="/tags/middleman/">
        middleman (6)
      </a>
    </li>
    <li>
      <a href="/setting-up-devise-with-twitter-and-facebook-and-other-omniauth-schemes-without-email-addresses/">
        oauth (1)
      </a>
    </li>
    <li>
      <a href="/tags/osx/">
        osx (2)
      </a>
    </li>
    <li>
      <a href="/tags/overview/">
        overview (4)
      </a>
    </li>
    <li>
      <a href="/tags/product/">
        product (2)
      </a>
    </li>
    <li>
      <a href="/tags/rails/">
        rails (5)
      </a>
    </li>
    <li>
      <a href="/tags/rake/">
        rake (2)
      </a>
    </li>
    <li>
      <a href="/building-a-gui-for-managing-middleman-blogs/">
        react (1)
      </a>
    </li>
    <li>
      <a href="/how-to-track-your-coworkers/">
        redis (1)
      </a>
    </li>
    <li>
      <a href="/tags/ruby/">
        ruby (16)
      </a>
    </li>
    <li>
      <a href="/receiving-posted-json-with-sinatra/">
        sinatra (1)
      </a>
    </li>
    <li>
      <a href="/tags/socialinvestigator/">
        socialinvestigator (4)
      </a>
    </li>
    <li>
      <a href="/dateslice-writing-rails-extensions/">
        sql (1)
      </a>
    </li>
    <li>
      <a href="/field-of-dreams-is-25-years-old-and-hasn-t-aged-well/">
        startupmyths (1)
      </a>
    </li>
    <li>
      <a href="/tags/static_sites/">
        static_sites (2)
      </a>
    </li>
    <li>
      <a href="/setting-up-testing/">
        testing (1)
      </a>
    </li>
    <li>
      <a href="/making-a-command-line-utility-with-gems-and-thor/">
        thor (1)
      </a>
    </li>
    <li>
      <a href="/tags/tools/">
        tools (5)
      </a>
    </li>
    <li>
      <a href="/tags/toys/">
        toys (5)
      </a>
    </li>
    
      </ul>
    </li>
    <li class="dropdown">
      <a href="#" class="dropdown-toggle" data-toggle="dropdown">Archives <b class="caret"></b></a>
      <ul class="dropdown-menu">
        <li>
      <a href="/inflight-internet/">
        Dec 2015 (1)
      </a>
    </li>
    <li>
      <a href="/using-seed-to-explore/">
        Sep 2015 (1)
      </a>
    </li>
    <li>
      <a href="/2015/07/">
        Jul 2015 (3)
      </a>
    </li>
    <li>
      <a href="/adding-search-to-a-middleman-blog/">
        Jun 2015 (1)
      </a>
    </li>
    <li>
      <a href="/2015/05/">
        May 2015 (2)
      </a>
    </li>
    <li>
      <a href="/why-engineers-build-crappy-products/">
        Feb 2015 (1)
      </a>
    </li>
    <li>
      <a href="/2015/01/">
        Jan 2015 (2)
      </a>
    </li>
    <li>
      <a href="/2014/12/">
        Dec 2014 (5)
      </a>
    </li>
    <li>
      <a href="/2014/11/">
        Nov 2014 (10)
      </a>
    </li>
    <li>
      <a href="/how-to-track-your-coworkers/">
        Oct 2014 (1)
      </a>
    </li>
    
      </ul>
    </li>
    
    </ul>
    <form class='navbar-form navbar-right' id='search' role='search'>
      <div class='form-group dropdown'>
        <div class='input-group'>
          <input autocomplete='off' class='form-control' id='search_box' placeholder='Search' type='text'>
          <span class='input-group-btn'>
            <button class='btn btn-default'>
              <span class='glyphicon glyphicon-search'></span>
            </button>
          </span>
        </div>
        <ul class='dropdown-menu dropdown-menu-left results'>
          <a href="/url">Title</a>
        </ul>
      </div>
    </form>
    
    </div>
    
    </div>
    </nav>
    <div class='article-header  '>
      <h1>Using rake for dataflow programming and data science</h1>
      <h2>Rake it like's hot</h2>
      <div class='tags'>
        <div class='tag'><a class="btn btn-primary" href="/tags/data/">data</a></div>
        <div class='tag'><a class="btn btn-primary" href="/tags/howto/">howto</a></div>
        <div class='tag'><a class="btn btn-primary" href="/tags/rake/">rake</a></div>
        <div class='tag'><a class="btn btn-primary" href="/tags/ruby/">ruby</a></div>
        <div class='tag'><a class="btn btn-primary" href="/tags/tools/">tools</a></div>
      </div>
      <a href='#comment_shower' id='comment_shower_scroll'>
        <span class='disqus-comment-count' data-disqus-identifier='2014-12-19-using-rake-for-dataflow-programming-and-data-science.html'></span>
      </a>
    </div>
    <div class='content'>
      <div class='row'>
        <div class='sidebar'>
          <ul class='nav toc' data-offset-top='400' data-spy='affix'>
            <li><a href="#top">Using rake for dataflow programming and data science</a></li>
            <li><a href="#rejected-titles-of-this-post">Rejected titles of this post</a></li>
            <li><a href="#tasks-and-dependancies">Tasks and Dependancies</a></li>
            <li><a href="#dataflow-programming">Dataflow programming</a></li>
            <li><a href="#file-tasks">File Tasks</a></li>
            <li><a href="#rake-as-a-build-system">Rake as a build system</a></li>
            <li><a href="#tasks-defined-as-rules">Tasks defined as Rules</a></li>
            <li><a href="#using-rake-to-pull-data-from-a-url">Using Rake to pull data from a url</a></li>
            <li><a href="#parse-json-using-simple-ruby-commands">Parse JSON using simple ruby commands</a></li>
            <li><a href="#parsing-html">Parsing HTML</a></li>
            <li><a href="#tasks-over-multiple-files">Tasks over multiple files</a></li>
            <li><a href="#using-rules-to-parse-data">Using rules to parse data</a></li>
            <li><a href="#get-your-own-rake-data">Get your own rake-data</a></li>
          </ul>
        </div>
        <div class='article' id='top'>
          <p>I&#39;ve been using Rake more and more for data collection and processing tasks.  Rake is pretty pretty powerful.  Most people know it as way to add external tasks to a Rails app, but it&#39;s actually very powerful build system.  We&#39;re going to take advantage of that to build out a <a href="https://github.com/HappyFunCorp/rake-data">framework</a> that will make it easy to collect, process, and interpret data while keeping it all in sync.</p>
          
          <p>In fact, if you just want to start playing with stuff now, head over to the <a href="https://github.com/HappyFunCorp/rake-data">rake-data</a> site to go through some walk throughs.  Read on to setup a fun world of your own!</p>
          
          <h2 id="rejected-titles-of-this-post">Rejected titles of this post</h2>
          
          <ul>
          <li>rake and bake</li>
          <li>rake me up before you go-go</li>
          <li>let them eat rake</li>
          <li>rake it until you make it</li>
          </ul>
          
          <h2 id="tasks-and-dependancies">Tasks and Dependancies</h2>
          
          <p>Rake is a a Make-like Ruby program that people know mostly in terms of rails apps.  We can define a few tasks and define their interdependancies:</p>
          
          <div class="diagram_right">
          <svg width="291pt" height="188pt" viewBox="0.00 0.00 291.36 188.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 184)"><title>G</title><polygon fill="white" stroke="none" points="-4,4 -4,-184 287.355,-184 287.355,4 -4,4"/><!-- a --><g id="node1" class="node"><title>a</title><ellipse fill="none" stroke="black" cx="93.105" cy="-162" rx="93.2101" ry="18"/><text text-anchor="middle" x="93.105" y="-157.8" font-family="Times,serif" font-size="14.00">mail daily leaderboards</text></g><!-- b --><g id="node2" class="node"><title>b</title><ellipse fill="none" stroke="black" cx="93.105" cy="-90" rx="83.0546" ry="18"/><text text-anchor="middle" x="93.105" y="-85.8" font-family="Times,serif" font-size="14.00">update leader boards</text></g><!-- a&#45;&gt;b --><g id="edge1" class="edge"><title>a&#45;&gt;b</title><path fill="none" stroke="black" d="M93.105,-143.697C93.105,-135.983 93.105,-126.712 93.105,-118.112"/><polygon fill="black" stroke="black" points="96.6051,-118.104 93.105,-108.104 89.6051,-118.104 96.6051,-118.104"/></g><!-- c --><g id="node3" class="node"><title>c</title><ellipse fill="none" stroke="black" cx="166.105" cy="-18" rx="54.6076" ry="18"/><text text-anchor="middle" x="166.105" y="-13.8" font-family="Times,serif" font-size="14.00">environment</text></g><!-- b&#45;&gt;c --><g id="edge2" class="edge"><title>b&#45;&gt;c</title><path fill="none" stroke="black" d="M110.776,-72.055C120.057,-63.1558 131.574,-52.1121 141.693,-42.4085"/><polygon fill="black" stroke="black" points="144.304,-44.7545 149.099,-35.307 139.459,-39.702 144.304,-44.7545"/></g><!-- d --><g id="node4" class="node"><title>d</title><ellipse fill="none" stroke="black" cx="239.105" cy="-90" rx="44.0015" ry="18"/><text text-anchor="middle" x="239.105" y="-85.8" font-family="Times,serif" font-size="14.00">flush data</text></g><!-- d&#45;&gt;c --><g id="edge3" class="edge"><title>d&#45;&gt;c</title><path fill="none" stroke="black" d="M222.54,-73.1159C213.062,-64.0273 200.997,-52.458 190.457,-42.3513"/><polygon fill="black" stroke="black" points="192.751,-39.702 183.111,-35.307 187.906,-44.7545 192.751,-39.702"/></g></g></svg></div>
          
          <pre><code class="rb">task :mail_daily_leader_boards =&gt; :update_leader_boards do&#x000A;  User.mail_leader_boards!&#x000A;end&#x000A;&#x000A;task :flush_data =&gt; :environment do&#x000A;  Leaderboard.flush!&#x000A;end&#x000A;&#x000A;task :update_leader_boards =&gt; :environment do&#x000A;  Leaderboard.update!&#x000A;end&#x000A;&#x000A;task :environment&#x000A;</code></pre>
          
          <p>When we run <code>mail_daily_leaderboards</code> it makes sure that <code>update_leader_boards</code> is run first.  This in turn depends upon <code>environment</code>, and Rake makes sure that all dependancies are met before executing the task.</p>
          
          <pre><code class="sh">$ rake mail_daily_leaderboards --dry-run&#x000A;** Invoke mail_daily_leader_boards (first_time)&#x000A;** Invoke update_leader_boards (first_time)&#x000A;** Invoke environment (first_time)&#x000A;** Execute (dry run) environment&#x000A;** Execute (dry run) update_leader_boards&#x000A;** Execute (dry run) mail_daily_leader_boards&#x000A;</code></pre>
          
          <p>Rake is also smart enough to only run a task once.  Lets look at what happens when we try to run two tasks:</p>
          
          <pre><code class="sh">$ rake flush_data mail_daily_leader_boards --dry-run&#x000A;** Invoke flush_data (first_time)&#x000A;** Invoke environment (first_time)&#x000A;** Execute (dry run) environment&#x000A;** Execute (dry run) flush_data&#x000A;** Invoke mail_daily_leader_boards (first_time)&#x000A;** Invoke update_leader_boards (first_time)&#x000A;** Invoke environment &#x000A;** Execute (dry run) update_leader_boards&#x000A;** Execute (dry run) mail_daily_leader_boards&#x000A;</code></pre>
          
          <p>Notice here that even though <code>update_leader_boards</code> and <code>flush_data</code> both depend on <code>environment</code>, so it needs to be run for either of the dependant tasks to run, and it is only invoked once.</p>
          
          <p>So far so good.</p>
          
          <h2 id="dataflow-programming">Dataflow programming</h2>
          
          <p>So Rake gives us a dependancy specification and resolution process.  We can visualize this in two ways.  One way is where the arrows are pointing to sub tasks, top down, where the arrow direction represents the control flow control of the process.  When you want A, it makes sure that B and C are there, which in turn have their own dependancies.</p>
          
          <p>What does it mean if we were to reverse the arrows on the graph?</p>
          
          <table class="table table-bordered">
            <tr>
              <th style="text-align: center">Top Down</th>
              <th style="text-align: center">Bottom Up</th>
            </tr>
          
            <tr>
              <td style="text-align: center">
          <svg width="134pt" height="188pt" viewBox="0.00 0.00 134.00 188.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 184)"><title>%3</title><polygon fill="white" stroke="none" points="-4,4 -4,-184 130,-184 130,4 -4,4"/><!-- A --><g id="node1" class="node"><title>A</title><ellipse fill="none" stroke="black" cx="63" cy="-162" rx="27" ry="18"/><text text-anchor="middle" x="63" y="-157.8" font-family="Times,serif" font-size="14.00">A</text></g><!-- B --><g id="node2" class="node"><title>B</title><ellipse fill="none" stroke="black" cx="27" cy="-90" rx="27" ry="18"/><text text-anchor="middle" x="27" y="-85.8" font-family="Times,serif" font-size="14.00">B</text></g><!-- A&#45;&gt;B --><g id="edge1" class="edge"><title>A&#45;&gt;B</title><path fill="none" stroke="black" d="M54.6504,-144.765C50.2885,-136.283 44.8531,-125.714 39.9587,-116.197"/><polygon fill="black" stroke="black" points="42.9904,-114.439 35.3043,-107.147 36.7654,-117.641 42.9904,-114.439"/></g><!-- C --><g id="node3" class="node"><title>C</title><ellipse fill="none" stroke="black" cx="99" cy="-90" rx="27" ry="18"/><text text-anchor="middle" x="99" y="-85.8" font-family="Times,serif" font-size="14.00">C</text></g><!-- A&#45;&gt;C --><g id="edge2" class="edge"><title>A&#45;&gt;C</title><path fill="none" stroke="black" d="M71.3496,-144.765C75.7115,-136.283 81.1469,-125.714 86.0413,-116.197"/><polygon fill="black" stroke="black" points="89.2346,-117.641 90.6957,-107.147 83.0096,-114.439 89.2346,-117.641"/></g><!-- D --><g id="node4" class="node"><title>D</title><ellipse fill="none" stroke="black" cx="27" cy="-18" rx="27" ry="18"/><text text-anchor="middle" x="27" y="-13.8" font-family="Times,serif" font-size="14.00">D</text></g><!-- B&#45;&gt;D --><g id="edge3" class="edge"><title>B&#45;&gt;D</title><path fill="none" stroke="black" d="M27,-71.6966C27,-63.9827 27,-54.7125 27,-46.1124"/><polygon fill="black" stroke="black" points="30.5001,-46.1043 27,-36.1043 23.5001,-46.1044 30.5001,-46.1043"/></g><!-- C&#45;&gt;D --><g id="edge4" class="edge"><title>C&#45;&gt;D</title><path fill="none" stroke="black" d="M84.4297,-74.8345C74.2501,-64.9376 60.4761,-51.5462 48.9694,-40.3591"/><polygon fill="black" stroke="black" points="51.4055,-37.8461 41.7957,-33.3847 46.5259,-42.865 51.4055,-37.8461"/></g><!-- E --><g id="node5" class="node"><title>E</title><ellipse fill="none" stroke="black" cx="99" cy="-18" rx="27" ry="18"/><text text-anchor="middle" x="99" y="-13.8" font-family="Times,serif" font-size="14.00">E</text></g><!-- C&#45;&gt;E --><g id="edge5" class="edge"><title>C&#45;&gt;E</title><path fill="none" stroke="black" d="M99,-71.6966C99,-63.9827 99,-54.7125 99,-46.1124"/><polygon fill="black" stroke="black" points="102.5,-46.1043 99,-36.1043 95.5001,-46.1044 102.5,-46.1043"/></g></g></svg>    </td>
          
              <td style="text-align: center">
          <svg width="134pt" height="188pt" viewBox="0.00 0.00 134.00 188.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 184)"><title>%3</title><polygon fill="white" stroke="none" points="-4,4 -4,-184 130,-184 130,4 -4,4"/><!-- E --><g id="node1" class="node"><title>E</title><ellipse fill="none" stroke="black" cx="27" cy="-162" rx="27" ry="18"/><text text-anchor="middle" x="27" y="-157.8" font-family="Times,serif" font-size="14.00">E</text></g><!-- C --><g id="node2" class="node"><title>C</title><ellipse fill="none" stroke="black" cx="27" cy="-90" rx="27" ry="18"/><text text-anchor="middle" x="27" y="-85.8" font-family="Times,serif" font-size="14.00">C</text></g><!-- E&#45;&gt;C --><g id="edge1" class="edge"><title>E&#45;&gt;C</title><path fill="none" stroke="black" d="M27,-143.697C27,-135.983 27,-126.712 27,-118.112"/><polygon fill="black" stroke="black" points="30.5001,-118.104 27,-108.104 23.5001,-118.104 30.5001,-118.104"/></g><!-- A --><g id="node5" class="node"><title>A</title><ellipse fill="none" stroke="black" cx="63" cy="-18" rx="27" ry="18"/><text text-anchor="middle" x="63" y="-13.8" font-family="Times,serif" font-size="14.00">A</text></g><!-- C&#45;&gt;A --><g id="edge4" class="edge"><title>C&#45;&gt;A</title><path fill="none" stroke="black" d="M35.3496,-72.7646C39.7115,-64.2831 45.1469,-53.7144 50.0413,-44.1974"/><polygon fill="black" stroke="black" points="53.2346,-45.6409 54.6957,-35.1473 47.0096,-42.4395 53.2346,-45.6409"/></g><!-- D --><g id="node3" class="node"><title>D</title><ellipse fill="none" stroke="black" cx="99" cy="-162" rx="27" ry="18"/><text text-anchor="middle" x="99" y="-157.8" font-family="Times,serif" font-size="14.00">D</text></g><!-- D&#45;&gt;C --><g id="edge2" class="edge"><title>D&#45;&gt;C</title><path fill="none" stroke="black" d="M84.4297,-146.834C74.2501,-136.938 60.4761,-123.546 48.9694,-112.359"/><polygon fill="black" stroke="black" points="51.4055,-109.846 41.7957,-105.385 46.5259,-114.865 51.4055,-109.846"/></g><!-- B --><g id="node4" class="node"><title>B</title><ellipse fill="none" stroke="black" cx="99" cy="-90" rx="27" ry="18"/><text text-anchor="middle" x="99" y="-85.8" font-family="Times,serif" font-size="14.00">B</text></g><!-- D&#45;&gt;B --><g id="edge3" class="edge"><title>D&#45;&gt;B</title><path fill="none" stroke="black" d="M99,-143.697C99,-135.983 99,-126.712 99,-118.112"/><polygon fill="black" stroke="black" points="102.5,-118.104 99,-108.104 95.5001,-118.104 102.5,-118.104"/></g><!-- B&#45;&gt;A --><g id="edge5" class="edge"><title>B&#45;&gt;A</title><path fill="none" stroke="black" d="M90.6504,-72.7646C86.2885,-64.2831 80.8531,-53.7144 75.9587,-44.1974"/><polygon fill="black" stroke="black" points="78.9904,-42.4395 71.3043,-35.1473 72.7654,-45.6409 78.9904,-42.4395"/></g></g></svg>    </td>
            </tr>
          </table>
          
          <p>If we think about rake in terms of managing a build process, what we called <em>dependancies</em> are actually the source of the data.  If we want an object file, we start with the source file.  If we want to generate C, we need to have generated the data for D and E.</p>
          
          <h2 id="file-tasks">File Tasks</h2>
          
          <p>Rake also knows about building files.  <code>Rake::FileTask</code> is a subtask of <code>Rake::Task</code> which will only run the target if the <em>file is out of date</em> : if the source file is newer than the destination file.</p>
          
          <pre><code class="rb">file &quot;Rakefile.gz&quot; =&gt; &quot;Rakefile&quot; do |task|&#x000A;  sh &quot;gzip -fkv #{task.source}&quot;&#x000A;end&#x000A;</code></pre>
          
          <p>This defined as task called <code>Rakefile.gz</code> that when invoked will look to see if either the file doesn&#39;t exist, or if it&#39;s older than the source file <code>Rakefile</code>, and gzips it up.</p>
          
          <pre><code class="sh">$ rake Rakefile.gz&#x000A;gzip -fkv Rakefile&#x000A;Rakefile:   -20.6% -- replaced with Rakefile.gz&#x000A;</code></pre>
          
          <p>Run it again and nothing happens!</p>
          
          <pre><code class="sh">$ rake Rakefile.gz&#x000A;$&#x000A;</code></pre>
          
          <p>Touch the source file and it gets rebuilt:</p>
          
          <pre><code class="sh">$ touch Rakefile&#x000A;$ rake Rakefile.gz&#x000A;gzip -fkv Rakefile&#x000A;Rakefile:   -20.6% -- replaced with Rakefile.gz&#x000A;</code></pre>
          
          <h2 id="rake-as-a-build-system">Rake as a build system</h2>
          
          <p>Files and rules come from Rake&#39;s <code>make</code> heritage.  We can think of regular <code>Task</code>s as being a general sort of <em>action</em>, meaning you are packaging up certain set of imperitives in a particular context to achieve some goal.  <code>FileTask</code>s are a more specific type of action, where we want to generate a specific file from a specific source file.  For a full build system we want to be able to translate whole classes of files into other files, like source files into object files, or XML files into HTML files.  We use <code>Rules</code> to set these up.</p>
          
          <h2 id="tasks-defined-as-rules">Tasks defined as Rules</h2>
          
          <p>The third main bit of magic that Rake gives us is rules.  The file task can magically bring a file into being when invoked, but in a build process its more common to translate files with a certain extention to other files in a different extension.  The canonical example is probably compiling <code>.c</code> source files into <code>.o</code> objects, but since it&#39;s the 21 first century lets look at how to run the Graphviz dot file to process into svg or png files.</p>
          
          <pre><code class="rb">rule &quot;.svg&quot; =&gt; &quot;.dot&quot; do |task|&#x000A;  sh &quot;dot -Tsvg &lt; #{task.source} &gt; #{task}&quot;&#x000A;end&#x000A;&#x000A;rule &quot;.png&quot; =&gt; &quot;.dot&quot; do |task|&#x000A;  sh &quot;dot -Tpng &lt; #{task.source} &gt; #{task}&quot;&#x000A;end&#x000A;</code></pre>
          
          <p>Now we can ask Rake to build a <em>type</em> of file, and will look for a source file based upon the name that you request.  For example, if we were to run the command:</p>
          
          <pre><code class="sh">$ rake bottom.svg&#x000A;dot -Tsvg &lt; bottom.dot &gt; bottom.svg&#x000A;$&#x000A;</code></pre>
          
          <p>Rake would try to instantiate the file <code>bottom.svg</code> by first requesting file called <code>bottom.dot</code>.  Since this is part of the rake dependancy system, this could in turn be built by a seperate rake task!</p>
          
          <p>Note that Rake doesn&#39;t know anything specifically about these extension.  It just knows what you have defined.  We can define other formats and build rules around that.</p>
          
          <h2 id="using-rake-to-pull-data-from-a-url">Using Rake to pull data from a url</h2>
          
          <p>Let&#39;s extend the Rake DSL to be able to download files from the internet.  You can put this at the top of your <code>Rakefile</code> for now.</p>
          
          <pre><code class="rb">def url( dest, source )&#x000A;  file dest do&#x000A;    puts &quot;Loading #{source}&quot;&#x000A;    if !File.exists?( dest )&#x000A;      mkdir_p dest.to_s.pathmap( &quot;%d&quot; )&#x000A;      sh &quot;curl -L &#39;#{source}&#39; &gt; #{dest}&quot;&#x000A;    end&#x000A;  end&#x000A;end&#x000A;</code></pre>
          
          <p>Lets use this to download a file from the internet do we can parse it.</p>
          
          <pre><code class="rb">url &quot;source/weather.json&quot;, &quot;http://api.openweathermap.org/data/2.5/weather?id=5128581&quot;&#x000A;</code></pre>
          
          <p>When we run <code>rake source/weather.json</code> the first time, the file is downloaded.  The second time we run the rake command nothing happens since the <code>source/weather.json</code> file already exists.  Lets add a quick task to parse the JSON.</p>
          
          <h2 id="parse-json-using-simple-ruby-commands">Parse JSON using simple ruby commands</h2>
          
          <p>Lets parse the file:</p>
          
          <pre><code class="rb">require &#39;json&#39;&#x000A;file &quot;report.txt&quot; =&gt; &quot;source/weather.json&quot; do |task|&#x000A;  puts &quot;Parsing sun times&quot;&#x000A;  data = JSON.parse( File.read( task.source ))&#x000A;  File.open( task.to_s, &quot;wb&quot; ) do |out|&#x000A;    out.printf &quot;%-15s %s\n&quot;, &#39;sunrise&#39;, Time.at( data[&#39;sys&#39;][&#39;sunrise&#39;] )&#x000A;    out.printf &quot;%-15s %s\n&quot;, &#39;sunset&#39;,  Time.at( data[&#39;sys&#39;][&#39;sunset&#39;] )&#x000A;  end&#x000A;end&#x000A;</code></pre>
          
          <p>Run <code>rake report.txt</code>.  This should generate the file the first time, and on subsequent runs, do nothing.  If you remove <code>source/weather.json</code> file and run <code>rake report.txt</code> again, you&#39;ll see that Rake is smart enough to download a new version of the file.</p>
          
          <h2 id="parsing-html">Parsing HTML</h2>
          
          <p>Another common thing to do is to download a webpage and parse through the results.  <code>Nokogiri</code> makes this really easy since you can identify DOM elements using CSS selectors more or less the same a jQuery selectors.</p>
          
          <p>Lets make a function to help us parse html files into CSV files:</p>
          
          <pre><code class="rb"># Parse an HTML file into CSV&#x000A;def parse_html( dest, source, &amp;parser )&#x000A;  require &#39;nokogiri&#39;&#x000A;  require &#39;csv&#39;&#x000A;&#x000A;  file dest =&gt; source do&#x000A;    puts &quot;Parsing #{source} -&gt; #{dest}&quot;&#x000A;    mkdir_p dest.to_s.pathmap( &quot;%d&quot; )&#x000A;&#x000A;    html = Nokogiri.parse( File.read( source ) )&#x000A;    CSV.open( dest.to_s, &quot;wb&quot; ) do |csv|&#x000A;      parser.call( html, csv )&#x000A;    end&#x000A;  end&#x000A;end&#x000A;</code></pre>
          
          <p>This defines a file task to convert one file type into another.  When it needs to run -- and this will only happen of the source file changes or the destination file doesnt exist -- it loads up the file into Nokogiri, creates a CSV output file, and passes control to a passed in block for processing.</p>
          
          <p>Let&#39;s pull out a list of the top 10 popular books on project gutenberg for the last month:</p>
          
          <pre><code class="rb"># Load the html file with statistics&#x000A;url &quot;source/top.html&quot;, &quot;http://www.gutenberg.org/browse/scores/top&quot;&#x000A;&#x000A;parse_html &quot;processed/month_top_100.csv&quot;, &quot;source/top.html&quot; do |html,out|&#x000A;  html.css( &quot;h2#books-last30 + ol a&quot; ).each do |link|&#x000A;    out &lt;&lt; [link[&#39;href&#39;],link.content]&#x000A;  end&#x000A;end&#x000A;&#x000A;file &quot;processed/month_top_10.csv&quot; =&gt; &quot;processed/month_top_100.csv&quot; do |task|&#x000A;  sh &quot;head -n 10 #{task.source} &gt; #{task}&quot;&#x000A;end&#x000A;</code></pre>
          
          <p>And now run <code>rake processed/month_top_10.csv</code> and watch what happens.  This only hits the server the first time it&#39;s run.  If we want to process things again, we simply delete the files in the <code>source</code> directory and everything in the <code>processed</code> directory will get regenerated.</p>
          
          <h2 id="tasks-over-multiple-files">Tasks over multiple files</h2>
          
          <p>We have a few CSV files that contain a list of books.  How would we do something with these books?  The natural thing would be to use Rake&#39;s <code>FileList</code>, but this doesn&#39;t work the way you&#39;d expect because <code>FileList</code> caches its results and it therefor doesn&#39;t know about files that are created during the build process.  We don&#39;t want to have to run rake twice to get our results, we want to be able to trust the process!</p>
          
          <p>Let&#39;s extend the DSL again to add a command that will loop over a file and call our block for each line:</p>
          
          <pre><code class="rb"># Loop over a file and yield the block for each line&#x000A;# If name ends with .csv, parse the csv and yield each line&#x000A;def file_loop( name, source )&#x000A;  task name =&gt; source do&#x000A;    if source =~ /.csv$/&#x000A;      CSV.open( source ).each do |line|&#x000A;        yield line&#x000A;      end&#x000A;    else&#x000A;      File.readlines( source ).each do |line|&#x000A;        yield line&#x000A;      end&#x000A;    end&#x000A;  end&#x000A;end&#x000A;</code></pre>
          
          <p>Now we can use this to create a task that goes through each of the lines of the file.  We&#39;ll do this to define url tasks for the file and then immediately invoke them so make sure that the file was loaded.</p>
          
          <pre><code class="rb"># Loop through the top ten books and make sure that they exist&#x000A;file_loop &quot;processed/top_10_books_text&quot;, &quot;processed/month_top_10.csv&quot; do |line|&#x000A;  path = &quot;#{line[0].gsub( /^\//, &quot;&quot; )}.txt&quot;&#x000A;  puts path&#x000A;  url( path, &quot;http://www.gutenberg.org/#{path}.utf-8&quot;)&#x000A;  Rake::Task[path].invoke&#x000A;end&#x000A;</code></pre>
          
          <p>Running <code>rake processed/top_10_books_text</code> will first make sure that <code>processed/month_top_10.csv</code> is up-to-date, doing whatever it needs too to make it happen, and then loop through each of the lines and download the ebook file.</p>
          
          <p><em>Note, we are going to be making a bunch of requests to the Project Gutenberg website, a total of 11 in all.  You might be flagged as a bot, so take a look at the generated <code>.txt</code> files to make sure that they actually contain the book content. <strong>But no matter how many times you run your commands, unless you delete the downloaded files there will be no more than 11 requests to the server!</strong></em></p>
          
          <h2 id="using-rules-to-parse-data">Using rules to parse data</h2>
          
          <p>Lets create a rule that will give us a count of all the words in a book:</p>
          
          <pre><code class="rb"># Count and sort the list of words&#x000A;rule &quot;.word_count&quot; =&gt; &quot;.words&quot; do |dest|&#x000A;  sh &quot;cat #{dest.source} | sort | uniq -c | sort -nr&gt; #{dest}&quot;&#x000A;end&#x000A;</code></pre>
          
          <p>If we try to run this now, say <code>rake ebooks/1342.word_count</code> we&#39;ll get an error saying it doesn&#39;t know how to build that file.  Let&#39;s add a rule to go from <code>.txt</code> to <code>.words</code>:</p>
          
          <pre><code class="rb"># Covert txt to words&#x000A;rule &quot;.words&quot; =&gt; &quot;.txt&quot; do |dest|&#x000A;  sh &quot;cat #{dest.source} | tr -cs &#39;[:alpha:]&#39; &#39;\n&#39; | tr &#39;[:upper:]&#39; &#39;[:lower:]&#39; &gt; #{dest}&quot;&#x000A;end&#x000A;</code></pre>
          
          <p>Now when we run it, we first generate a list of words, and then from that we find the unique count of them.</p>
          
          <h2 id="get-your-own-rake-data">Get your own rake-data</h2>
          
          <p>It&#39;s simple enough to setup this on your own, but I&#39;ve put together a few useful things that I&#39;ve been using to process data into it&#39;s own gem.  You should head over to <a href="https://github.com/HappyFunCorp/rake-data">https://github.com/HappyFunCorp/rake-data</a> now to check it out!</p>
          
          <p>Other things to check out:</p>
          
          <ul>
          <li><a href="http://blog.kaggle.com/2012/10/15/make-for-data-scientists/">http://blog.kaggle.com/2012/10/15/make-for-data-scientists/</a></li>
          <li><a href="http://blog.factual.com/introducing-drake-a-kind-of-make-for-data">http://blog.factual.com/introducing-drake-a-kind-of-make-for-data</a></li>
          <li><a href="http://datascienceatthecommandline.com">http://datascienceatthecommandline.com</a></li>
          </ul>
        </div>
        <div class='navigation' data-offset-top='400' data-spy='affix'>
          <div class='next'>
            <p>
              Next in
              <a href="/articles/">Chronological</a>
              <a href="/tags/ruby/">Ruby</a>
              <a href="/tags/howto/">Howto</a>
            </p>
            <p class='title'><a href="/setting-up-devise-with-twitter-and-facebook-and-other-omniauth-schemes-without-email-addresses/">Setting up Devise with Twitter and Facebook and other Omniauth schemes without email addresses</a></p>
            <p>
              Next in
              <a href="/tags/rake/">Rake</a>
            </p>
            <p class='title'><a href="/using-seed-to-explore/">Using seed to explore APIs</a></p>
          </div>
          <div class='prev'>
            <p>
              Previously in
              <a href="/articles/">Chronological</a>
              <a href="/tags/ruby/">Ruby</a>
              <a href="/tags/howto/">Howto</a>
            </p>
            <p class='title'><a href="/building-middleman-extensions/">Building Middleman Extensions</a></p>
            <p>
              Previously in
              <a href="/tags/tools/">Tools</a>
            </p>
            <p class='title'><a href="/middleman-tricks-and-hacks/">Middleman Tricks and Hacks</a></p>
          </div>
        </div>
      </div>
      <div class="row article_footer">
        <div class="comments">
            <a href="#" id="comment_shower">
              <p class="disqus-comment-count" data-disqus-identifier="2014-12-19-using-rake-for-dataflow-programming-and-data-science.html">Be the first to comment.</p>
            </a>
        </div>
        <div class="sharing">
          <a href="http://www.twitter.com/share?url=http://willschenk.com/using-rake-for-dataflow-programming-and-data-science/&amp;text=Using rake for dataflow programming and data science by @wschenk" title="Share this post on Twitter" data-lang="en" onclick="return !window.open(this.href, 'Twitter', 'width=640,height=300')" class="webicon twitter"></a>
      
          <a target="_blank" onclick="return !window.open(this.href, 'Facebook', 'width=640,height=300')" href="http://www.facebook.com/sharer/sharer.php?u=http://willschenk.com/using-rake-for-dataflow-programming-and-data-science/" title="Share this post on Facebook" class="webicon facebook"></a>
      
          <a href="http://plus.google.com/share?url=http://willschenk.com/using-rake-for-dataflow-programming-and-data-science/" target="_blank" onclick="return !window.open(this.href, 'Google +', 'width=640,height=300')" title="Share this post on Google +" class="webicon google"></a>
        </div>
      </div>
        <div class="comment_row">
          <div class="comment_universe">
            <div id="disqus_thread" class="col-sm-10 col-sm-offset-1"></div>
          </div>
        </div>
    </div>
    <footer class='codex'>
      <div class='container'>
        <div class='row'>
          <div class='logo'>
            <a href='http://codex.happyfuncorp.com/'>
              <img src="../images/ted-16edc59a.png" />
              <img src="../images/codex_logo-02a37740.png" />
            </a>
          </div>
        </div>
        <div class='row'>
          <div class='body'>
            <h3>
              If you find this blog helpful, check out
              <a href='http://codex.happyfuncorp.com/'>
                codex
              </a>
            </h3>
            <p>Product, development, design and a whole slew of other things you need to know.</p>
            <p>
              From the fancy folks at
              <a href="http://happyfuncorp.com">HappyFunCorp</a>
            </p>
          </div>
        </div>
      </div>
    </footer>
    <footer class='footer  '>
      <div class='container'>
        <div class='row'>
          <div class='social'>
            <span>
              <a class='webicon twitter' href='http://twitter.com/wschenk'></a>
            </span>
            <span>
              <a class='webicon tumblr' href='http://sublimeguile.com/'></a>
            </span>
            <span>
              <a class='webicon instagram' href='http://instagram.com/wschenk'></a>
            </span>
            <span>
              <a class='webicon linkedin' href='http://www.linkedin.com/pub/will-schenk/0/266/420/'></a>
            </span>
            <span>
              <a class='webicon github' href='https://github.com/wschenk'></a>
            </span>
            <span>
              <a class='webicon rss' href='http://willschenk.com/feed.xml'></a>
            </span>
            <span>
              <a class='webicon mail' href='mailto:will@happyfuncorp.com'></a>
            </span>
          </div>
          <div class='made_in_bk'>
            <h3>Made in Brooklyn, NY</h3>
          </div>
        </div>
      </div>
    </footer>
    <script src="../javascripts/application-b5017286.js" type="text/javascript"></script><script src="../javascripts/modernizr-84a49412.js" type="text/javascript"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.3/highlight.min.js"></script>
    <script type="text/javascript">
      var _gaq=[['_setAccount','UA-56296045-1'],['_trackPageview']];
      (function(d,t){var g=d.createElement(t),s=d.getElementsByTagName(t)[0];
      g.src=('https:'==location.protocol?'//ssl':'//www')+'.google-analytics.com/ga.js';
      s.parentNode.insertBefore(g,s)}(document,'script'));
    </script>
    
    <script type="text/javascript">
      hljs.initHighlightingOnLoad();
      $(".article img").addClass( "img-responsive");
      $("iframe").map( function(e) {
        $(this).css( "max-width", $(this).width() );
        $(this).width( "100%" );
      });
      var _gaq=[['_setAccount','UA-56296045-1'],['_trackPageview']];
      (function(d,t){var g=d.createElement(t),s=d.getElementsByTagName(t)[0];
      g.src=('https:'==location.protocol?'//ssl':'//www')+'.google-analytics.com/ga.js';
      s.parentNode.insertBefore(g,s)}(document,'script'));
      var disqus_shortname = 'willschenk';
      var disqus_url = 'http://willschenk.com/using-rake-for-dataflow-programming-and-data-science/';
        var disqus_identifier = '2014-12-19-using-rake-for-dataflow-programming-and-data-science.html';
            
      (function() {
          var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
          dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
          (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      })();
      (function () {
    var s = document.createElement('script'); s.async = true;
    s.type = 'text/javascript';
    s.src = 'http://' + disqus_shortname + '.disqus.com/count.js';
    (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
    </script>
  </body>
</html>
