<!DOCTYPE html>
<html class='no-js'>
  <head>
    <meta charset='utf-8'>
    <meta content='IE=edge,chrome=1' http-equiv='X-UA-Compatible'>
    <title>Setting up Devise with Twitter and Facebook and other Omniauth schemes without email addresses | Blank Page Tech</title>
    <meta name="site" content="Blank Page Tech" />
    <meta name="og:site_name" content="Blank Page Tech" />
    <meta name="title" content="Setting up Devise with Twitter and Facebook and other Omniauth schemes without email addresses" />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="Setting up Devise with Twitter and Facebook and other Omniauth schemes without email addresses" />
    <meta name="twitter:site" content="@wschenk" />
    <meta name="og:title" content="Setting up Devise with Twitter and Facebook and other Omniauth schemes without email addresses" />
    <meta content='width=device-width' name='viewport'>
    <link href="../stylesheets/application-18143f85.css" rel="stylesheet" type="text/css" /><link href="../stylesheets/webicons-da5ecace.css" rel="stylesheet" type="text/css" /><link href="../stylesheets/socicons-d8ab83dd.css" rel="stylesheet" type="text/css" /><link href="../stylesheets/animate-8335fea6.css" rel="stylesheet" type="text/css" /><link href="../stylesheets/googlecode-d3629bf4.css" rel="stylesheet" type="text/css" />
    <link href='//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.3/styles/default.min.css' rel='stylesheet'>
    <link rel="alternate" type="application/atom+xml" title="Atom Feed" href="/feed.xml" />
  </head>
  <body data-spy='scroll' data-target='.sidebar'>
    <nav class="navbar navbar-default navbar-fixed-top" role="navigation">
      <div class="container">
      <div class='visible-xs-block'>
      <div class="navbar-header">
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar-collapsable">
          <span class="sr-only">Toggle navigation</span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a href="/" class="navbar-brand">
        Blank Page Tech
      </a>
        
      </div>
    </div>
    <div class='hidden-xs'>
      <div class="navbar-header">
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar-collapsable">
          <span class="sr-only">Toggle navigation</span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a href="/" class="navbar-brand">
        Technology for the blank page
      </a>
        
      </div>
    </div>
    <div class="collapse navbar-collapse" id="navbar-collapsable">
      <ul class="nav navbar-nav navbar-right foo" id="menu">
      <li>
      <a href="/articles/">
        Articles
      </a>
    </li>
    <li class="dropdown">
      <a href="#" class="dropdown-toggle" data-toggle="dropdown">Topics <b class="caret"></b></a>
      <ul class="dropdown-menu">
        <li>
      <a href="/tags/howto/">
        Howtos
      </a>
    </li>
    <li>
      <a href="/tags/overview/">
        Overviews
      </a>
    </li>
    <li>
      <a href="/tags/product/">
        Product
      </a>
    </li>
    <li>
      <a href="/tags/tools/">
        Tools
      </a>
    </li>
    <li>
      <a href="/tags/socialinvestigator/">
        Social Investigator
      </a>
    </li>
    <li>
      <a href="/tags/ruby/">
        Ruby & Rails
      </a>
    </li>
    
      </ul>
    </li>
    <li class="dropdown">
      <a href="#" class="dropdown-toggle" data-toggle="dropdown">Tags <b class="caret"></b></a>
      <ul class="dropdown-menu">
        <li>
      <a href="/bootstrap-advanced-grid-tricks/">
        bootstrap (1)
      </a>
    </li>
    <li>
      <a href="/tags/bots/">
        bots (2)
      </a>
    </li>
    <li>
      <a href="/using-rake-for-dataflow-programming-and-data-science/">
        data (1)
      </a>
    </li>
    <li>
      <a href="/pulling-data-out-of-google-analytics/">
        googleanalytics (1)
      </a>
    </li>
    <li>
      <a href="/tags/happy_seed/">
        happy_seed (3)
      </a>
    </li>
    <li>
      <a href="/tags/howto/">
        howto (13)
      </a>
    </li>
    <li>
      <a href="/tags/middleman/">
        middleman (4)
      </a>
    </li>
    <li class="active">
      <a href="/setting-up-devise-with-twitter-and-facebook-and-other-omniauth-schemes-without-email-addresses/">
        oauth (1)
      </a>
    </li>
    <li>
      <a href="/making-yosemite-faster/">
        osx (1)
      </a>
    </li>
    <li>
      <a href="/tags/overview/">
        overview (4)
      </a>
    </li>
    <li>
      <a href="/tags/product/">
        product (2)
      </a>
    </li>
    <li>
      <a href="/tags/rails/">
        rails (3)
      </a>
    </li>
    <li>
      <a href="/using-rake-for-dataflow-programming-and-data-science/">
        rake (1)
      </a>
    </li>
    <li>
      <a href="/how-to-track-your-coworkers/">
        redis (1)
      </a>
    </li>
    <li>
      <a href="/tags/ruby/">
        ruby (14)
      </a>
    </li>
    <li>
      <a href="/tags/socialinvestigator/">
        socialinvestigator (4)
      </a>
    </li>
    <li>
      <a href="/dateslice-writing-rails-extensions/">
        sql (1)
      </a>
    </li>
    <li>
      <a href="/field-of-dreams-is-25-years-old-and-hasn-t-aged-well/">
        startupmyths (1)
      </a>
    </li>
    <li>
      <a href="/slow-data-and-fast-sites/">
        static_sites (1)
      </a>
    </li>
    <li>
      <a href="/setting-up-testing/">
        testing (1)
      </a>
    </li>
    <li>
      <a href="/making-a-command-line-utility-with-gems-and-thor/">
        thor (1)
      </a>
    </li>
    <li>
      <a href="/tags/tools/">
        tools (5)
      </a>
    </li>
    <li>
      <a href="/tags/toys/">
        toys (2)
      </a>
    </li>
    
      </ul>
    </li>
    <li class="dropdown">
      <a href="#" class="dropdown-toggle" data-toggle="dropdown">Archives <b class="caret"></b></a>
      <ul class="dropdown-menu">
        <li>
      <a href="/slow-data-and-fast-sites/">
        May 2015 (1)
      </a>
    </li>
    <li>
      <a href="/why-engineers-build-crappy-products/">
        Feb 2015 (1)
      </a>
    </li>
    <li>
      <a href="/2015/01/">
        Jan 2015 (2)
      </a>
    </li>
    <li>
      <a href="/2014/12/">
        Dec 2014 (5)
      </a>
    </li>
    <li>
      <a href="/2014/11/">
        Nov 2014 (10)
      </a>
    </li>
    <li>
      <a href="/how-to-track-your-coworkers/">
        Oct 2014 (1)
      </a>
    </li>
    
      </ul>
    </li>
    
    </ul>
    
    </div>
    
    </div>
    </nav>
    <div class='article-header  '>
      <h1>Setting up Devise with Twitter and Facebook and other Omniauth schemes without email addresses</h1>
      <h2>Connect connect connect</h2>
      <div class='tags'>
        <div class='tag'><a class="btn btn-primary" href="/tags/happy_seed/">happy_seed</a></div>
        <div class='tag'><a class="btn btn-primary" href="/tags/howto/">howto</a></div>
        <div class='tag'><a class="btn btn-primary" href="/tags/oauth/">oauth</a></div>
        <div class='tag'><a class="btn btn-primary" href="/tags/rails/">rails</a></div>
        <div class='tag'><a class="btn btn-primary" href="/tags/ruby/">ruby</a></div>
      </div>
      <a href='#comment_shower' id='comment_shower_scroll'>
        <span class='disqus-comment-count' data-disqus-identifier='2015-01-16-setting-up-devise-with-twitter-and-facebook-and-other-omniauth-schemes-without-email-addresses.html'></span>
      </a>
    </div>
    <div class='content'>
      <div class='row'>
        <div class='sidebar'>
          <ul class='nav toc' data-offset-top='400' data-spy='affix'>
            <li><a href="#top">Setting up Devise with Twitter and Facebook and other Omniauth schemes without email addresses</a></li>
            <li><a href="#install-devise-and-omniauth">Install devise and omniauth</a></li>
            <li><a href="#make-sure-regular-login-in-works">Make sure regular login in works</a></li>
            <li><a href="#configure-omniauth">Configure Omniauth</a></li>
            <li><a href="#tell-devise-about-omniauthable">Tell Devise about omniauthable</a></li>
            <li><a href="#create-a-formuser-to-handle-validations">Create a FormUser to handle validations</a></li>
            <li><a href="#create-identity-model-to-store-access_keys-and-metadata">Create Identity model to store access_keys and metadata</a></li>
            <li><a href="#create-omniauthcallbackscontroller-to-pull-in-data">Create OmniauthCallbacksController to pull in data</a></li>
            <li><a href="#override-registrationscontroller-to-handle-adding-email-address-and-password">Override RegistrationsController to handle adding email address and password</a></li>
            <li><a href="#adding-methods-to-user-to-get-to-the-clients">Adding methods to User to get to the clients</a></li>
            <li><a href="#passing-dynamic-scopes-to-omniauth">Passing dynamic scopes to omniauth</a></li>
            <li><a href="#conclusion">Conclusion</a></li>
          </ul>
        </div>
        <div class='article' id='top'>
          <p>Adding social login to your sites really makes it easier to get users onboard.  Devise is great to help get an authentication system up and running, but there are a few tricky things to get right.  The first challenge is that you don&#39;t always get the user&#39;s email address when the first connect.  The second challenge is that we want to request the minimum permissions first so that the user is more likely to sign up, and gradually ask more as the time arises.</p>
          
          <p>This post is going to go through the strategy that <a href="http://seed.happyfuncorp.com">happy_seed</a> uses to support these use cases.  The easiest way to get started is to use seed to get things up and running, but we&#39;ll walk through how to do it all in detail below.</p>
          
          <h2 id="install-devise-and-omniauth">Install devise and omniauth</h2>
          
          <p>Let&#39;s install a few gems.  We&#39;ll go through how to install twitter, facebook, and google.</p>
          
          <p><code>Gemfile</code>:</p>
          
          <pre><code class="rb">gem &#39;devise&#39;, &#39;~&gt; 3.4&#39;&#x000A;gem &#39;omniauth&#39;&#x000A;gem &#39;omniauth-twitter&#39;&#x000A;gem &#39;omniauth-facebook&#39;&#x000A;gem &#39;omniauth-instagram&#39;&#x000A;gem &#39;twitter&#39;&#x000A;gem &#39;instagram&#39;&#x000A;gem &#39;omniauth-google-oauth2&#39;&#x000A;gem &#39;google-api-client&#39;, require: &#39;google/api_client&#39;&#x000A;</code></pre>
          
          <p>Now we need to run the <code>devise</code> generators.  I like to copy over the views so that I can fix them up to look like the rest of my app.  If you are using seed, these views will be generated with <code>HAML</code> and the <code>bootstrap helpers</code> gem.</p>
          
          <p>First install devise:</p>
          
          <pre><code class="sh">$ rails generate devise:install&#x000A;</code></pre>
          
          <p><code>devise:install</code> copies over <code>config/initializers/devise.rb</code> and a localized message file.  We will configure devise here.  <em>Follow the outputed instuctions to setup flashes and mailer configs.</em></p>
          
          <p>Now create a model, call it user:</p>
          
          <pre><code class="sh">$ rails generate devise User&#x000A;</code></pre>
          
          <p>This creates a <code>User</code> model and configures devise routes to use it.  We will edit both of these.</p>
          
          <p>Finally, copy over the views so you can style them as you need:</p>
          
          <pre><code class="sh">$ rails generate devise:views&#x000A;</code></pre>
          
          <h2 id="make-sure-regular-login-in-works">Make sure regular login in works</h2>
          
          <p>Lets create a basic controller to see if our login works:</p>
          
          <pre><code class="sh">$ rails g controller welcome index&#x000A;$ rake db:migrate&#x000A;$ rails s&#x000A;</code></pre>
          
          <p>Edit <code>routes.rb</code>:</p>
          
          <pre><code class="rb">  get &#39;welcome/index&#39;&#x000A;  root &#39;welcome#index&#39;&#x000A;</code></pre>
          
          <p>And change your <code>WeclomeController</code> to require user authentication:</p>
          
          <pre><code class="rb">class WelcomeController&#x000A;  before_action :authenticate_user!&#x000A;&#x000A;  def index&#x000A;  end&#x000A;end&#x000A;</code></pre>
          
          <p>Now if you go to <a href="http://localhost:3000/">http://localhost:3000/</a> you should get redirected to a login page.  If you create a user you should be able to then see the protected page.</p>
          
          <p>Let&#39;s add a logout button to the index page for testing: <code>app/views/welcome/index.html.erb</code>:</p>
          
          <pre><code class="erb">&lt;%= link_to &quot;Signout&quot;, destroy_user_session_path, method: :delete %&gt;&#x000A;</code></pre>
          
          <p>Now we can go back and forth.  The <code>method: :delete</code> part is something that I often forget about.</p>
          
          <h2 id="configure-omniauth">Configure Omniauth</h2>
          
          <p>We need to tell devise and omniauth how to talk to the various outside services.  The first thing you&#39;ll need to do is configure those services and collect their app ids and app secrets.  Then you put that information inside of <code>config/initializers/devise.rb</code>:</p>
          
          <pre><code class="rb">    config.omniauth :google_oauth2, ENV[&#39;GOOGLE_OAUTH2_APP_ID&#39;], ENV[&#39;GOOGLE_OAUTH2_APP_SECRET&#39;], scope: &quot;email,profile,offline&quot;, prompt: &quot;consent&quot;&#x000A;    config.omniauth :instagram, ENV[&#39;INSTAGRAM_APP_ID&#39;], ENV[&#39;INSTAGRAM_APP_SECRET&#39;]&#x000A;    config.omniauth :facebook, ENV[&#39;FACEBOOK_APP_ID&#39;], ENV[&#39;FACEBOOK_APP_SECRET&#39;], scope: &quot;email&quot;&#x000A;    config.omniauth :twitter, ENV[&#39;TWITTER_APP_ID&#39;], ENV[&#39;TWITTER_APP_SECRET&#39;]&#x000A;</code></pre>
          
          <p>Since we are building nice <a href="http://12factor.net">12 Factor Apps</a> we pull the config from the environment.  seed uses the <a href="https://github.com/bkeepers/dotenv">dotenv gem</a> to keep track of these things in a <code>.env</code> file, and when you deploy to heroku you will use heroku config variables.</p>
          
          <p>We also pass in <code>scope</code>s to a few strategies, which is where we can configure omniauth to request specific permissions.  Sometimes you need to enable them on the remote side before you can request things (<em>e.g.</em> google, twitter) so make sure that things are setup there.</p>
          
          <p>We&#39;ll go into how to dynamically set that scope later on.</p>
          
          <h2 id="tell-devise-about-omniauthable">Tell Devise about omniauthable</h2>
          
          <p>Open up <code>app/models/user.rb</code> and add <code>:omniauthable</code> to your <code>devise</code> line and remove <code>:validatable</code>:</p>
          
          <pre><code class="rb">  devise :omniauthable, :database_authenticatable, :registerable,&#x000A;         :recoverable, :rememberable, :trackable&#x000A;</code></pre>
          
          <p>Now you should see that there are a list of connect with our services when you go to your sign in or login pages.</p>
          
          <h2 id="create-a-formuser-to-handle-validations">Create a FormUser to handle validations</h2>
          
          <p>Not all services return email addresses, and by default the devise validations expect them.  Let&#39;s move those validations out of the base <code>User</code> class into a <code>FormUser</code> class.</p>
          
          <ol>
          <li>Remove <code>:validatable</code> from <code>app/models/user.rb</code> (which you&#39;ve done above)</li>
          <li>Tell devise to use our new model.</li>
          <li>Create the forms_user.rb class.</li>
          </ol>
          
          <p>Inside of <code>config/routes.rb</code>:</p>
          
          <pre><code class="rb">devise_for :users, class_name: &#39;FormUser&#39;&#x000A;</code></pre>
          
          <p>And <code>app/models/form_user.rb</code> should look like:</p>
          
          <pre><code class="rb">class FormUser &lt; User&#x000A;  attr_accessor :current_password&#x000A;&#x000A;  validates_presence_of   :email, if: :email_required?&#x000A;  validates_uniqueness_of :email, allow_blank: true, if: :email_changed?&#x000A;  validates_format_of     :email, with: Devise.email_regexp, allow_blank: true, if: :email_changed?&#x000A;&#x000A;  validates_presence_of     :password, if: :password_required?&#x000A;  validates_confirmation_of :password, if: :password_required?&#x000A;  validates_length_of       :password, within: Devise.password_length, allow_blank: true&#x000A;&#x000A;  def password_required?&#x000A;    return false if email.blank?&#x000A;    !persisted? || !password.nil? || !password_confirmation.nil?&#x000A;  end&#x000A;&#x000A;  def email_required?&#x000A;    true&#x000A;  end&#x000A;end&#x000A;</code></pre>
          
          <p>The <code>class_name</code> inside of the devise config will tell it to use this class for building forms, and we have the validations on this class so our error messages will work on the site, but we&#39;ll be able to save objects without it.</p>
          
          <h2 id="create-identity-model-to-store-access_keys-and-metadata">Create Identity model to store access_keys and metadata</h2>
          
          <p>Now we are ready to plug in oauth authentications.  The flow is:</p>
          
          <ol>
          <li>User requests <code>/users/auth/:provider</code>, where provider one of the strategies that you defined above.</li>
          <li>Omniauth does magic and directs the user to the remote service.</li>
          <li>The user grants us access and is redirected to the callback path.</li>
          <li>The OmniauthCallbacks controller is called on our application with the relavent info.</li>
          </ol>
          
          <p>We will use this info to create the user.  We are also going to store it to be able to access the service on behalf of the user, and we&#39;ll need to store the <code>access_token</code> in order to do so.</p>
          
          <p>Google is slightly more complicated and we&#39;ll need to store a <code>refresh_token</code> as well.</p>
          
          <p>Lets create that model now:</p>
          
          <pre><code class="sh">$ rails model identity user:references provider:string accesstoken:string refreshtoken:string uid:string name:string email:string nickname:string image:string phone:string urls:string&#x000A;</code></pre>
          
          <p>And flesh out <code>app/models/identity.rb</code></p>
          
          <pre><code class="rb">class Identity &lt; ActiveRecord::Base&#x000A;  belongs_to :user&#x000A;  validates_presence_of :uid, :provider&#x000A;  validates_uniqueness_of :uid, :scope =&gt; :provider&#x000A;&#x000A;  def self.find_for_oauth(auth)&#x000A;    identity = find_by(provider: auth.provider, uid: auth.uid)&#x000A;    identity = create(uid: auth.uid, provider: auth.provider) if identity.nil?&#x000A;    identity.accesstoken = auth.credentials.token&#x000A;    identity.refreshtoken = auth.credentials.refresh_token&#x000A;    identity.name = auth.info.name&#x000A;    identity.email = auth.info.email&#x000A;    identity.nickname = auth.info.nickname&#x000A;    identity.image = auth.info.image&#x000A;    identity.phone = auth.info.phone&#x000A;    identity.urls = (auth.info.urls || &quot;&quot;).to_json&#x000A;    identity.save&#x000A;    identity&#x000A;  end&#x000A;end&#x000A;</code></pre>
          
          <p>Now we need to tell devise to use this model.</p>
          
          <h2 id="create-omniauthcallbackscontroller-to-pull-in-data">Create OmniauthCallbacksController to pull in data</h2>
          
          <p>We&#39;re going to build one method to handle the different authentication callbacks, called <code>generic_callback</code>.  The logic of this controller is:</p>
          
          <ol>
          <li>Find or create an <code>Identity</code> object for the incoming oauth data.  Update it with the latest info.</li>
          <li>If there is no user associated with the Identity, associate it with the current_user.</li>
          <li>If there is no current_user, create a new User object.</li>
          <li>If the User object doesn&#39;t have an email address set yet, but we do have one from the remote service, set the email address to that.</li>
          <li>Log the user in and let the continue on their way.</li>
          </ol>
          
          <p>First we need to tell devise about our controller in <code>routes.rb</code></p>
          
          <pre><code class="rb">devise_for :users, class_name: &#39;FormUser&#39;, :controllers =&gt; { omniauth_callbacks: &#39;omniauth_callbacks&#39; }&#x000A;</code></pre>
          
          <p>Create <code>app/controllers/omniauth_callback_controller.rb</code>:</p>
          
          <pre><code class="rb">class OmniauthCallbacksController &lt; Devise::OmniauthCallbacksController&#x000A;  def instagram&#x000A;    generic_callback( &#39;instagram&#39; )&#x000A;  end&#x000A;&#x000A;  def facebook&#x000A;    generic_callback( &#39;facebook&#39; )&#x000A;  end&#x000A;&#x000A;  def twitter&#x000A;    generic_callback( &#39;twitter&#39; )&#x000A;  end&#x000A;&#x000A;  def google_oauth2&#x000A;    generic_callback( &#39;google_oauth2&#39; )&#x000A;  end&#x000A;&#x000A;  def generic_callback( provider )&#x000A;    @identity = Identity.find_for_oauth env[&quot;omniauth.auth&quot;]&#x000A;&#x000A;    @user = @identity.user || current_user&#x000A;    if @user.nil?&#x000A;      @user = User.create( email: @identity.email || &quot;&quot; )&#x000A;      @identity.update_attribute( :user_id, @user.id )&#x000A;    end&#x000A;&#x000A;    if @user.email.blank? &amp;&amp; @identity.email&#x000A;      @user.update_attribute( :email, @identity.email)&#x000A;    end&#x000A;&#x000A;    if @user.persisted?&#x000A;      @identity.update_attribute( :user_id, @user.id )&#x000A;      # This is because we&#39;ve created the user manually, and Device expects a&#x000A;      # FormUser class (with the validations)&#x000A;      @user = FormUser.find @user.id&#x000A;      sign_in_and_redirect @user, event: :authentication&#x000A;      set_flash_message(:notice, :success, kind: provider.capitalize) if is_navigational_format?&#x000A;    else&#x000A;      session[&quot;devise.#{provider}_data&quot;] = env[&quot;omniauth.auth&quot;]&#x000A;      redirect_to new_user_registration_url&#x000A;    end&#x000A;  end&#x000A;end&#x000A;</code></pre>
          
          <h2 id="override-registrationscontroller-to-handle-adding-email-address-and-password">Override RegistrationsController to handle adding email address and password</h2>
          
          <p>We want to let the user add an email address if they haven&#39;t already, and also let them set a password if they haven&#39;t already set one.  (Otherwise it requires the user to enter in <code>current_password</code>.)  Lets first tell devise about our new controller:</p>
          
          <pre><code class="rb">devise_for :users, class_name: &#39;FormUser&#39;, :controllers =&gt; { omniauth_callbacks: &#39;omniauth_callbacks&#39;, registrations: &#39;registrations&#39;}&#x000A;</code></pre>
          
          <p>And then create that controller:</p>
          
          <pre><code class="rb">class RegistrationsController &lt; Devise::RegistrationsController&#x000A;  def update_resource(resource, params)&#x000A;    if resource.encrypted_password.blank? # || params[:password].blank?&#x000A;      resource.email = params[:email] if params[:email]&#x000A;      if !params[:password].blank? &amp;&amp; params[:password] == params[:password_confirmation]&#x000A;        logger.info &quot;Updating password&quot;&#x000A;        resource.password = params[:password]&#x000A;        resource.save&#x000A;      end&#x000A;      if resource.valid?&#x000A;        resource.update_without_password(params)&#x000A;      end&#x000A;    else&#x000A;      resource.update_with_password(params)&#x000A;    end&#x000A;  end&#x000A;end&#x000A;</code></pre>
          
          <p>And now we should be good!  Give it a go and see how it looks!</p>
          
          <h2 id="adding-methods-to-user-to-get-to-the-clients">Adding methods to User to get to the clients</h2>
          
          <p>This goes into <code>app/models/users.rb</code>:</p>
          
          <pre><code class="rb">  has_many :identities&#x000A;&#x000A;  def twitter&#x000A;    identities.where( :provider =&gt; &quot;twitter&quot; ).first&#x000A;  end&#x000A;&#x000A;  def twitter_client&#x000A;    @twitter_client ||= Twitter.client( access_token: twitter.accesstoken )&#x000A;  end&#x000A;&#x000A;  def facebook&#x000A;    identities.where( :provider =&gt; &quot;facebook&quot; ).first&#x000A;  end&#x000A;&#x000A;  def facebook_client&#x000A;    @facebook_client ||= Facebook.client( access_token: facebook.accesstoken )&#x000A;  end&#x000A;&#x000A;  def instagram&#x000A;    identities.where( :provider =&gt; &quot;instagram&quot; ).first&#x000A;  end&#x000A;&#x000A;  def instagram_client&#x000A;    @instagram_client ||= Instagram.client( access_token: instagram.accesstoken )&#x000A;  end&#x000A;&#x000A;  def google_oauth2&#x000A;    identities.where( :provider =&gt; &quot;google_oauth2&quot; ).first&#x000A;  end&#x000A;&#x000A;  def google_oauth2_client&#x000A;    if !@google_oauth2_client&#x000A;      @google_oauth2_client = Google::APIClient.new(:application_name =&gt; &#39;HappySeed App&#39;, :application_version =&gt; &quot;1.0.0&quot; )&#x000A;      @google_oauth2_client.authorization.update_token!({:access_token =&gt; google_oauth2.accesstoken, :refresh_token =&gt; google_oauth2.refreshtoken})&#x000A;    end&#x000A;    @google_oauth2_client&#x000A;  end&#x000A;</code></pre>
          
          <p>Now you can access a configured API client using things like <code>current_user.twitter</code>.</p>
          
          <h2 id="passing-dynamic-scopes-to-omniauth">Passing dynamic scopes to omniauth</h2>
          
          <p>In the current scheme above, you have to hard code the scopes that you want to request for the user which doesn&#39;t always work.  It would be better to only request write access if the user really needs to have it, and by default only get read-only access.  In order to do this we can leverage the <code>Omniauth</code> setup property.  Inside of <code>devise.rb</code> add <code>setup: true</code> to each of the services you want to be able to upgrade.</p>
          
          <pre><code class="rb">    config.omniauth :google_oauth2, ENV[&#39;GOOGLE_OAUTH2_APP_ID&#39;], ENV[&#39;GOOGLE_OAUTH2_APP_SECRET&#39;], scope: &quot;email,profile,offline&quot;, prompt: &quot;consent&quot;, setup: true&#x000A;    config.omniauth :instagram, ENV[&#39;INSTAGRAM_APP_ID&#39;], ENV[&#39;INSTAGRAM_APP_SECRET&#39;], setup: true&#x000A;    config.omniauth :facebook, ENV[&#39;FACEBOOK_APP_ID&#39;], ENV[&#39;FACEBOOK_APP_SECRET&#39;], scope: &quot;email&quot;, setup: true&#x000A;    config.omniauth :twitter, ENV[&#39;TWITTER_APP_ID&#39;], ENV[&#39;TWITTER_APP_SECRET&#39;], setup: true&#x000A;</code></pre>
          
          <p>Let&#39;s add a few routes in <code>routes.rb</code> that we can have the user link to:</p>
          
          <pre><code class="rb">  devise_scope :user do&#x000A;    get &#39;/users/auth/:provider/upgrade&#39; =&gt; &#39;omniauth_callbacks#upgrade&#39;, as: :user_omniauth_upgrade&#x000A;    get &#39;/users/auth/:provider/setup&#39;, :to =&gt; &#39;omniauth_callbacks#setup&#39;&#x000A;  end&#x000A;</code></pre>
          
          <p>The first route is something that we&#39;ll have the user link to, using <code>user_omniauth_upgrade_path( :google_oauth2 )</code> for example.  The second <code>setup</code> route is what omniauth will call internally that we can use to change the <code>scope</code> parameter.  These go into <code>omniauth_callbacks_controller.rb</code>.</p>
          
          <p>The first <code>upgrade</code> method looks at the provider and sets a <code>flash</code> variable for the additional access.  In this case, we are asking for the <code>https://www.googleapis.com/auth/admin.directory.user</code> also.</p>
          
          <pre><code>  def upgrade&#x000A;    scope = nil&#x000A;    if params[:provider] == &quot;google_oauth2&quot;&#x000A;      scope = &quot;email,profile,offline,https://www.googleapis.com/auth/admin.directory.user&quot;&#x000A;    end&#x000A;&#x000A;    redirect_to user_omniauth_authorize_path( params[:provider] ), flash: { scope: scope }&#x000A;  end&#x000A;</code></pre>
          
          <p>Then it directs the user back to the normal flow.</p>
          
          <p>When you specify <code>setup: true</code> inside of the omniauth configuration, there is magic that calls the <code>setup_path</code> by default, and this is the method where we change the scope from the default in the strategy:</p>
          
          <pre><code class="rb">  def setup&#x000A;    request.env[&#39;omniauth.strategy&#39;].options[&#39;scope&#39;] = flash[:scope] || request.env[&#39;omniauth.strategy&#39;].options[&#39;scope&#39;]&#x000A;    render :text =&gt; &quot;Setup complete.&quot;, :status =&gt; 404&#x000A;  end&#x000A;</code></pre>
          
          <p>Now in your views, you can do</p>
          
          <pre><code class="erb">&lt;%= link_to &quot;Upgrade Access&quot;, user_omniauth_upgrade_path( :google_oauth2 ) %&gt;&#x000A;</code></pre>
          
          <p>And the user will go through the oauth flow again requesting the additional access.</p>
          
          <h2 id="conclusion">Conclusion</h2>
          
          <p>Making all of this work is possible, but there are a lot of fiddly little bits to make it work.  Both devise and all of the many omniauth strategies out there make it easy to add this functionality to your application.</p>
          
          <p>Check out <a href="http://seed.happyfuncorp.com">seed</a> to quickly create an application will all of this stuff done for you!</p>
        </div>
        <div class='navigation' data-offset-top='400' data-spy='affix'>
          <div class='next'>
            <p>
              Next in
              <a href="/tag/Chronological.html">Chronological</a>
              <a href="/tag/Rails.html">Rails</a>
              <a href="/tag/Happy_seed.html">Happy_seed</a>
              <a href="/tag/Ruby.html">Ruby</a>
            </p>
            <p class='title'><a href="/setting-up-testing/">Setting up Rails testing with rspec, devise, and the gang</a></p>
            <p>
              Next in
              <a href="/tag/Howto.html">Howto</a>
            </p>
            <p class='title'><a href="/slow-data-and-fast-sites/">Slow data and Fast Sites</a></p>
          </div>
          <div class='prev'>
            <p>
              Previously in
              <a href="/tag/Chronological.html">Chronological</a>
              <a href="/tag/Howto.html">Howto</a>
              <a href="/tag/Ruby.html">Ruby</a>
            </p>
            <p class='title'><a href="/using-rake-for-dataflow-programming-and-data-science/">Using rake for dataflow programming and data science</a></p>
            <p>
              Previously in
              <a href="/tag/Rails.html">Rails</a>
            </p>
            <p class='title'><a href="/dateslice-writing-rails-extensions/">Dateslice: Writing rails extensions</a></p>
            <p>
              Previously in
              <a href="/tag/Happy_seed.html">Happy_seed</a>
            </p>
            <p class='title'><a href="/new-happyseed-released/">New HappySeed released</a></p>
          </div>
        </div>
      </div>
      <div class="row article_footer">
        <div class="comments">
            <a href="#" id="comment_shower">
              <span class="socicon socicon-disqus fgcolor"></span>
              <span class="disqus-comment-count" data-disqus-identifier="2015-01-16-setting-up-devise-with-twitter-and-facebook-and-other-omniauth-schemes-without-email-addresses.html">Be the first to comment.</span>
            </a>
        </div>
        <div class="sharing">
          <a href="http://www.twitter.com/share?url=http://willschenk.com//setting-up-devise-with-twitter-and-facebook-and-other-omniauth-schemes-without-email-addresses/&amp;text=Setting up Devise with Twitter and Facebook and other Omniauth schemes without email addresses by @wschenk" title="Share this post on Twitter" data-lang="en" onclick="return !window.open(this.href, 'Twitter', 'width=640,height=300')"><span class="socicon socicon-twitter fgcolor"></span></a>
      
          <a target="_blank" onclick="return !window.open(this.href, 'Facebook', 'width=640,height=300')" href="http://www.facebook.com/sharer/sharer.php?u=http://willschenk.com//setting-up-devise-with-twitter-and-facebook-and-other-omniauth-schemes-without-email-addresses/" title="Share this post on Facebook"><span class="socicon socicon-facebook fgcolor"></span></a>
      
          <a href="http://plus.google.com/share?url=http://willschenk.com//setting-up-devise-with-twitter-and-facebook-and-other-omniauth-schemes-without-email-addresses/" target="_blank" onclick="return !window.open(this.href, 'Google +', 'width=640,height=300')" title="Share this post on Google +"><span class="socicon socicon-google fgcolor"></span></a>
        </div>
      </div>
        <div class="comment_row">
          <div class="comment_universe">
            <div id="disqus_thread" class="col-sm-10 col-sm-offset-1"></div>
          </div>
        </div>
    </div>
    <footer class='academy'>
      <div class='container'>
        <div class='row'>
          <div class='logo'>
            <a href='http://academy.happyfuncorp.com/'>
              <img class="img-responsive" src="../images/academy-logo-f112afa1.png" />
            </a>
          </div>
          <div class='body'>
            <h1>Come join us in person!</h1>
            <p>HFC Technology Academy is dedicated to teaching people the skills they need to succeed in the world of technology and startups.</p>
            <p>The Academy is for anyone with the passion to learn about entrepreneurship, development, product management and other skills within the start-up community.</p>
            <h2><a href="http://academy.happyfuncorp.com/">Read about our free events</a></h2>
          </div>
        </div>
      </div>
    </footer>
    <footer class='footer  '>
      <div class='container'>
        <div class='row'>
          <div class='social'>
            <span>
              <a class='webicon twitter' href='http://twitter.com/wschenk'></a>
            </span>
            <span>
              <a class='webicon tumblr' href='http://sublimeguile.com/'></a>
            </span>
            <span>
              <a class='webicon instagram' href='http://instagram.com/wschenk'></a>
            </span>
            <span>
              <a class='webicon linkedin' href='http://www.linkedin.com/pub/will-schenk/0/266/420/'></a>
            </span>
            <span>
              <a class='webicon github' href='https://github.com/wschenk'></a>
            </span>
            <span>
              <a class='webicon rss' href='http://willschenk.com/feed.xml'></a>
            </span>
            <span>
              <a class='webicon mail' href='mailto:will@happyfuncorp.com'></a>
            </span>
          </div>
          <div class='made_in_bk'>
            <h3>Made in Brooklyn, NY</h3>
          </div>
        </div>
      </div>
    </footer>
    <script src="../javascripts/application-87c4840f.js" type="text/javascript"></script><script src="../javascripts/modernizr-84a49412.js" type="text/javascript"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.3/highlight.min.js"></script>
    <script type="text/javascript">
      var _gaq=[['_setAccount','UA-56296045-1'],['_trackPageview']];
      (function(d,t){var g=d.createElement(t),s=d.getElementsByTagName(t)[0];
      g.src=('https:'==location.protocol?'//ssl':'//www')+'.google-analytics.com/ga.js';
      s.parentNode.insertBefore(g,s)}(document,'script'));
    </script>
    
    <script type="text/javascript">
      hljs.initHighlightingOnLoad();
      $(".article img").addClass( "img-responsive");
      $("iframe").map( function(e) {
        $(this).css( "max-width", $(this).width() );
        $(this).width( "100%" );
      });
      var _gaq=[['_setAccount','UA-56296045-1'],['_trackPageview']];
      (function(d,t){var g=d.createElement(t),s=d.getElementsByTagName(t)[0];
      g.src=('https:'==location.protocol?'//ssl':'//www')+'.google-analytics.com/ga.js';
      s.parentNode.insertBefore(g,s)}(document,'script'));
      var disqus_shortname = 'willschenk';
        var disqus_identifier = '2015-01-16-setting-up-devise-with-twitter-and-facebook-and-other-omniauth-schemes-without-email-addresses.html';
            
      (function() {
          var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
          dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
          (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      })();
      (function () {
    var s = document.createElement('script'); s.async = true;
    s.type = 'text/javascript';
    s.src = 'http://' + disqus_shortname + '.disqus.com/count.js';
    (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
    </script>
  </body>
</html>
