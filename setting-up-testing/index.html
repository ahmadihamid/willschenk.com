<!DOCTYPE html>
<html class='no-js'>
  <head>
    <meta charset='utf-8'>
    <meta content='IE=edge,chrome=1' http-equiv='X-UA-Compatible'>
    <title>Setting up Rails testing with rspec, devise, and the gang | Blank Page Tech</title>
    <meta name="site" content="Blank Page Tech" />
    <meta name="og:site_name" content="Blank Page Tech" />
    <meta name="title" content="Setting up Rails testing with rspec, devise, and the gang" />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="Setting up Rails testing with rspec, devise, and the gang" />
    <meta name="twitter:site" content="@wschenk" />
    <meta name="og:title" content="Setting up Rails testing with rspec, devise, and the gang" />
    <meta content='width=device-width' name='viewport'>
    <link href="../stylesheets/application-c2e1d785.css" rel="stylesheet" type="text/css" /><link href="../stylesheets/webicons-da5ecace.css" rel="stylesheet" type="text/css" /><link href="../stylesheets/googlecode-d3629bf4.css" rel="stylesheet" type="text/css" />
    <link href='//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.3/styles/default.min.css' rel='stylesheet'>
    <link rel="alternate" type="application/atom+xml" title="Atom Feed" href="/feed.xml" />
  </head>
  <body data-spy='scroll' data-target='.sidebar'>
    <nav class="navbar navbar-default navbar-fixed-top" role="navigation">
      <div class="container">
      <div class='visible-xs-block'>
      <div class="navbar-header">
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar-collapsable">
          <span class="sr-only">Toggle navigation</span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a href="/" class="navbar-brand">
        Blank Page Tech
      </a>
        
      </div>
    </div>
    <div class='hidden-xs'>
      <div class="navbar-header">
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar-collapsable">
          <span class="sr-only">Toggle navigation</span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a href="/" class="navbar-brand">
        Technology for the blank page
      </a>
        
      </div>
    </div>
    <div class="collapse navbar-collapse" id="navbar-collapsable">
      <ul class="nav navbar-nav navbar-right foo" id="menu">
      <li>
      <a href="/articles/">
        Articles
      </a>
    </li>
    <li class="dropdown">
      <a href="#" class="dropdown-toggle" data-toggle="dropdown">Topics <b class="caret"></b></a>
      <ul class="dropdown-menu">
        <li>
      <a href="/tags/howto/">
        Howtos
      </a>
    </li>
    <li>
      <a href="/tags/overview/">
        Overviews
      </a>
    </li>
    <li>
      <a href="/tags/product/">
        Product
      </a>
    </li>
    <li>
      <a href="/tags/tools/">
        Tools
      </a>
    </li>
    <li>
      <a href="/tags/socialinvestigator/">
        Social Investigator
      </a>
    </li>
    <li>
      <a href="/tags/ruby/">
        Ruby & Rails
      </a>
    </li>
    
      </ul>
    </li>
    <li class="dropdown">
      <a href="#" class="dropdown-toggle" data-toggle="dropdown">Tags <b class="caret"></b></a>
      <ul class="dropdown-menu">
        <li>
      <a href="/bootstrap-advanced-grid-tricks/">
        bootstrap (1)
      </a>
    </li>
    <li>
      <a href="/tags/bots/">
        bots (2)
      </a>
    </li>
    <li>
      <a href="/using-rake-for-dataflow-programming-and-data-science/">
        data (1)
      </a>
    </li>
    <li>
      <a href="/osx-script-for-kiosk-mode/">
        gaze (1)
      </a>
    </li>
    <li>
      <a href="/using-seed-to-explore/">
        github (1)
      </a>
    </li>
    <li>
      <a href="/pulling-data-out-of-google-analytics/">
        googleanalytics (1)
      </a>
    </li>
    <li>
      <a href="/tags/happy_seed/">
        happy_seed (4)
      </a>
    </li>
    <li>
      <a href="/tags/howto/">
        howto (17)
      </a>
    </li>
    <li>
      <a href="/bower-with-rails/">
        javascript (1)
      </a>
    </li>
    <li>
      <a href="/tags/middleman/">
        middleman (6)
      </a>
    </li>
    <li>
      <a href="/setting-up-devise-with-twitter-and-facebook-and-other-omniauth-schemes-without-email-addresses/">
        oauth (1)
      </a>
    </li>
    <li>
      <a href="/tags/osx/">
        osx (2)
      </a>
    </li>
    <li>
      <a href="/tags/overview/">
        overview (4)
      </a>
    </li>
    <li>
      <a href="/tags/product/">
        product (2)
      </a>
    </li>
    <li>
      <a href="/tags/rails/">
        rails (5)
      </a>
    </li>
    <li>
      <a href="/tags/rake/">
        rake (2)
      </a>
    </li>
    <li>
      <a href="/building-a-gui-for-managing-middleman-blogs/">
        react (1)
      </a>
    </li>
    <li>
      <a href="/how-to-track-your-coworkers/">
        redis (1)
      </a>
    </li>
    <li>
      <a href="/tags/ruby/">
        ruby (16)
      </a>
    </li>
    <li>
      <a href="/receiving-posted-json-with-sinatra/">
        sinatra (1)
      </a>
    </li>
    <li>
      <a href="/tags/socialinvestigator/">
        socialinvestigator (4)
      </a>
    </li>
    <li>
      <a href="/dateslice-writing-rails-extensions/">
        sql (1)
      </a>
    </li>
    <li>
      <a href="/field-of-dreams-is-25-years-old-and-hasn-t-aged-well/">
        startupmyths (1)
      </a>
    </li>
    <li>
      <a href="/tags/static_sites/">
        static_sites (2)
      </a>
    </li>
    <li class="active">
      <a href="/setting-up-testing/">
        testing (1)
      </a>
    </li>
    <li>
      <a href="/making-a-command-line-utility-with-gems-and-thor/">
        thor (1)
      </a>
    </li>
    <li>
      <a href="/tags/tools/">
        tools (5)
      </a>
    </li>
    <li>
      <a href="/tags/toys/">
        toys (5)
      </a>
    </li>
    
      </ul>
    </li>
    <li class="dropdown">
      <a href="#" class="dropdown-toggle" data-toggle="dropdown">Archives <b class="caret"></b></a>
      <ul class="dropdown-menu">
        <li>
      <a href="/inflight-internet/">
        Dec 2015 (1)
      </a>
    </li>
    <li>
      <a href="/using-seed-to-explore/">
        Sep 2015 (1)
      </a>
    </li>
    <li>
      <a href="/2015/07/">
        Jul 2015 (3)
      </a>
    </li>
    <li>
      <a href="/adding-search-to-a-middleman-blog/">
        Jun 2015 (1)
      </a>
    </li>
    <li>
      <a href="/2015/05/">
        May 2015 (2)
      </a>
    </li>
    <li>
      <a href="/why-engineers-build-crappy-products/">
        Feb 2015 (1)
      </a>
    </li>
    <li>
      <a href="/2015/01/">
        Jan 2015 (2)
      </a>
    </li>
    <li>
      <a href="/2014/12/">
        Dec 2014 (5)
      </a>
    </li>
    <li>
      <a href="/2014/11/">
        Nov 2014 (10)
      </a>
    </li>
    <li>
      <a href="/how-to-track-your-coworkers/">
        Oct 2014 (1)
      </a>
    </li>
    
      </ul>
    </li>
    
    </ul>
    <form class='navbar-form navbar-right' id='search' role='search'>
      <div class='form-group dropdown'>
        <div class='input-group'>
          <input autocomplete='off' class='form-control' id='search_box' placeholder='Search' type='text'>
          <span class='input-group-btn'>
            <button class='btn btn-default'>
              <span class='glyphicon glyphicon-search'></span>
            </button>
          </span>
        </div>
        <ul class='dropdown-menu dropdown-menu-left results'>
          <a href="/url">Title</a>
        </ul>
      </div>
    </form>
    
    </div>
    
    </div>
    </nav>
    <div class='article-header  '>
      <h1>Setting up Rails testing with rspec, devise, and the gang</h1>
      <h2>so much fun</h2>
      <div class='tags'>
        <div class='tag'><a class="btn btn-primary" href="/tags/happy_seed/">happy_seed</a></div>
        <div class='tag'><a class="btn btn-primary" href="/tags/rails/">rails</a></div>
        <div class='tag'><a class="btn btn-primary" href="/tags/ruby/">ruby</a></div>
        <div class='tag'><a class="btn btn-primary" href="/tags/testing/">testing</a></div>
      </div>
      <a href='#comment_shower' id='comment_shower_scroll'>
        <span class='disqus-comment-count' data-disqus-identifier='2015-01-23-setting-up-testing.html'></span>
      </a>
    </div>
    <div class='content'>
      <div class='row'>
        <div class='sidebar'>
          <ul class='nav toc' data-offset-top='400' data-spy='affix'>
            <li><a href="#top">Setting up Rails testing with rspec, devise, and the gang</a></li>
            <li><a href="#install-rspec-factorygirl-capybara-and-guard">Install RSpec, FactoryGirl, Capybara, and Guard</a></li>
            <li><a href="#base-configuration-of-rspec-and-guard">Base configuration of rspec and guard</a></li>
            <li><a href="#add-login-support-and-factory-girl-to-spec_helper">Add login support and factory girl to spec_helper</a></li>
            <li><a href="#example-controller-spec">Example controller spec</a></li>
            <li><a href="#example-rspec-feature">Example rspec feature</a></li>
            <li><a href="#setting-up-webmock-and-vcr">Setting up webmock and VCR</a></li>
            <li><a href="#example-usage-of-webmock-and-vcr">Example usage of webmock and VCR</a></li>
            <li><a href="#final-notes">Final notes</a></li>
          </ul>
        </div>
        <div class='article' id='top'>
          <p>The goal is to get features out fast, and interate on them quickly.  Does anyone care about it?  What do they care about?  How do we make it better?</p>
          
          <p>As projects get bigger, both in terms of people using the site as well as people <em>working</em> on the site, testing and quality become relatively more important.  Adding tests introduces drag, and the theory is that you invest now for payoffs later.  What&#39;s the least amount of drag we can add to the process to get us in a good place for when it will start to pay off?</p>
          
          <p>RSpec feature specs lets developers create testing click paths through the application, looking at the flow though the app.  It doesn&#39;t focus enough on the design details, and going through a test driving development process with this way will end up with sites &#39;working&#39; using only an engineer&#39;s defination, so as a MVP implementor you&#39;ll need to find a way to resist the temptation, no matter how nifty the backend flow state is.</p>
          
          <p>This article will go through how the testing environment is set up on <a href="http://seed.happyfuncorp.com">HappySeed</a> where we focus mainly on RSpec feature specs.  Seed does this all automatically, but its nice to have it written down in a one place so we all know what&#39;s going on.  Let&#39;s get into it.</p>
          
          <h2 id="install-rspec,-factorygirl,-capybara,-and-guard">Install RSpec, FactoryGirl, Capybara, and Guard</h2>
          
          <p>Lets fire up a new rails app, and pass the <code>-T</code> option to not include TestUnit.</p>
          
          <pre><code class="sh">$ rails new test_app -T&#x000A;</code></pre>
          
          <p>Now add some gems to the <code>Gemfile</code>.</p>
          
          <pre><code class="rb">group :development, :test do&#x000A;  gem &#39;rspec-rails&#39;&#x000A;  gem &#39;factory_girl_rails&#39;&#x000A;  gem &#39;capybara&#39;&#x000A;  gem &#39;guard-rspec&#39;&#x000A;  gem &#39;spring-commands-rspec&#39;&#x000A;  gem &#39;vcr&#39;&#x000A;end&#x000A;&#x000A;group :test do&#x000A;  gem &#39;webmock&#39;&#x000A;end&#x000A;</code></pre>
          
          <p>Lets go through this:</p>
          
          <ul>
          <li><a href="http://rspec.info"><code>rpsec</code></a> (implied as a dependancy) is the testing framework that we are going to use</li>
          <li><a href="https://github.com/thoughtbot/factory_girl"><code>factory_girl</code></a> (implied) lets us code smart database fixtures in ruby, in things called <em>factories</em></li>
          <li><a href="https://github.com/jnicklas/capybara"><code>capybara</code></a> lets helps you test web applications by simulating how a real user would interact with your app. </li>
          <li><a href="https://github.com/guard/guard"><code>guard</code></a> (implied) makes rerunning tests a snap, by watching the filesystem for when you save files and triggering events automatically</li>
          <li><a href="https://github.com/bblimke/webmock"><code>webmock</code></a> locks down your test environment from talking to the internet</li>
          <li><a href="https://github.com/vcr/vcr"><code>vcr</code></a> record your test suite&#39;s HTTP interactions and replay them during future test runs for fast, deterministic, accurate tests</li>
          <li><a href="https://github.com/rspec/rspec-rails"><code>rspec-rails</code></a> is the rails integration with rspec, which depends upon rspec itself.</li>
          <li><a href="https://github.com/thoughtbot/factory_girl_rails"><code>factory_girl_rails</code></a> is the rails integration with factory_girl.</li>
          <li><a href="https://github.com/guard/guard-rspec"><code>guard-rspec</code></a> is rspec integration with guard</li>
          <li><a href="https://github.com/jonleighton/spring-commands-rspec"><code>spring-commands-rspec</code></a> lets you integrate rspec with spring, which means that your tests will run much faster.</li>
          </ul>
          
          <p>If you are interested in using cucumber, see below for steps to integrate it.</p>
          
          <h2 id="base-configuration-of-rspec-and-guard">Base configuration of rspec and guard</h2>
          
          <p>Lets make sure that spring knows about rspec:</p>
          
          <pre><code class="sh">$ bundle install&#x000A;$ spring binstub --all&#x000A;* bin/rake: spring already present&#x000A;* bin/rspec: generated with spring&#x000A;* bin/rails: spring already present&#x000A;</code></pre>
          
          <p>This creates a <code>bin/rspec</code> command that lets us run our tests.  Lets create a Guardfile and then tell guard to use this command:</p>
          
          <pre><code class="sh">$ guard init&#x000A;</code></pre>
          
          <p>Then edit the newly generated <code>Guardfile</code> to use the spring version of the rspec runner.  I also like to run all of the tests when I start up guard, because the more the merrier.  In <code>Guardfile</code>, change the <code>guard :rspec</code> line to:</p>
          
          <pre><code class="rb">guard :rspec, cmd: &quot;bin/rspec&quot;, all_on_start: true do&#x000A;</code></pre>
          
          <p>Now we install the rspec files:</p>
          
          <pre><code class="sh">$ rails g rspec:install&#x000A;</code></pre>
          
          <p>This creates 3 files:</p>
          
          <pre><code class="sh">create  .rspec&#x000A;create  spec&#x000A;create  spec/spec_helper.rb&#x000A;create  spec/rails_helper.rb&#x000A;</code></pre>
          
          <p>I like to have the output in documentation format by default, so we can edit the <code>.rspec</code> file to be:</p>
          
          <pre><code class="rb">--color&#x000A;--require spec_helper&#x000A;--format documentation&#x000A;</code></pre>
          
          <h2 id="add-login-support-and-factory-girl-to-spec_helper">Add login support and factory girl to spec_helper</h2>
          
          <p>Getting feature and controller specs to work with authentication is a bit tricky.  We&#39;re going to assume that you use <a href="/setting-up-devise-with-twitter-and-facebook-and-other-omniauth-schemes-without-email-addresses/">devise for authentication</a>, but this should support anything that uses <a href="https://github.com/hassox/warden">warden</a>:</p>
          
          <p>Add devise to <code>Gemfile</code>:</p>
          
          <pre><code class="rb">gem &#39;devise&#39;&#x000A;</code></pre>
          
          <p>Create <code>spec/support/controller_helpers.rb</code></p>
          
          <pre><code class="rb">module ControllerHelpers&#x000A;  def login_with(user = double(&#39;user&#39;), scope = :user)&#x000A;    current_user = &quot;current_#{scope}&quot;.to_sym&#x000A;    if user.nil?&#x000A;      allow(request.env[&#39;warden&#39;]).to receive(:authenticate!).and_throw(:warden, {:scope =&gt; scope})&#x000A;      allow(controller).to receive(current_user).and_return(nil)&#x000A;    else&#x000A;      allow(request.env[&#39;warden&#39;]).to receive(:authenticate!).and_return(user)&#x000A;      allow(controller).to receive(current_user).and_return(user)&#x000A;    end&#x000A;  end&#x000A;end&#x000A;</code></pre>
          
          <p>At the top of <code>spec_helper.rb</code> add:</p>
          
          <pre><code class="rb">require_relative &#39;support/controller_helpers&#39;&#x000A;require &#39;devise&#39;&#x000A;</code></pre>
          
          <p>and in the config block add:</p>
          
          <pre><code class="rb">  config.include ControllerHelpers, type: :controller&#x000A;  Warden.test_mode!&#x000A;&#x000A;  config.after do&#x000A;    Warden.test_reset!&#x000A;  end&#x000A;</code></pre>
          
          <p>Then edit <code>rails_helper.rb</code> and put the following in the config block:</p>
          
          <pre><code class="rb">  config.include FactoryGirl::Syntax::Methods&#x000A;  config.include Devise::TestHelpers, type: :controller&#x000A;  config.include Warden::Test::Helpers&#x000A;</code></pre>
          
          <p><strong>If you are getting uncaught throw :warden errors then make sure you have the right includes in the right config files!</strong></p>
          
          <p>This gives you a few things:</p>
          
          <ul>
          <li><code>FactoryGirl</code> syntax methods, which let you use things like <code>create( :user )</code> in your tests, which uses <code>FactoryGirl</code> to generate a database object.</li>
          <li>helper methods to <code>sign_in</code> a user for a specific scope.  This could be used as <code>sign_in create( :user )</code> at the beginning of your controller test methods, and <code>sign_in nil</code> to simulate an anonymous user.</li>
          </ul>
          
          <h2 id="example-controller-spec">Example controller spec</h2>
          
          <p>This example assumes that you&#39;ve already setup devise.  If not, you can get something up and running doing:</p>
          
          <pre><code>$ rails g devise:install &amp;&amp; rails g devise User &amp;&amp; rake db:migrate&#x000A;</code></pre>
          
          <p>(I go into slightly more detail in setting up <a href="/setting-up-devise-with-twitter-and-facebook-and-other-omniauth-schemes-without-email-addresses/">devise for authentication</a>.)</p>
          
          <p>Assuming that you&#39;ve already setup devise, lets look at how to implement a controller spec.  First lets create a simple scaffold for a post:</p>
          
          <pre><code class="sh">$ rails g scaffold post name:string&#x000A;</code></pre>
          
          <p>And lets make it require authentication in <code>posts_controller.rb</code>:</p>
          
          <pre><code class="rb">class PostsController &lt; ApplicationController&#x000A;  before_action :authenticate_user!&#x000A;</code></pre>
          
          <p>And replace <code>posts_controller_spec.rb</code> with:</p>
          
          <pre><code class="rb">require &#39;rails_helper&#39;&#x000A;&#x000A;RSpec.describe PostsController, :type =&gt; :controller do&#x000A;  describe &quot;anonymous user&quot; do&#x000A;    before :each do&#x000A;      # This simulates an anonymous user&#x000A;      login_with nil&#x000A;    end&#x000A;&#x000A;    it &quot;should be redirected to signin&quot; do&#x000A;      get :index&#x000A;      expect( response ).to redirect_to( new_user_session_path )&#x000A;    end&#x000A;  end&#x000A;end&#x000A;</code></pre>
          
          <p>When we run <code>guard</code>, a few of the scaffold generate things will fail, since we are now forcing signin to check out this page.  Our spec will correctly redirect the user to sign in.</p>
          
          <p>Lets now simulate a logged in user:</p>
          
          <pre><code class="rb">  it &quot;should let a user see all the posts&quot; do&#x000A;    login_with create( :user )&#x000A;    get :index&#x000A;    expect( response ).to render_template( :index )&#x000A;  end&#x000A;</code></pre>
          
          <p>Guard should try and run this tests but fail because we can&#39;t configured a user factory.</p>
          
          <p>Lets set that up now in <code>spec/factories/user.rb</code>:</p>
          
          <pre><code class="rb">FactoryGirl.define do&#x000A;  sequence :email do |n|&#x000A;    &quot;person#{n}@example.com&quot;&#x000A;  end&#x000A;end&#x000A;&#x000A;FactoryGirl.define do&#x000A;  factory :user, :class =&gt; &#39;User&#39; do&#x000A;    email&#x000A;    password &#39;12345678&#39;&#x000A;    password_confirmation &#39;12345678&#39;&#x000A;  end&#x000A;end&#x000A;</code></pre>
          
          <p>Going back to the guard window, press <em>return</em> to run everything again and verify.  (Guard doens&#39;t know that the <code>posts_controller_spec.rb</code> depends upon the user factory changing.)</p>
          
          <h2 id="example-rspec-feature">Example rspec feature</h2>
          
          <p>Feature specs are more interesting, since they let you walk through the site and how it works.  Lets build one now:</p>
          
          <pre><code class="sh">$ rails g rspec:feature add_new_post&#x000A;      create  spec/features/add_new_posts_spec.rb&#x000A;</code></pre>
          
          <p>And lets add something there now:</p>
          
          <pre><code class="rb">require &#39;rails_helper&#39;&#x000A;&#x000A;feature &quot;AddNewPosts&quot;, :type =&gt; :feature do&#x000A;  it &quot;should require the user log in before adding a post&quot; do&#x000A;    password = &quot;123456789&quot;&#x000A;    u = create( :user, password: password, password_confirmation: password )&#x000A;&#x000A;    visit new_post_path&#x000A;&#x000A;    within &quot;#new_user&quot; do&#x000A;      fill_in &quot;user_email&quot;, with: u.email&#x000A;      fill_in &quot;user_password&quot;, with: password&#x000A;    end&#x000A;&#x000A;    click_button &quot;Log in&quot;&#x000A;&#x000A;    within &quot;#new_post&quot; do&#x000A;      fill_in &quot;post_name&quot;, with: &quot;Post title&quot;&#x000A;    end&#x000A;&#x000A;    click_link_or_button &quot;Create Post&quot;&#x000A;&#x000A;    expect( Post.count ).to eq(1)&#x000A;    expect( Post.first.name).to eq( &quot;Post title&quot;)&#x000A;  end&#x000A;end&#x000A;</code></pre>
          
          <p>This first creates a new user in the database, and then</p>
          
          <ol>
          <li>Visits the <code>new_post_path</code> url.<br></li>
          <li>We should be shown the login form, and we fill it out</li>
          <li>Click the log in button</li>
          <li>Fill out the new post form</li>
          <li>Create the post</li>
          <li>Make sure that it&#39;s in the database</li>
          </ol>
          
          <p>If you want to skip the steps of manually logging in the user, you can use the <code>login_as</code> method like so:</p>
          
          <pre><code class="rb">  it &quot;should create a new post with a logged in user&quot; do&#x000A;    login_as create( :user ), scope: :user&#x000A;&#x000A;    visit new_post_path&#x000A;    # puts page.body&#x000A;&#x000A;    within &quot;#new_post&quot; do&#x000A;      fill_in &quot;post_name&quot;, with: &quot;Post title&quot;&#x000A;    end&#x000A;&#x000A;    click_link_or_button &quot;Create Post&quot;&#x000A;&#x000A;    expect( Post.count ).to eq(1)&#x000A;    expect( Post.first.name).to eq( &quot;Post title&quot;)&#x000A;&#x000A;  end&#x000A;</code></pre>
          
          <h2 id="setting-up-webmock-and-vcr">Setting up webmock and VCR</h2>
          
          <p>Webmock stops requests from hitting the network in the test environment.  Lets turn this on by editing <code>rails_helper.rb</code>:</p>
          
          <p>In <code>rails_helper.rb</code>, below <code>require &#39;rails/rspec&#39;</code>:</p>
          
          <pre><code class="rb">require &#39;webmock/rspec&#39;&#x000A;</code></pre>
          
          <p>And VCR lets you record and play back tests in the test environment, so the first time it&#39;s called it lets it get through, and then on subsequent requests it plays back a known response.  Put this at the bottom of <code>rails_helper.rb</code> to configure:</p>
          
          <pre><code class="rb">VCR.configure do |c|&#x000A;  c.cassette_library_dir  = Rails.root.join(&quot;spec&quot;, &quot;vcr&quot;)&#x000A;  c.hook_into :webmock&#x000A;end&#x000A;</code></pre>
          
          <h2 id="example-usage-of-webmock-and-vcr">Example usage of webmock and VCR</h2>
          
          <p>Word comes down from up high that to facilitate decision making, a key bit of information is the current phase of the moon when something is posted to the site.  We can pull the data from the <a href="http://cerridwen.readthedocs.org/en/latest/index.html">Cerridwen</a> site, but how do we set up tests for this?  We certainly don&#39;t want our test suite to fail because the phase of the moon changed!</p>
          
          <p>This is where webmock and VCR comes in.  Webmock by itself will throw an error when a request is made over the network.  VCR will let us record and play back network request -- using <em>cassettes</em> no less -- so that we isolate changing API responses from our tests.</p>
          
          <p>First lets write our code to look up the phase of the moon on the create post action.  Let&#39;s add a field</p>
          
          <pre><code class="rb">$ rails g migration add_phase_of_moon_to_posts moon_phase:string &amp;&amp; rake db:migrate&#x000A;</code></pre>
          
          <p>Then add the lookup to our <code>app/controllers/posts_controller.rb</code> and replace the <code>def create</code> method:</p>
          
          <pre><code class="rb">  require &#39;json&#39;&#x000A;  require &#39;net/http&#39;&#x000A;  def create&#x000A;    @post = Post.new(post_params)&#x000A;&#x000A;    moon_json = Net::HTTP.get( URI.parse(&quot;http://cerridwen.viridian-project.de/api/v1/moon&quot; ))&#x000A;    moon = JSON.parse( moon_json ).first&#x000A;&#x000A;    @post.moon_phase = &quot;#{moon[&#39;phase&#39;][&#39;trend&#39;]} in #{moon[&#39;position&#39;][&#39;sign&#39;]}&quot;&#x000A;&#x000A;    @post.save&#x000A;    respond_with(@post)&#x000A;  end&#x000A;</code></pre>
          
          <p>(This is not good style.)</p>
          
          <p>Now lets run our test again.</p>
          
          <p>Lots of unhandled http request errors!  I&#39;m going to ignore the scaffold generate tests and focus on our rspec feature.  So, inside of <code>spec/features/add_new_posts_spec.rb</code> we can link the click action inside of a use_cassette block like so::</p>
          
          <pre><code class="rb">  it &quot;should create a new post with a logged in user&quot; do&#x000A;    login_as create( :user ), scope: :user&#x000A;&#x000A;    visit new_post_path&#x000A;    # puts page.body&#x000A;&#x000A;    within &quot;#new_post&quot; do&#x000A;      fill_in &quot;post_name&quot;, with: &quot;Post title&quot;&#x000A;    end&#x000A;&#x000A;    VCR.use_cassette &quot;waxing_in_pisces&quot; do&#x000A;      click_link_or_button &quot;Create Post&quot;&#x000A;&#x000A;      expect( Post.count ).to eq(1)&#x000A;      expect( Post.first.name).to eq( &quot;Post title&quot;)&#x000A;      expect( Post.first.moon_phase).to eq( &quot;waxing in Pisces&quot; )&#x000A;    end&#x000A;  end&#x000A;</code></pre>
          
          <p>And let the tests run.  When tests are run, VCR is going to look for the file <code>spec/vcr/waxing_in_pisces</code>.  If it&#39;s not found, then it will make the request to the server.  If the API requires authentication, for example an accesstoken when accessing a OAuth protected call, then you&#39;ll need to configure you tests to have valid credentials for the first time.  These credentials could be written into the spec/vcr directory, so make sure that you scrub that before things get checked in.  (Or expire the access tokens.)</p>
          
          <p>If it is found, then it plays it back and so the next time the suite is run it plays it back.  Which is way faster.</p>
          
          <h2 id="final-notes">Final notes</h2>
          
          <p>Testing has a place in software development, but it&#39;s not actually clear where that is.  Setting up test haresses and building out tests for every feature really slows things down in the beginning, and probably isn&#39;t appropriate for one off, exploratory things.  On the other hand, things tend to grow way past what anyone ever initially expected, and you always say &quot;I wish there was a test suite&quot; when inheriting code -- or even more likely, looking at something you haven&#39;t seen for a few months.</p>
          
          <p>The rails community has a <a href="http://martinfowler.com/articles/is-tdd-dead/">long history with Test Driven Development</a>.  The biggest advantage of this is that you write code that is testable, and code that is testable has all sorts of other qualities that is great, from clearly defined boundries of responsibility, good encapulation, and being able to look at small isolated pieces of the system and having it make sense.  On the other hand, thebest code is the stuff you don&#39;t need to maintain, and in some projects the weight of the test code is as large or larger than the code for the application features.</p>
          
          <p>The biggest problem with testing is that it gets you in a wonderful, but wrong, flow state of development.  In the begining of projects you should be focused on the user experience, and how the system is experienced from the outside.  The highest level tests tend to be are user stories, which is below the level of brand and user experience.</p>
        </div>
        <div class='navigation' data-offset-top='400' data-spy='affix'>
          <div class='next'>
            <p>
              Next in
              <a href="/articles/">Chronological</a>
            </p>
            <p class='title'><a href="/why-engineers-build-crappy-products/">Why Engineers build crappy products</a></p>
            <p>
              Next in
              <a href="/tags/rails/">Rails</a>
            </p>
            <p class='title'><a href="/bower-with-rails/">Bower with Rails</a></p>
            <p>
              Next in
              <a href="/tags/happy_seed/">Happy_seed</a>
            </p>
            <p class='title'><a href="/using-seed-to-explore/">Using seed to explore APIs</a></p>
            <p>
              Next in
              <a href="/tags/ruby/">Ruby</a>
            </p>
            <p class='title'><a href="/slow-data-and-fast-sites/">Slow data and Fast Sites</a></p>
          </div>
          <div class='prev'>
            <p>
              Previously in
              <a href="/articles/">Chronological</a>
              <a href="/tags/rails/">Rails</a>
              <a href="/tags/happy_seed/">Happy_seed</a>
              <a href="/tags/ruby/">Ruby</a>
            </p>
            <p class='title'><a href="/setting-up-devise-with-twitter-and-facebook-and-other-omniauth-schemes-without-email-addresses/">Setting up Devise with Twitter and Facebook and other Omniauth schemes without email addresses</a></p>
          </div>
        </div>
      </div>
      <div class="row article_footer">
        <div class="comments">
            <a href="#" id="comment_shower">
              <p class="disqus-comment-count" data-disqus-identifier="2015-01-23-setting-up-testing.html">Be the first to comment.</p>
            </a>
        </div>
        <div class="sharing">
          <a href="http://www.twitter.com/share?url=http://willschenk.com/setting-up-testing/&amp;text=Setting up Rails testing with rspec, devise, and the gang by @wschenk" title="Share this post on Twitter" data-lang="en" onclick="return !window.open(this.href, 'Twitter', 'width=640,height=300')" class="webicon twitter"></a>
      
          <a target="_blank" onclick="return !window.open(this.href, 'Facebook', 'width=640,height=300')" href="http://www.facebook.com/sharer/sharer.php?u=http://willschenk.com/setting-up-testing/" title="Share this post on Facebook" class="webicon facebook"></a>
      
          <a href="http://plus.google.com/share?url=http://willschenk.com/setting-up-testing/" target="_blank" onclick="return !window.open(this.href, 'Google +', 'width=640,height=300')" title="Share this post on Google +" class="webicon google"></a>
        </div>
      </div>
        <div class="comment_row">
          <div class="comment_universe">
            <div id="disqus_thread" class="col-sm-10 col-sm-offset-1"></div>
          </div>
        </div>
    </div>
    <footer class='codex'>
      <div class='container'>
        <div class='row'>
          <div class='logo'>
            <a href='http://codex.happyfuncorp.com/'>
              <img src="../images/ted-16edc59a.png" />
              <img src="../images/codex_logo-02a37740.png" />
            </a>
          </div>
        </div>
        <div class='row'>
          <div class='body'>
            <h3>
              If you find this blog helpful, check out
              <a href='http://codex.happyfuncorp.com/'>
                codex
              </a>
            </h3>
            <p>Product, development, design and a whole slew of other things you need to know.</p>
            <p>
              From the fancy folks at
              <a href="http://happyfuncorp.com">HappyFunCorp</a>
            </p>
          </div>
        </div>
      </div>
    </footer>
    <footer class='footer  '>
      <div class='container'>
        <div class='row'>
          <div class='social'>
            <span>
              <a class='webicon twitter' href='http://twitter.com/wschenk'></a>
            </span>
            <span>
              <a class='webicon tumblr' href='http://sublimeguile.com/'></a>
            </span>
            <span>
              <a class='webicon instagram' href='http://instagram.com/wschenk'></a>
            </span>
            <span>
              <a class='webicon linkedin' href='http://www.linkedin.com/pub/will-schenk/0/266/420/'></a>
            </span>
            <span>
              <a class='webicon github' href='https://github.com/wschenk'></a>
            </span>
            <span>
              <a class='webicon rss' href='http://willschenk.com/feed.xml'></a>
            </span>
            <span>
              <a class='webicon mail' href='mailto:will@happyfuncorp.com'></a>
            </span>
          </div>
          <div class='made_in_bk'>
            <h3>Made in Brooklyn, NY</h3>
          </div>
        </div>
      </div>
    </footer>
    <script src="../javascripts/application-b5017286.js" type="text/javascript"></script><script src="../javascripts/modernizr-84a49412.js" type="text/javascript"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.3/highlight.min.js"></script>
    <script type="text/javascript">
      var _gaq=[['_setAccount','UA-56296045-1'],['_trackPageview']];
      (function(d,t){var g=d.createElement(t),s=d.getElementsByTagName(t)[0];
      g.src=('https:'==location.protocol?'//ssl':'//www')+'.google-analytics.com/ga.js';
      s.parentNode.insertBefore(g,s)}(document,'script'));
    </script>
    
    <script type="text/javascript">
      hljs.initHighlightingOnLoad();
      $(".article img").addClass( "img-responsive");
      $("iframe").map( function(e) {
        $(this).css( "max-width", $(this).width() );
        $(this).width( "100%" );
      });
      var _gaq=[['_setAccount','UA-56296045-1'],['_trackPageview']];
      (function(d,t){var g=d.createElement(t),s=d.getElementsByTagName(t)[0];
      g.src=('https:'==location.protocol?'//ssl':'//www')+'.google-analytics.com/ga.js';
      s.parentNode.insertBefore(g,s)}(document,'script'));
      var disqus_shortname = 'willschenk';
      var disqus_url = 'http://willschenk.com/setting-up-testing/';
        var disqus_identifier = '2015-01-23-setting-up-testing.html';
            
      (function() {
          var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
          dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
          (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      })();
      (function () {
    var s = document.createElement('script'); s.async = true;
    s.type = 'text/javascript';
    s.src = 'http://' + disqus_shortname + '.disqus.com/count.js';
    (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
    </script>
  </body>
</html>
