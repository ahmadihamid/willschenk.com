<!doctype html><html><head><title>Setting up SSB-Pub Server</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><link rel=stylesheet href=../../../css/theme.css><link rel=stylesheet href=../../../css/syntax.css><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-56296045-1','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script async defer data-domain=willschenk.com src=https://plausible.io/js/plausible.js></script><meta property="og:title" content="Setting up SSB-Pub Server"><meta property="og:description" content="I wanted to move my ssb installation over to a new computer, and the easiest way was to setup a pub server, invite the old and the new computer to the pub, and then swap out the keys. Here's how to do it. Overview     Create a server & name    Install docker    Create the docker image    Setup directories, config, and easy shell commands    Start up a container    Publish yourself as a pub    Connect your client   Create a server   I'm using debian 10 on digital ocean, but I'll let you get the system on the internet."><meta property="og:type" content="article"><meta property="og:url" content="https://willschenk.com/articles/2020/setting_up_ssb_pub_server/"><meta property="article:published_time" content="2020-07-09T00:00:00+00:00"><meta property="article:modified_time" content="2020-07-09T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Setting up SSB-Pub Server"><meta name=twitter:description content="I wanted to move my ssb installation over to a new computer, and the easiest way was to setup a pub server, invite the old and the new computer to the pub, and then swap out the keys. Here's how to do it. Overview     Create a server & name    Install docker    Create the docker image    Setup directories, config, and easy shell commands    Start up a container    Publish yourself as a pub    Connect your client   Create a server   I'm using debian 10 on digital ocean, but I'll let you get the system on the internet."><meta name=twitter:site content="@wschenk"><style>.article p,.article ul,.article ol,.article table{max-width:45em}.article pre p{max-width:none;margin-top:-1.5rem}article.article p:first-child,.article blockquote{font-size:1.25em;font-weight:300;max-width:36em}.half-height-scroll{max-height:32em;overflow:scroll}</style></head><body><nav class="container my-5"><h1 class="pt-md-5 display-3"><a class=text-dark href=../../../>Will Schenk</a></h1><p><a class="text-dark h4 mr-3 font-weight-light" href=../../../articles/>Articles</a>
<a class="text-dark h4 mr-3 font-weight-light" href=../../../contact>Contact</a>
<a class="text-dark h4 mr-3 font-weight-light" href=../../../tags/>Tags</a>
<a href=../../../feed.xml class="mr-3 h4 text-light"><img src=../../../img/rss.svg alt=rss height=20 width=20></a>
<a href=https://twitter.com/@wschenk class="mr-3 h4 text-light"><img src=../../../img/twitter.svg alt=twitter height=20 width=20></a>
<a href=https://instagram.com/wschenk class="mr-3 h4 text-light"><img src=../../../img/instagram.svg alt=instagram height=20 width=20></a>
<a href=https://github.com/wschenk class="mr-3 h4 text-light"><img src=../../../img/github.svg alt=github height=20 width=20></a>
<a href=https://linkedin.com/in/will-schenk-420266 class="mr-3 h4 text-light"><img src=../../../img/linkedin.svg alt=linkedin height=20 width=20></a></p></nav><div class=container><h1 class=mt-5>Setting up SSB-Pub Server</h1><h2 class="font-weight-light font-italic mb-3">and migrate your profile</h2><p class="text-muted mt-3"><a class=text-muted href=https://willschenk.com/articles/2020/setting_up_ssb_pub_server/>Published July 9, 2020</a>
<a class=text-muted href=../../../tags/howto>#howto,</a>
<a class=text-muted href=../../../tags/scuttlebutt>#scuttlebutt,</a>
<a class=text-muted href=../../../tags/p2p>#p2p</a></p><article class="article mt-5"><p>I wanted to move my ssb installation over to a new computer, and the
easiest way was to setup a pub server, invite the old and the new
computer to the pub, and then swap out the keys. Here's how to do it.</p><h2 id=headline-1>Overview</h2><ol><li><p>Create a server & name</p></li><li><p>Install <code class=verbatim>docker</code></p></li><li><p>Create the docker image</p></li><li><p>Setup directories, config, and easy shell commands</p></li><li><p>Start up a container</p></li><li><p>Publish yourself as a <code class=verbatim>pub</code></p></li><li><p>Connect your client</p></li></ol><h2 id=headline-2>Create a server</h2><p>I'm using debian 10 on digital ocean, but I'll let you get the system
on the internet. The only key thing is that it needs to have port
<code class=verbatim>8008</code> accessible from the outside world.</p><h2 id=headline-3>Install <code class=verbatim>docker</code></h2><p>I prefer to have things contained in a Docker container compared to
polluting my environment. This just keeps things cleaner in the
future so you don't have node or whatever floating around on your
system. This may be overly complicated if you aren't already a docker
user, or if you already have node installed on your system.</p><p>If you already have node, you can follow <a href=https://handbook.scuttlebutt.nz/guides/pubs/setup-a-pub>the setting up a pub
directions</a> straight from the mothership.</p><div class="src src-bash"><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>apt update
apt-get install -y <span class=se>\
</span><span class=se></span>	 apt-transport-https <span class=se>\
</span><span class=se></span>	 ca-certificates <span class=se>\
</span><span class=se></span>	 curl <span class=se>\
</span><span class=se></span>	 gnupg2 <span class=se>\
</span><span class=se></span>	 software-properties-common
curl -fsSL https://download.docker.com/linux/debian/gpg <span class=p>|</span> apt-key add -

add-apt-repository <span class=se>\
</span><span class=se></span>	 <span class=s2>&#34;deb [arch=amd64] https://download.docker.com/linux/debian \
</span><span class=s2>     </span><span class=k>$(</span>lsb_release -cs<span class=k>)</span><span class=s2> \
</span><span class=s2>     stable&#34;</span>
apt-get update
apt-get install -y docker-ce</code></pre></div></div><h2 id=headline-4>Write your <code class=verbatim>Dockerfile</code></h2><p>On the server, create a directory to work in, like <code class=verbatim>~/ssb</code></p><div class="src src-bash"><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>mkdir -p ~/ssb
<span class=nb>cd</span> ~/ssb</code></pre></div></div><p>And then create a Dockerfile:</p><div class="src src-dockerfile"><div class=highlight><pre class=chroma><code class=language-dockerfile data-lang=dockerfile><span class=k>FROM</span><span class=s> node:10</span><span class=err>
</span><span class=err>
</span><span class=err></span><span class=k>RUN</span> npm install -g ssb-server<span class=err>
</span><span class=err>
</span><span class=err></span><span class=k>EXPOSE</span><span class=s> 8008</span><span class=err>
</span><span class=err>
</span><span class=err>HEALTHCHECK --interval=30s --timeout=30s </span>--start-period<span class=o>=</span>10s --retries<span class=o>=</span><span class=m>10</span> <span class=se>\
</span><span class=se></span>  CMD ssb-server whoami <span class=o>||</span> <span class=nb>exit</span> <span class=m>1</span><span class=err>
</span><span class=err></span><span class=k>ENV</span> HEALING_ACTION RESTART<span class=err>
</span><span class=err>
</span><span class=err></span><span class=k>ENTRYPOINT</span> <span class=p>[</span> <span class=s2>&#34;/usr/local/bin/ssb-server&#34;</span> <span class=p>]</span><span class=err>
</span><span class=err></span><span class=k>CMD</span> <span class=p>[</span> <span class=s2>&#34;start&#34;</span> <span class=p>]</span></code></pre></div></div><p>And then build this with</p><div class="src src-bash"><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>docker build . -t ssb-server</code></pre></div></div><p>The reason that we are doing this in a seperate directory is to make
sure that we don't send the whole pub data instance to docker build if
we want to do this in the future.</p><p>You could also do this on your local machine and the publish the image
to dockerhub, but this is really just to isolate the npm install not
to make something publically available.</p><h2 id=headline-5>Setup directories and config files</h2><div class="src src-bash"><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>mkdir ~/pubdata</code></pre></div></div><p>Create basic <code class=verbatim>~/pubdata/config</code>, make sure to add your DNS name or ip
address in the external field.</p><div class="src src-json"><div class=highlight><pre class=chroma><code class=language-json data-lang=json><span class=p>{</span>
  <span class=nt>&#34;connections&#34;</span><span class=p>:</span> <span class=p>{</span>
    <span class=nt>&#34;incoming&#34;</span><span class=p>:</span> <span class=p>{</span>
      <span class=nt>&#34;net&#34;</span><span class=p>:</span> <span class=p>[</span>
        <span class=p>{</span> <span class=nt>&#34;scope&#34;</span><span class=p>:</span> <span class=s2>&#34;public&#34;</span><span class=p>,</span> 
          <span class=nt>&#34;host&#34;</span><span class=p>:</span> <span class=s2>&#34;0.0.0.0&#34;</span><span class=p>,</span> 
          <span class=nt>&#34;external&#34;</span><span class=p>:</span> <span class=p>[</span><span class=s2>&#34;Your Host Name or Public IP&#34;</span><span class=p>],</span> 
          <span class=nt>&#34;transform&#34;</span><span class=p>:</span> <span class=s2>&#34;shs&#34;</span><span class=p>,</span> 
          <span class=nt>&#34;port&#34;</span><span class=p>:</span> <span class=mi>8008</span> 
        <span class=p>}</span>
      <span class=p>]</span>
    <span class=p>},</span>
    <span class=nt>&#34;outgoing&#34;</span><span class=p>:</span> <span class=p>{</span>
      <span class=nt>&#34;net&#34;</span><span class=p>:</span> <span class=p>[{</span> <span class=nt>&#34;transform&#34;</span><span class=p>:</span> <span class=s2>&#34;shs&#34;</span> <span class=p>}]</span>
    <span class=p>}</span>
  <span class=p>}</span>
<span class=p>}</span></code></pre></div></div><p>And create a <code class=verbatim>~/ssb-server</code> script that will let you interact with the
<code class=verbatim>container</code> that we will create in the next section:</p><div class="src src-bash"><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash><span class=cp>#!/bin/sh
</span><span class=cp></span>
docker <span class=nb>exec</span> -it ssb-server ssb-server <span class=s2>&#34;</span><span class=nv>$@</span><span class=s2>&#34;</span></code></pre></div></div><p>Also be sure to <code class=verbatim>chmod +x ssb-server</code> to make it runnable.</p><h2 id=headline-6>Create the container</h2><div class="src src-bash"><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>docker run -d --init --name ssb-server <span class=se>\
</span><span class=se></span>   -v ~/pubdata/:/root/.ssb/ <span class=se>\
</span><span class=se></span>   -p 8008:8008 <span class=se>\
</span><span class=se></span>   --restart unless-stopped <span class=se>\
</span><span class=se></span>   ssb-server</code></pre></div></div><table class="table table-striped"><tbody><tr><td>-d</td><td>Detach and run as a daemon</td></tr><tr><td>–init</td><td>Use <code class=verbatim>tini</code> to handle signals</td></tr><tr><td>–name</td><td>Name of the container, which is the same as the instance</td></tr><tr><td>-v</td><td>Map <code class=verbatim>~/pubdata</code> to the <code class=verbatim>~/.ssb</code> dir inside the container</td></tr><tr><td>-p</td><td>Expose <code class=verbatim>8008</code> to the internet</td></tr><tr><td>–restart</td><td>For reboots, etc</td></tr></tbody></table><p>Now check the logs to make sure that everything started up correctly.</p><div class="src src-bash"><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>docker logs ssb-server</code></pre></div></div><p>If that looks good We can now test this by running command
<code class=verbatim>./ssb-server whoami</code> command to see if it's responding correctly.</p><p>If it's working, then publish an about entry for your pub. This is
what I did:</p><div class="src src-bash"><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>./ssb-server publish --type about <span class=se>\
</span><span class=se></span>   --about  <span class=s2>&#34;@stufffromthewhoamicommand&#34;</span> <span class=se>\
</span><span class=se></span>   --name <span class=s2>&#34;pub.willschenk.com&#34;</span> <span class=se>\
</span><span class=se></span>   --description <span class=s2>&#34;Call me&#34;</span></code></pre></div></div><h2 id=headline-7>Create an invite</h2><p>Once this is working, it's time to create some invites so you can
connect your local instance to this pub.</p><div class="src src-bash"><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>./ssb-server invite.create <span class=m>3</span></code></pre></div></div><p>That will spit out an awesome looking string. We'll use that in our
clients to connect.</p><h2 id=headline-8>Migrate your stuff over</h2><p>On the new machine <a href=https://ahdinosaur.github.io/patchwork-downloader/>download patchwork</a> which I found to be more stable
than <a href=https://github.com/ssbc/patchbay/releases>patchbay</a>. I had better luck building from <code class=verbatim>npm</code> than using <code class=verbatim>AppImage</code>, so</p><div class="src src-bash"><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>npm install --global electron electron-builder node-gyp-build ssb-patchwork</code></pre></div></div><p>You could also try oasis, which doesn't run in electron and so
therefor is better, even if it is a but more minimalist.</p><div class="src src-text"><div class=highlight><pre class=chroma><code class=language-text data-lang=text>npm -g install fraction/oasis</code></pre></div></div><p>Note that while they both share the same <code class=verbatim>.ssb</code> data folder, if you want
to use both you'll need to start up patchwork first.</p><ol><li><p>On the old machine, invite yourself to the pub.</p></li><li><p>Sync your stuff to the new pub.</p></li><li><p>On the new machine, invite yourself to the pub.</p></li><li><p>Follow your old user.</p></li><li><p>Wait for things to sync</p></li><li><p>On the new machine, close everything.</p></li><li><p>Copy the old <code class=verbatim>.ssb/secret</code> from the old to the new machine.</p></li><li><p>On the new machine, delete everthing in <code class=verbatim>./ssb/flume</code> <strong>except
<code class=verbatim>.ssb/flume/log.offset</code></strong></p></li><li><p>Open up <a href=https://github.com/ssbc/ssb-first-aid-kit>ssb-first-aid-kit</a> and delete the index</p></li><li><p>Restart patchwork and watch that sucker index everything in the
whole world.</p></li></ol><p>This really started to heat my machine up!</p><p>I found that the initial index worked in patchwork, and then it
started pulling in more data and eventually exploded. I was able to
run oasis instead, which seemed to be better at rebuilding the index.</p><p>Now I have my old profile on my new machine.</p><h2 id=headline-9>References</h2><ul><li><p><a href=https://scuttlebutt.nz/get-started/>https://scuttlebutt.nz/get-started/</a></p></li><li><p><a href=https://handbook.scuttlebutt.nz/guides/pubs/setup-a-pub>https://handbook.scuttlebutt.nz/guides/pubs/setup-a-pub</a></p></li><li><p><a href=https://github.com/ahdinosaur/ssb-pub/tree/v3>https://github.com/ahdinosaur/ssb-pub/tree/v3</a></p></li><li><p><a href=https://github.com/ssbc/ssb-first-aid-kit>https://github.com/ssbc/ssb-first-aid-kit</a></p></li><li><p><a href=https://github.com/ssbc/patchwork/issues/957>https://github.com/ssbc/patchwork/issues/957</a></p></li><li><p><a href=https://github.com/fraction/oasis>https://github.com/fraction/oasis</a></p></li></ul></article></div><div class="bg-light py-5"><div class=container><h2 class=text-center>Read next</h2><div class=row><div class="col-md-6 text-center">Next Post:
<a href=../../../articles/2020/getting_websters/>Getting Websters</a></div><div class="col-md-6 text-center">Previous Post:
<a href=../../../articles/2020/effigy_social_data_layer/>Effigy, a distributed social data layer</a></div></div></div></div><div class="container mt-5"><h2 class=text-center>See also</h2><div class=row><div class="col-md mb-3"><p class="lead mb-0"><a class=text-body href=../../../articles/2020/using_syncthing/>Using Syncthing</a></p><p class="lead font-italic mb-0">who needs servers</p><div class="font-weight-light mt-3"><p>Syncthing is a way to keep things up-to-date across machines without going through any 3rd party servers. You get both backup and file synchronization without pesky servers just using the computer capacity you probably already have laying around. Lets give it a spin. Installation on Debian On the Getting Started page of syncthing they recommend using a GUI package, but we're going to install on debian on the command line.</p></div><a href=../../../articles/2020/using_syncthing/ class="btn btn-primary">Read more</a></div><div class="col-md mb-3"><p class="lead mb-0"><a class=text-body href=../../../articles/2020/upgrading_emacs_on_debian/>Upgrading emacs on debian</a></p><p class="lead font-italic mb-0">fixing crashes</p><div class="font-weight-light mt-3"><p>Been playing with elfeed on Emacs 26.1 on buster and it keeps crashing. I think for font related reasons. So lets follow the Emacs Wiki Instructions to upgrade to emacs-snapshots and see if that helps. Add the snap shot repository. Make sure you have the tools installed so that apt can do it's internet thing. sudo apt-get install software-properties-common sudo apt-get update Add the signing key: wget -q http://emacs.</p></div><a href=../../../articles/2020/upgrading_emacs_on_debian/ class="btn btn-primary">Read more</a></div><div class="col-md mb-3"><p class="lead mb-0"><a class=text-body href=../../../articles/2020/simple_cors_workaround_for_local_development/>Simple CORS workaround for local development</a></p><div class="font-weight-light mt-3"><p>I've been doing a lot of web development old school, just editing HTML and JavaScript by hand without a build environment. Running npx live-server is an easy one liner to spin up a server, that opens a browser for you and also updates changes on safe. Sometimes that's not enough. Often you want to pull in data from an API, and that requires HTTPS, and also you need to work around CORS limitations.</p></div><a href=../../../articles/2020/simple_cors_workaround_for_local_development/ class="btn btn-primary">Read more</a></div></div></div><footer class="footer bg-dark text-light mt-3"><div class=container><h2 class="py-5 font-weight-light my-0">Made in Brooklyn, NY.</h2></div></footer></body></html>