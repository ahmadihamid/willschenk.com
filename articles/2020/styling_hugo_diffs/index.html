<!doctype html><html><head><title>Styling Hugo Diffs</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><link rel=stylesheet href=../../../css/theme.css><link rel=stylesheet href=../../../css/syntax.css><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-56296045-1','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script async defer data-domain=willschenk.com src=https://plausible.io/js/plausible.js></script><meta property="og:title" content="Styling Hugo Diffs"><meta property="og:description" content="I often want to show small changes I&rsquo;m making to a file and it would be nice for hugo to support styling patches directly. Lets see what we can do to make this process easier.
Lets take the example of create node package.json file and add the following scripts worflow. How can we say this different than &ldquo;copy this into your package.json file&rdquo;?
Create sample steps Lets first create the file using npm init -y and then immediately cp package."><meta property="og:type" content="article"><meta property="og:url" content="https://willschenk.com/articles/2020/styling_hugo_diffs/"><meta property="article:published_time" content="2020-01-31T00:00:00+00:00"><meta property="article:modified_time" content="2020-01-31T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Styling Hugo Diffs"><meta name=twitter:description content="I often want to show small changes I&rsquo;m making to a file and it would be nice for hugo to support styling patches directly. Lets see what we can do to make this process easier.
Lets take the example of create node package.json file and add the following scripts worflow. How can we say this different than &ldquo;copy this into your package.json file&rdquo;?
Create sample steps Lets first create the file using npm init -y and then immediately cp package."><meta name=twitter:site content="@wschenk"><style>.article p,.article ul,.article ol,.article table{max-width:45em}.article pre p{max-width:none;margin-top:-1.5rem}article.article p:first-child,.article blockquote{font-size:1.25em;font-weight:300;max-width:36em}.half-height-scroll{max-height:32em;overflow:scroll}</style></head><body><nav class="container my-5"><h1 class="pt-md-5 display-3"><a class=text-dark href=../../../>Will Schenk</a></h1><p><a class="text-dark h4 mr-3 font-weight-light" href=../../../articles/>Articles</a>
<a class="text-dark h4 mr-3 font-weight-light" href=../../../contact>Contact</a>
<a class="text-dark h4 mr-3 font-weight-light" href=../../../tags/>Tags</a>
<a href=../../../feed.xml class="mr-3 h4 text-light"><img src=../../../img/rss.svg alt=rss height=20 width=20></a>
<a href=https://twitter.com/@wschenk class="mr-3 h4 text-light"><img src=../../../img/twitter.svg alt=twitter height=20 width=20></a>
<a href=https://instagram.com/wschenk class="mr-3 h4 text-light"><img src=../../../img/instagram.svg alt=instagram height=20 width=20></a>
<a href=https://github.com/wschenk class="mr-3 h4 text-light"><img src=../../../img/github.svg alt=github height=20 width=20></a>
<a href=https://linkedin.com/in/will-schenk-420266 class="mr-3 h4 text-light"><img src=../../../img/linkedin.svg alt=linkedin height=20 width=20></a></p></nav><div class=container><h1 class=mt-5>Styling Hugo Diffs</h1><h2 class="font-weight-light font-italic mb-3">Showing just what you changed</h2><p class="text-muted mt-3"><a class=text-muted href=https://willschenk.com/articles/2020/styling_hugo_diffs/>Published January 31, 2020</a>
<a class=text-muted href=../../../tags/howto>#howto</a>
<a class=text-muted href=../../../tags/hugo>#hugo</a></p><article class="article mt-5"><p>I often want to show small changes I&rsquo;m making to a file and it would be nice for hugo to support styling patches directly. Lets see what we can do to make this process easier.</p><p>Lets take the example of <em>create node package.json file and add the following scripts</em> worflow. How can we say this different than &ldquo;copy this into your <code>package.json</code> file&rdquo;?</p><h2 id=create-sample-steps>Create sample steps</h2><p>Lets first create the file using <code>npm init -y</code> and then immediately <code>cp package.json package.json.base</code>. In this case, we want to add some <code>script</code> attributes, like so:</p><div class=highlight><pre class=chroma><code class=language-js data-lang=js>  <span class=s2>&#34;scripts&#34;</span><span class=o>:</span> <span class=p>{</span>
    <span class=s2>&#34;build:eleventy&#34;</span><span class=o>:</span> <span class=s2>&#34;eleventy&#34;</span><span class=p>,</span>
    <span class=s2>&#34;serve:eleventy&#34;</span><span class=o>:</span> <span class=s2>&#34;eleventy --serve&#34;</span><span class=p>,</span>
    <span class=s2>&#34;debug:eleventy&#34;</span><span class=o>:</span> <span class=s2>&#34;DEBUG=* eleventy&#34;</span>
  <span class=p>},</span>
</code></pre></div><p>So we can now look at the differences of the files using the <code>diff</code> command. I&rsquo;m going to have it user the unified format showing 1 line of code on either side.</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>diff -U <span class=m>1</span> package.json.base package.json
</code></pre></div><p>Which outputs:</p><div class=highlight><pre class=chroma><code class=language-patch data-lang=patch><span class=gd>--- package.json.base	2020-01-30 14:38:18.933332377 -0600
</span><span class=gd></span><span class=gi>+++ package.json	2020-01-30 15:43:37.174332377 -0600
</span><span class=gi></span><span class=gu>@@ -6,3 +6,5 @@
</span><span class=gu></span>   &#34;scripts&#34;: {
<span class=gd>-    &#34;test&#34;: &#34;echo \&#34;Error: no test specified\&#34; &amp;&amp; exit 1&#34;
</span><span class=gd></span><span class=gi>+    &#34;build:eleventy&#34;: &#34;eleventy&#34;,
</span><span class=gi>+    &#34;serve:eleventy&#34;: &#34;eleventy --serve&#34;,
</span><span class=gi>+    &#34;debug:eleventy&#34;: &#34;DEBUG=* eleventy&#34;
</span><span class=gi></span>   },
</code></pre></div><p>This seems a little better, but how do we keep it up to date?</p><h2 id=bash-script>Bash script</h2><p>We are going to write a bash script to parse though a files. First lets do that and make sure that we can pull out the base name of the file.</p><p><a href=./update_patches.sh.base><code>update_patches.sh.base</code></a>:</p><div class=highlight><pre class=chroma><code class=language-diff data-lang=diff>#!/bin/bash
<p>for i in *.base
do
echo $i is the base file
echo ${i%.base} is final file
done
</code></pre></div></p><p>That seems to work, now lets loop over the files that match the base name, skipping the files that we don&rsquo;t want. Once we get to the <code>.base</code> file, we know that we are at the end of our patching, and we need to compare the last stage with the original file instead, so we&rsquo;ll check for that and update the variables so that the <code>stage</code> file is actually the current one.</p><p><a href=./update_patches.sh.1><code>update_patches.sh.1</code></a>:</p><div class=highlight><pre class=chroma><code class=language-diff data-lang=diff><span class=gd>--- update_patches.sh.base
</span><span class=gd></span><span class=gi>+++ update_patches.sh.1
</span><span class=gi></span><span class=gu>@@ -4,4 +4,22 @@
</span><span class=gu></span> do
<span class=gd>-    echo $i is the base file
</span><span class=gd>-    echo ${i%.base} is final file
</span><span class=gd></span><span class=gi>+    last_file=&#34;$i&#34;
</span><span class=gi>+    final_file=&#34;${i%.base}&#34;
</span><span class=gi>+
</span><span class=gi>+    for stage in ${final_file}.*
</span><span class=gi>+    do
</span><span class=gi>+	# Strip out emacs junk
</span><span class=gi>+	if [[ $stage == *~ ]]; then
</span><span class=gi>+	    continue
</span><span class=gi>+	fi
</span><span class=gi>+	
</span><span class=gi>+	# We are at the end!
</span><span class=gi>+	if [[ $stage == *.base ]]; then
</span><span class=gi>+	    stage=$final_file
</span><span class=gi>+	fi
</span><span class=gi>+
</span><span class=gi>+	echo Need to patch $last_file to make $stage
</span><span class=gi>+
</span><span class=gi>+	last_file=$stage
</span><span class=gi>+    done
</span><span class=gi>+    echo
</span><span class=gi></span> done
</code></pre></div><p>The logic seems to work, so lets add the actual diff creation. But the diff files match our pattern, so we&rsquo;ll need to add a check to skip over them when we loop over the glob!</p><p><a href=./update_patches.sh><code>update_patches.sh</code></a>:</p><div class=highlight><pre class=chroma><code class=language-diff data-lang=diff><span class=gd>--- update_patches.sh.1
</span><span class=gd></span><span class=gi>+++ update_patches.sh
</span><span class=gi></span><span class=gu>@@ -19,3 +19,13 @@
</span><span class=gu></span> 
<span class=gd>-	echo Need to patch $last_file to make $stage
</span><span class=gd></span><span class=gi>+	# Skip parsing of diff files
</span><span class=gi>+	if [[ $stage == *.diff ]]; then
</span><span class=gi>+	    continue
</span><span class=gi>+	fi
</span><span class=gi>+
</span><span class=gi>+	echo Creating $stage.diff
</span><span class=gi>+
</span><span class=gi>+	# -Z Ignores space
</span><span class=gi>+	# -U 1 sets to the unified patch format with one surrounding lines
</span><span class=gi>+	# Setting --label directly lets use avoid timestamps
</span><span class=gi>+	diff -Z -U 1 --label $last_file --label $stage $last_file $stage &gt; $stage.diff
</span><span class=gi></span> 
</code></pre></div><h2 id=usage>Usage</h2><p>The idea here is that you are working on an explainable chunk of work. You start by getting a base file that everyone can work off of. For example, run <code>npm init -y</code> and then copy that file to <code>package.json.base</code>. Then make your changes and run <code>update_patches.sh</code> to generate the patch, which will initially just compare <code>package.json.base</code> and <code>package.json</code></p><p>Later you want to make another change to the file. Before you edit <code>package.json</code> make a copy to <code>package.json.1</code>, and make your changes again. Then run <code>update_patches.sh</code> which will regenerate all the diffs for each file. Then write about it, and repeat the process as necessary.</p><h2 id=displaying-the-patch-files-easily>Displaying the patch files easily</h2><p>What I want to do in while writing markdown is to do something like</p><p><em>If we want to show the base file</em>:</p><p><code>{{ diff &ldquo;package.json&rdquo; }}</code></p><p><em>text here</em></p><p><code>{{ diff &ldquo;package.json&rdquo; &ldquo;1&rdquo; }}</code></p><p><em>text here</em></p><p><code>{{ diff &ldquo;package.json&rdquo; &ldquo;final&rdquo; }}</code></p><p>in my content file, and which will figure out the correct diff to inline it.</p><p>Here is a <a href=../../../diff.html>hugo short code</a> that you can drop in your <code>/layouts/shortcodes/</code> folder that will make that possible.</p><p>Embedding shortcodes as an example inside of hugo is a pain, so I&rsquo;ll walk you through the logic but we wont&rsquo; be looking at the code.</p><ol><li>Pull out the parameters to make it easier to work with.</li><li><code>$diff</code> is going to contain the file contents, initialize it to blank in a scope that everyone can see.</li><li>If <code>$stage</code> is set and is <code>final</code>, we append &ldquo;.diff&rdquo; to a file &ndash; which we assume is in the same directory as the Page that is calling the short code &ndash; and <code>readFile</code>.</li><li>If <code>$stage</code> is set but not final, append &ldquo;.$stage.diff&rdquo; to the filename and load.</li><li>If <code>$stage</code> is blank load &ldquo;$filename.diff&rdquo;. This is to avoid expanding to <code>..diff</code> which has an extra <code>.</code>.</li><li>Markdownify a link to the file directly and pass to markdownify</li><li>Markdownify the actual file, formatting is as a <code>diff</code></li></ol><h2 id=what-it-looks-like-in-action>What it looks like in action</h2><p>Lets first start out by creating an empty project:</p><ol><li><code>mkdir projectname && cd projectname</code></li><li><code>npm init -y</code></li><li>Add the following script entries to the generated <code>package.json</code></li></ol><p><a href=./package.json.1><code>package.json.1</code></a>:</p><div class=highlight><pre class=chroma><code class=language-diff data-lang=diff><span class=gd>--- package.json.base
</span><span class=gd></span><span class=gi>+++ package.json.1
</span><span class=gi></span><span class=gu>@@ -6,3 +6,5 @@
</span><span class=gu></span>   &#34;scripts&#34;: {
<span class=gd>-    &#34;test&#34;: &#34;echo \&#34;Error: no test specified\&#34; &amp;&amp; exit 1&#34;
</span><span class=gd></span><span class=gi>+    &#34;build:eleventy&#34;: &#34;eleventy&#34;,
</span><span class=gi>+    &#34;serve:eleventy&#34;: &#34;eleventy --serve&#34;,
</span><span class=gi>+    &#34;debug:eleventy&#34;: &#34;DEBUG=* eleventy&#34;
</span><span class=gi></span>   },
</code></pre></div><p>Oh, we forgot to install <code>eleventy</code>! Let&rsquo;s do that now with <code>npm install --save-dev @11ty/eleventy</code> which should modify your <code>package.json</code> like so:</p><p><a href=./package.json><code>package.json</code></a>:</p><div class=highlight><pre class=chroma><code class=language-diff data-lang=diff><span class=gd>--- package.json.1
</span><span class=gd></span><span class=gi>+++ package.json
</span><span class=gi></span><span class=gu>@@ -12,3 +12,6 @@
</span><span class=gu></span>   &#34;author&#34;: &#34;&#34;,
<span class=gd>-  &#34;license&#34;: &#34;ISC&#34;
</span><span class=gd></span><span class=gi>+  &#34;license&#34;: &#34;ISC&#34;,
</span><span class=gi>+  &#34;devDependencies&#34;: {
</span><span class=gi>+    &#34;@11ty/eleventy&#34;: &#34;^0.10.0&#34;,
</span><span class=gi>+  }
</span><span class=gi></span> }
</code></pre></div></article></div><div class="bg-light py-5"><div class=container><h2 class=text-center>Read next</h2><div class=row><div class="col-md-6 text-center">Next Post:
<a href=../../../articles/2020/playing_with_tailwind/>Playing with tailwind</a></div><div class="col-md-6 text-center">Previous Post:
<a href=../../../articles/2020/server_templating_with_terraform/>Template to setup a linode server with DNS and HTTPS</a></div></div></div></div><div class="container mt-5"><h2 class=text-center>See also</h2><div class=row><div class="col-md mb-3"><p class="lead mb-0"><a class=text-body href=../../../articles/2019/splitting_git_repos_and_workdirectories/>Splitting Git Repos and Work Directories</a></p><p class="lead font-italic mb-0">all the fun things git can do</p><div class="font-weight-light mt-3"><p>I found a tutorial on how to manage your dotfiles, that works by splitting up the git repository (normally the .git directory) from the work directory. Since I have a lot of code that I put in my tutorials, I adapted the technique to have individual article directories mirrored in their own github repository.
Repositories and Work Directories The normal usage of git is to type git clone &lt;remote> to get a copy of the local directory, mess with stuff, and then add and commit your changes.</p></div><a href=../../../articles/2019/splitting_git_repos_and_workdirectories/ class="btn btn-primary">Read more</a></div><div class="col-md mb-3"><p class="lead mb-0"><a class=text-body href=../../../articles/2019/easy_scraping_with_httpie_and_jq/>Easy scraping with httpie and jq</a></p><p class="lead font-italic mb-0">Pulling my GitHub starred repositories into Hugo</p><div class="font-weight-light mt-3"><p>I recently saw a tweet mentioning the combination of using <a href=https://httpie.org/>HTTPie</a> (a command line HTTP client), <a href=https://stedolan.github.io/jq/>jq</a> (a lightweight and flexible command-line JSON processor) and <a href=https://github.com/tomnomnom/gron>Gron</a> (Make JSON greppable!) was &ldquo;all you needed to build a scraper.&rdquo; Lets see if that&rsquo;s true.</p></div><a href=../../../articles/2019/easy_scraping_with_httpie_and_jq/ class="btn btn-primary">Read more</a></div><div class="col-md mb-3"><p class="lead mb-0"><a class=text-body href=../../../articles/2018/automating_hugo_with_circleci/>Automating hugo builds using CircleCI</a></p><p class="lead font-italic mb-0">Let someone else run your build server</p><div class="font-weight-light mt-3"><p><p class=lead>Here's a simple CircleCI configuration to pull down the latest version of your hugo site on GitHub commits, build it, and then push it to github pages.</p></p></div><a href=../../../articles/2018/automating_hugo_with_circleci/ class="btn btn-primary">Read more</a></div></div></div><footer class="footer bg-dark text-light mt-3"><div class=container><h2 class="py-5 font-weight-light my-0">Made in Brooklyn, NY.</h2></div></footer></body></html>