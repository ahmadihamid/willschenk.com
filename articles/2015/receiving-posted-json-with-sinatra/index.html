<!DOCTYPE html>
<html><head>
  <title>Receiving posted JSON with Sinatra</title>
  
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../../css/theme.css"/>
  
  <link rel="stylesheet" href="../../../css/syntax.css"/>

  
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-56296045-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

  <meta property="og:title" content="Receiving posted JSON with Sinatra" />
<meta property="og:description" content="Here&rsquo;s some simple code to accept a JSON string posted to a Sinatra end point rather than a form. I switched from using jQueries $.ajax method to superagent as part of my exploration of the node javascript package universe, and it has a different way of serializing nest objects when posting as a form. Specifically, it doesn&rsquo;t.
I needed something that could do both.
Code to use form encoding or JSON blob This first tries and loads the parameters using the normal form encoding methods." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://willschenk.com/articles/2015/receiving-posted-json-with-sinatra/" /><meta property="article:published_time" content="2015-07-27T00:00:00&#43;00:00"/>
<meta property="article:modified_time" content="2015-07-27T00:00:00&#43;00:00"/>

  <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Receiving posted JSON with Sinatra"/>
<meta name="twitter:description" content="Here&rsquo;s some simple code to accept a JSON string posted to a Sinatra end point rather than a form. I switched from using jQueries $.ajax method to superagent as part of my exploration of the node javascript package universe, and it has a different way of serializing nest objects when posting as a form. Specifically, it doesn&rsquo;t.
I needed something that could do both.
Code to use form encoding or JSON blob This first tries and loads the parameters using the normal form encoding methods."/>
<meta name="twitter:site" content="@wschenk"/>


  <style>
    .article p, .article ul, .article ol, .article table {
      max-width: 45em;
    }

    article.article p:first-child, .article blockquote {
      font-size: 1.25em;
      font-weight: 300;
      max-width: 36em;  
    }
  </style>
</head>
<body><nav class="container my-5">
  <h1 class="pt-5 display-3"><a class="text-dark" href="../../../">Will Schenk</a></h1>
  <p>
    
      <a class="text-dark h4 mr-3 font-weight-light" href="../../../articles/" title="">Articles</a>
    
      <a class="text-dark h4 mr-3 font-weight-light" href="../../../contact" title="">Contact</a>
    
      <a class="text-dark h4 mr-3 font-weight-light" href="../../../tags/" title="">Tags</a>
    
    <a href="../../../feed.xml" class="mr-3 h4 text-light"><img src="../../../img/rss.svg" alt="rss" height="20" width="20"/></a>
    
      <a href="https://twitter.com/@wschenk" class="mr-3 h4 text-light"><img src="../../../img/twitter.svg" alt="twitter" height="20" width="20"/></a>
    
    
      <a href="https://instagram.com/wschenk" class="mr-3 h4 text-light"><img src="../../../img/instagram.svg" alt="instagram" height="20" width="20"/></a>
    
    
      <a href="https://linkedin.com/in/will-schenk-420266" class="mr-3 h4 text-light"><img src="../../../img/linkedin.svg" alt="linkedin" height="20" width="20"/></a>
    
  </p>
</nav>

<div class="container">
  <h1 class="mt-5">Receiving posted JSON with Sinatra</h1>

  
    <h2 class="font-weight-light font-italic mb-3">small tricks to make things easier</h2>
  

  <p class="text-muted mt-3">
    <a class="text-muted" href="https://willschenk.com/articles/2015/receiving-posted-json-with-sinatra/">Published July 27, 2015</a>

    
      <a class="text-muted" href="../../../tags/ruby">#ruby</a>
    
      <a class="text-muted" href="../../../tags/sinatra">#sinatra</a>
    
      <a class="text-muted" href="../../../tags/toys">#toys</a>
    
  </p>

  

  <article class="article mt-5">
    

<p>Here&rsquo;s some simple code to accept a JSON string posted to a <a href="http://www.sinatrarb.com">Sinatra</a> end point rather than a form. I switched from using <a href="http://jquery.com">jQueries</a> <code>$.ajax</code> method to <a href="https://github.com/visionmedia/superagent">superagent</a> as part of my exploration of the node javascript package universe, and it has a different way of serializing nest objects when posting as a form.  Specifically, it doesn&rsquo;t.</p>

<p>I needed something that could do both.</p>

<h2 id="code-to-use-form-encoding-or-json-blob">Code to use form encoding or JSON blob</h2>

<p>This first tries and loads the parameters using the normal form encoding methods.  If it doesn&rsquo;t find the <code>path</code> parameter, it attempts to parse the body&rsquo;s payload, found in <code>request.body.read</code>, using <code>JSON.parse</code>:</p>
<div class="highlight"><pre class="chroma"><code class="language-ruby" data-lang="ruby">  <span class="n">post</span> <span class="s1">&#39;/post&#39;</span> <span class="k">do</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="n">params</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="no">JSON</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">read</span><span class="p">)</span><span class="o">.</span><span class="n">symbolize_keys</span> <span class="k">unless</span> <span class="n">params</span><span class="o">[</span><span class="ss">:path</span><span class="o">]</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span> <span class="s2">&#34;Saving </span><span class="si">#{</span><span class="n">payload</span><span class="o">[</span><span class="ss">:path</span><span class="o">]</span><span class="si">}</span><span class="s2"> with </span><span class="si">#{</span><span class="n">payload</span><span class="o">[</span><span class="ss">:meta</span><span class="o">]</span><span class="si">}</span><span class="s2">&#34;</span>

    <span class="n">file</span> <span class="o">=</span> <span class="n">load_app</span><span class="o">.</span><span class="n">sitemap</span><span class="o">.</span><span class="n">find_resource_by_path</span> <span class="n">payload</span><span class="o">[</span><span class="ss">:path</span><span class="o">]</span>
  <span class="k">end</span></code></pre></div>
<h2 id="javascript">Javascript</h2>

<p>The coffeescript that calls this is:</p>
<div class="highlight"><pre class="chroma"><code class="language-coffeescript" data-lang="coffeescript"><span class="nx">request</span><span class="p">.</span><span class="nx">post</span> <span class="s">&#34;/api/post&#34;</span>
  <span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s">&#39;Content-Type&#39;</span><span class="p">,</span> <span class="s">&#39;application/json&#39;</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">send</span> <span class="nv">path: </span><span class="nx">@state</span><span class="p">.</span><span class="nx">path</span><span class="p">,</span> <span class="nv">meta: </span><span class="nx">@state</span><span class="p">.</span><span class="nx">metadata</span><span class="p">,</span> <span class="nv">body: </span><span class="nx">@state</span><span class="p">.</span><span class="nx">markdown</span>
  <span class="p">.</span><span class="nx">end</span> <span class="nf">(err, response) =&gt;</span>
    <span class="k">if</span> <span class="nx">response</span><span class="p">.</span><span class="nx">ok</span>
      <span class="vi">@state.saving = </span><span class="kc">false</span>
      <span class="vi">@state.dirty = </span><span class="kc">false</span>
      <span class="nx">@trigger</span> <span class="nx">@state</span></code></pre></div>
<p>In this case, <code>@state.metadata</code> is also a complex object, and posting it as JSON ensures that it&rsquo;s marshalled correctly.</p>

<p>Not too complicated.</p>

  </article>
</div>


  <div class="bg-light py-5">
    <div class="container">
      <h2 class="text-center">Read next</h2>

      <div class="row">
        <div class="col-md-6 text-center">
          
            Next Post:
            <a href="../../../articles/2015/building-a-gui-for-managing-middleman-blogs/">Building a GUI for managing middleman blogs</a>
          
        </div>
        <div class="col-md-6 text-center">
          
            Previous Post:
            <a href="../../../articles/2015/bower-with-rails/">Bower with Rails</a>
          
        </div>
      </div>
    </div>
  </div>




<div class="container mt-5">
  <h2 class="text-center">See also</h2>
  <div class="row">
  	
      <div class="col-md mb-3">
        <p class="lead mb-0"><a class="text-body" href="../../../articles/2014/how-to-track-your-coworkers/">How to track your coworkers</a></p>

        
          <p class="lead font-italic mb-0">Simple passive network surveillance</p>
        
        <p class="font-weight-light mt-3">How much information do you bleed?
Ever wonder who is else is using your network? Or,who has actually showed up at the office?
Networking primer The simplest thing we can do to make this work is to check to see which devices have registered themselves on the network. As devices come and go, they connect automatically, so we will have a pretty good idea if people are there or not.</p>
        <a href="../../../articles/2014/how-to-track-your-coworkers/" class="btn btn-primary">Read more</a>
      </div>
    
      <div class="col-md mb-3">
        <p class="lead mb-0"><a class="text-body" href="../../../articles/2015/adding-search-to-a-middleman-blog/">Adding search to a middleman blog</a></p>

        
          <p class="lead font-italic mb-0">slightly simplier than google</p>
        
        <p class="font-weight-light mt-3">We&rsquo;re going to build a simple, niave search for middleman blogs. We&rsquo;re going to build a search index at build time, and then use that index to perform the search itself on the client side.
Building the index When you typed in something in google, it doesn&rsquo;t then go and hit every page on the internet to check to see if there&rsquo;s a match. It doesn&rsquo;t even look at every page that it has squirreled away somewhere in the googleplex.</p>
        <a href="../../../articles/2015/adding-search-to-a-middleman-blog/" class="btn btn-primary">Read more</a>
      </div>
    
      <div class="col-md mb-3">
        <p class="lead mb-0"><a class="text-body" href="../../../articles/2015/osx-script-for-kiosk-mode/">OSX Script for Kiosk Mode</a></p>

        
          <p class="lead font-italic mb-0">make your own screen saver</p>
        
        <p class="font-weight-light mt-3">In the office, we run Jenkins on the same machine that we run Benevolent Gaze. During iOS builds, the iOS simulator will take over the screen for the build, and then leave the beautiful screen on the desktop, hiding our smiling faces. We want to return to Safari in this case, but we also want to make sure that if someone is actually in front of the machine it will let them do their thing.</p>
        <a href="../../../articles/2015/osx-script-for-kiosk-mode/" class="btn btn-primary">Read more</a>
      </div>
    
  </div>
</div>


<footer class="footer bg-dark text-light mt-3">
  <div class="container">
    <h2 class="py-5 font-weight-light my-0">Made in Brooklyn, NY.</h2>
  </div>
</footer>
</body>
</html>
