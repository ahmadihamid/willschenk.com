<!DOCTYPE html>
<html><head>
  <title>Middleman Tricks and Hacks</title>
  
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../../css/theme.css"/>
  
  <link rel="stylesheet" href="../../../css/syntax.css"/>

  
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-56296045-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

  <meta property="og:title" content="Middleman Tricks and Hacks" />
<meta property="og:description" content="As part of the process of getting this site to work, I learned some more things about how to better build a site with middleman. Building off of our foundational article here are a few other things that I found very useful when using middleman to build a static site with a bunch of dynamically generated content.
Partials The index.html.haml, articles.html.haml, tag.html.haml and calendar.html.haml pages all use the same partial to list out the post archives, which are mostly the same." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://willschenk.com/articles/2014/middleman-tricks-and-hacks/" />
<meta property="article:published_time" content="2014-12-13T00:00:00&#43;00:00"/>
<meta property="article:modified_time" content="2014-12-13T00:00:00&#43;00:00"/>

  <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Middleman Tricks and Hacks"/>
<meta name="twitter:description" content="As part of the process of getting this site to work, I learned some more things about how to better build a site with middleman. Building off of our foundational article here are a few other things that I found very useful when using middleman to build a static site with a bunch of dynamically generated content.
Partials The index.html.haml, articles.html.haml, tag.html.haml and calendar.html.haml pages all use the same partial to list out the post archives, which are mostly the same."/>
<meta name="twitter:site" content="@wschenk"/>


  <style>
    .article p, .article ul, .article ol, .article table {
      max-width: 45em;
    }

    article.article p:first-child, .article blockquote {
      font-size: 1.25em;
      font-weight: 300;
      max-width: 36em;  
    }
  </style>
</head>
<body><nav class="container my-5">
  <h1 class="pt-md-5 display-3"><a class="text-dark" href="../../../">Will Schenk</a></h1>
  <p>
    
      <a class="text-dark h4 mr-3 font-weight-light" href="../../../articles/" title="">Articles</a>
    
      <a class="text-dark h4 mr-3 font-weight-light" href="../../../contact" title="">Contact</a>
    
      <a class="text-dark h4 mr-3 font-weight-light" href="../../../tags/" title="">Tags</a>
    
    <a href="../../../feed.xml" class="mr-3 h4 text-light"><img src="../../../img/rss.svg" alt="rss" height="20" width="20"/></a>
    
      <a href="https://twitter.com/@wschenk" class="mr-3 h4 text-light"><img src="../../../img/twitter.svg" alt="twitter" height="20" width="20"/></a>
    
    
      <a href="https://instagram.com/wschenk" class="mr-3 h4 text-light"><img src="../../../img/instagram.svg" alt="instagram" height="20" width="20"/></a>
    
    
      <a href="https://linkedin.com/in/will-schenk-420266" class="mr-3 h4 text-light"><img src="../../../img/linkedin.svg" alt="linkedin" height="20" width="20"/></a>
    
  </p>
</nav>

<div class="container">
  <h1 class="mt-5">Middleman Tricks and Hacks</h1>

  
    <h2 class="font-weight-light font-italic mb-3">specific tricks I used to build this site</h2>
  

  <p class="text-muted mt-3">
    <a class="text-muted" href="https://willschenk.com/articles/2014/middleman-tricks-and-hacks/">Published December 13, 2014</a>

    
      <a class="text-muted" href="../../../tags/middleman">#middleman</a>
    
      <a class="text-muted" href="../../../tags/ruby">#ruby</a>
    
      <a class="text-muted" href="../../../tags/howto">#howto</a>
    
      <a class="text-muted" href="../../../tags/tools">#tools</a>
    
  </p>

  
  <div class="alert alert-danger">This article was published a while ago and may contain obsolete information!</div>
  

  <article class="article mt-5">
    

<p>As part of the process of getting this site to work, I learned some more things about how to better build a site with middleman.  Building off of our <a href="../../../building-sites-with-middleman/">foundational article</a> here are a few other things that I found very useful when using middleman to build a static site with a bunch of dynamically generated content.</p>

<h2 id="partials">Partials</h2>

<p>The <code>index.html.haml</code>, <code>articles.html.haml</code>, <code>tag.html.haml</code> and <code>calendar.html.haml</code> pages all use the same partial to list out the post archives, which are mostly the same.</p>

<p>On the <em>index</em> page it&rsquo;s called like this, where I&rsquo;m supressing the date heading:</p>
<div class="highlight"><pre class="chroma"><code class="language-haml" data-lang="haml">= partial &#34;post_list&#34;, :locals =&gt; {:page_articles =&gt; blog.articles[1..4], :no_date =&gt; true }</code></pre></div>
<p>and in the <em>articles</em> I&rsquo;m including draft posts for my own reference, and since they don&rsquo;t have a published date we need to check for that.</p>
<div class="highlight"><pre class="chroma"><code class="language-haml" data-lang="haml">= partial &#34;post_list&#34;, :locals =&gt; {:page_articles =&gt; (drafts + page_articles)}</code></pre></div>
<p>The <code>_post_list.haml</code> file then has some logic to show date headings based upon the published dates of the articles.  (This assumes that the posts are sorted by time, either ascending or descending.)</p>
<div class="highlight"><pre class="chroma"><code class="language-haml" data-lang="haml">- last_date = nil
- no_date = !!no_date
%ul
  - page_articles.each do |current_post|
    - if !no_date &amp;&amp; current_post.date
      - date_string = current_post.date.strftime(&#39;%b %Y&#39;)
      - if last_date != date_string
        %li.date
          %h2= date_string
      - last_date = date_string
    %li
      .more
        - unless current_post.is_a? ::Middleman::Blog::Drafts::DraftArticle
          = current_post.date.strftime( &#39;%b %e&#39; )
        - else
          Draft
      %div= link_to current_post.title, current_post
      %div
        = current_post.data[&#39;subtitle&#39;]

        .tags
          - current_post.tags.sort.each do |tag|
            .tag= link_to tag, tag_path( tag )</code></pre></div>
<p>Partials also work better when using <a href="../../../bootstrap-advanced-grid-tricks/">semantic CSS classes</a> to define my layouts, since the same class can have different meaning depending upon what it is embedded in.</p>

<h2 id="layouts-and-partials-for-articles">Layouts and partials for articles</h2>

<p>Middleman posts are generally written in markdown, which translates into a series of <code>&lt;p&gt;</code> tags that are dumped into a layout file.  In order to create the table of contents on the left, the navigation to other articles on the right, the unique header and footer, I used a seperate <code>article_layout</code> for article pages.  Setting up <strong>Scrollspy</strong> and <strong>Affix</strong> means we need to change things on the <code>&lt;body&gt;</code> tag that we don&rsquo;t need to do for other pages, so it makes more sense to use a seperate file here rather than a <em>nested layout</em>.</p>

<p>This means that all the things that are shared between the two layouts, the main layout for all the meta pages and the article layout for the content pages, should be factored into partials.  I put these partials in the <code>layouts/</code> directory.</p>

<h2 id="communication-between-partials">Communication between partials</h2>

<p>The top and the bottom of these pages change together.  If the page has a header image &ndash; something I specify in the YAML preamble of my post &ndash; then both the <code>article_header</code> and <code>footer</code> partials display slightly different things.  The logic for this check is in the <code>article_header</code>, where I set a <em>instance variable</em> that I use in a later partial to add a class.</p>

<p>In <code>layouts/_article_header.haml</code>:</p>
<div class="highlight"><pre class="chroma"><code class="language-haml" data-lang="haml">- @lighter ||= &#34;&#34;
- @dark_header = &#34;dark_header&#34; if current_article.data[&#39;dark_header&#39;]
- if !current_article.data[&#39;header_image&#39;].nil? &amp;&amp; current_article.data[&#39;header_image&#39;] != &#34;&#34;
  - @lighter = &#34;lighter&#34;
  .banner
    = image_tag current_article.data[&#39;header_image&#39;], class: &#34;fadeInDown animated&#34;

%div{ class: &#34;article-header #{@lighter} #{@dark_header}&#34; }</code></pre></div>
<p>and then in <code>layouts/_footer.haml</code> I use the same variable to add a class to the <code>footer</code> element which changes the background.</p>

<pre><code>%footer{ class: &quot;footer #{@lighter} #{@dark_header}&quot; }
</code></pre>

<h2 id="markdown-with-toc-data">Markdown with toc data</h2>

<p>Inside of <code>config.rb</code> we can add some better markdown processing options.  I switched to redcarpet and enabled <code>with_toc_data</code>.  This generates id tags on the <code>&lt;h1&gt;</code>, <code>&lt;h2&gt;</code> etc elements that we can use as anchors.</p>
<div class="highlight"><pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="n">set</span> <span class="ss">:markdown</span><span class="p">,</span> <span class="ss">:tables</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">:autolink</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">:gh_blockcode</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">:fenced_code_blocks</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">with_toc_data</span><span class="p">:</span> <span class="kp">true</span>
<span class="n">set</span> <span class="ss">:markdown_engine</span><span class="p">,</span> <span class="ss">:redcarpet</span></code></pre></div>
<p>These ids are generated by sanitizing the text between the tags, but <code>redcarpet</code> only makes things lowercase and changes spaces to underscores, and unfortunately it doesn&rsquo;t strip out punctuation characters and will result in ids that aren&rsquo;t valid.  So I had to change my headers, at least until I can take a look at the redcarpet code in more detail.</p>

<p><strong>Update</strong> This looks like it&rsquo;s fixed in the latest git version of redcarpet, but it hasn&rsquo;t been released as a gem yet.</p>

<h2 id="helpers-that-parse-the-source-file">Helpers that parse the source file</h2>

<p>Now that we have the anchors in there, we need to generate the links to those anchors.  This can be done by parsing the source file on the article page with a helper.  It&rsquo;s a poor man&rsquo;s markdown processor, but it does the job.  This code lives in <code>config.rb</code>:</p>
<div class="highlight"><pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="n">helpers</span> <span class="k">do</span>
  <span class="k">def</span> <span class="nf">chapters</span><span class="p">(</span> <span class="n">post</span> <span class="p">)</span>
    <span class="no">File</span><span class="o">.</span><span class="n">readlines</span><span class="p">(</span> <span class="n">post</span><span class="o">.</span><span class="n">source_file</span> <span class="p">)</span><span class="o">.</span><span class="n">collect</span> <span class="k">do</span> <span class="o">|</span><span class="n">x</span><span class="o">|</span>
      <span class="k">if</span> <span class="n">x</span> <span class="o">=~</span> <span class="sr">/^##\s(.*)/</span>
        <span class="vg">$1</span>
      <span class="k">else</span>
        <span class="kp">nil</span>
      <span class="k">end</span>
    <span class="k">end</span><span class="o">.</span><span class="n">select</span> <span class="p">{</span> <span class="o">|</span><span class="n">x</span><span class="o">|</span> <span class="n">x</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></div>
<p>And we can then use it to generate the list of links:</p>
<div class="highlight"><pre class="chroma"><code class="language-haml" data-lang="haml">%ul.nav.toc
  %li= link_to current_article.title, &#34;#top&#34;
  - chapters( current_article ).each do |chapter|
    %li= link_to chapter, &#34;##{chapter.downcase.gsub( /\s/, &#34;-&#34; )}&#34;</code></pre></div>
<h2 id="helper-methods-to-do-query-ish-things">Helper methods to do query-ish things</h2>

<p>The logic to calculate the <em>next</em> and <em>previous</em> articles in the series work using the tag system, and it cycles though all of the tags of the current article to find articles with corresponding tags.  Rather than showing the same article for multiple tags, I wanted to group the tags together if they all pointed to the same article.</p>

<p>This is the type of logic that would normally be in a rails Model.  Either you&rsquo;d do it directly out of the database, or you would process the results somehow and return something that was easy to iterate over in the view.</p>

<p>Moving this code into helper method isolated all of that logic out of the views themselves.</p>

<h2 id="site-data-as-database">Site data as database</h2>

<p>The other thing I wanted to do was to associate additional data with specific tags.  If this was an article, you could put it in the preamble, but since tags are generated dynamically from the article files we need to put them somewhere else.  That place is <code>data/topics.yml</code></p>
<div class="highlight"><pre class="chroma"><code class="language-yml" data-lang="yml">---<span class="w">
</span><span class="w"></span><span class="p">:</span>howto<span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="p">:</span>title<span class="p">:</span><span class="w"> </span>Howtos<span class="w">
</span><span class="w">  </span><span class="p">:</span>desc<span class="p">:</span><span class="w"> </span>In<span class="w"> </span>which<span class="w"> </span>we<span class="w"> </span>go<span class="w"> </span>through<span class="w"> </span>step<span class="w"> </span>by<span class="w"> </span>step<span class="w"> </span>to<span class="w"> </span>achieve<span class="w"> </span>a<span class="w"> </span>particular<span class="w"> </span>goal.<span class="w">
</span><span class="w"></span><span class="p">:</span>overview<span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="p">:</span>title<span class="p">:</span><span class="w"> </span>Overviews<span class="w">
</span><span class="w">  </span><span class="p">:</span>desc<span class="p">:</span><span class="w"> </span>In<span class="w"> </span>which<span class="w"> </span>we<span class="w"> </span>cover<span class="w"> </span>a<span class="w"> </span>topic<span class="w"> </span>in<span class="w"> </span>depth<span class="w"> </span>to<span class="w"> </span>orient<span class="w"> </span>ourselves<span class="w"> </span>with<span class="w"> </span>the<span class="w"> </span>technology.</code></pre></div>
<p>This is referenced in views like:</p>
<div class="highlight"><pre class="chroma"><code class="language-haml" data-lang="haml">- data[&#39;topics&#39;].each do |k,d|
  .track
    %h2= link_to d[:title], &#34;/tags/#{k}.html&#34;</code></pre></div>
<p>This data is also referenced in the tag page as well as the main header.  It&rsquo;s only stored in one place, which is nice and DRY.  If it got any more complicated than this, where we wanted to filter or sort it in some dynamic way then we implement that code in a helper so it could be shared across the site.</p>

<h2 id="directory-index-and-url-for">Directory index and url_for</h2>

<p>To make pretty urls work in the blog, you need to have <code>activate :directory_indexes</code> <em>after</em> <code>activate :blog</code> in your <code>config.rb</code> file.  <em>The order of middleman extensions in the config file matter.</em></p>

<p>The plugin works by changing the way that the <code>link_to</code> helper works.  If you have a link that&rsquo;s generated in another way, you should use the <code>url_for</code> method to make sure that it get&rsquo;s rewritten.  For example</p>
<div class="highlight"><pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="o">=</span> <span class="n">navbar_item</span> <span class="n">d</span><span class="o">[</span><span class="s1">&#39;title&#39;</span><span class="o">]</span><span class="p">,</span> <span class="n">url_for</span><span class="p">(</span> <span class="s2">&#34;/tags/</span><span class="si">#{</span><span class="n">topic</span><span class="si">}</span><span class="s2">.html&#34;</span> <span class="p">)</span></code></pre></div>
<h2 id="not-a-lot-of-tradeoffs">Not a lot of tradeoffs</h2>

<p>Other than the one issue with redcarpet where I couldn&rsquo;t control the way that the ids were being generated, there hasn&rsquo;t been much that I haven&rsquo;t be able to achieve with a statically generated site.  The implementation is different, but overall most of the time was spent fiddling with the CSS rather than fighting the build system.</p>

<p>Which is how it should be.</p>

  </article>
</div>


  <div class="bg-light py-5">
    <div class="container">
      <h2 class="text-center">Read next</h2>

      <div class="row">
        <div class="col-md-6 text-center">
          
            Next Post:
            <a href="../../../articles/2014/dateslice-writing-rails-extensions/">Dateslice: Writing rails extensions</a>
          
        </div>
        <div class="col-md-6 text-center">
          
            Previous Post:
            <a href="../../../articles/2014/building-middleman-extensions/">Building Middleman Extensions</a>
          
        </div>
      </div>
    </div>
  </div>




<div class="container mt-5">
  <h2 class="text-center">See also</h2>
  <div class="row">
  	
      <div class="col-md mb-3">
        <p class="lead mb-0"><a class="text-body" href="../../../articles/2014/building-sites-with-middleman/">Building Sites with Middleman</a></p>

        
          <p class="lead font-italic mb-0">lean publishing</p>
        
        <p class="font-weight-light mt-3">I make a lot of websites, and I have a certain toolkit that I use to build them. The most useful things I use are:
 layouts and partials so I only need to set things up once haml for writing html, since I don&rsquo;t like closing tags Bootstrap and sass for writing css Markdown for formatting large blogs of content coffeescript for JavaScript  Middleman is a static site generator, which means that it takes a bunch of source files, does some stuff with it, and produces static HTML, CSS, Images, and Javascript that can be hosted on a basic server somewhere, including hosting on S3 or Github Pages so you don&rsquo;t need to consider a server.</p>
        <a href="../../../articles/2014/building-sites-with-middleman/" class="btn btn-primary">Read more</a>
      </div>
    
      <div class="col-md mb-3">
        <p class="lead mb-0"><a class="text-body" href="../../../articles/2014/dateslice-writing-rails-extensions/">Dateslice: Writing rails extensions</a></p>

        
          <p class="lead font-italic mb-0">adding date group_by to ActiveRecord</p>
        
        <p class="font-weight-light mt-3">Ruby on Rails is a very modular framework since the merging with Merb in 2008. The opinionated conventions are implemented under using techniques that let you jump in and build your own components, picking and choosing different parts that let you build Rails apps in the same straightforward way you would if using the official modules.
Let&rsquo;s go through the dateslices gem which I wrote to extend active record so that we could better interact with the group by sql command when dealing with dates.</p>
        <a href="../../../articles/2014/dateslice-writing-rails-extensions/" class="btn btn-primary">Read more</a>
      </div>
    
      <div class="col-md mb-3">
        <p class="lead mb-0"><a class="text-body" href="../../../articles/2014/pulling-data-out-of-google-analytics/">Pulling data out of Google Analytics</a></p>

        
          <p class="lead font-italic mb-0">see who&rsquo;s talking about your stuff</p>
        
        <p class="font-weight-light mt-3">I like staring at the real time stats of Google Analytics. As a dashboard, it&rsquo;s not really as amazing as Chartbeat is, and it doesn&rsquo;t let you drill down into the data as much as Mixpanel. But GA is super simple to setup and it&rsquo;s Google, so everyone uses it.
Another obsessive/fun thing to do is to see where that spike in inbound traffic is coming from. On HappyFunCorp there are days where we get a sudden influx of Happy Thoughts which warms our hearts and floods our inboxes.</p>
        <a href="../../../articles/2014/pulling-data-out-of-google-analytics/" class="btn btn-primary">Read more</a>
      </div>
    
  </div>
</div>


<footer class="footer bg-dark text-light mt-3">
  <div class="container">
    <h2 class="py-5 font-weight-light my-0">Made in Brooklyn, NY.</h2>
  </div>
</footer>
</body>
</html>
