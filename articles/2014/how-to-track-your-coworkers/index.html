<!doctype html><html><head><title>How to track your coworkers</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><link rel=stylesheet href=../../../css/theme.css><link rel=stylesheet href=../../../css/syntax.css><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-56296045-1','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script async defer data-domain=willschenk.com src=https://plausible.io/js/plausible.js></script><meta property="og:title" content="How to track your coworkers"><meta property="og:description" content="How much information do you bleed?
Ever wonder who is else is using your network? Or,who has actually showed up at the office?
Networking primer The simplest thing we can do to make this work is to check to see which devices have registered themselves on the network. As devices come and go, they connect automatically, so we will have a pretty good idea if people are there or not. Phones seem to attach and detach quite frequency, probably to conserve battery, so if we are want to answer the question &ldquo;is so-and-so in the office&rdquo; we&rsquo;ll need to add additional logic to determine how far spaced the &ldquo;sighting&rdquo; events are to mean that the person has left the office, rather than the phone has gone to sleep."><meta property="og:type" content="article"><meta property="og:url" content="https://willschenk.com/articles/2014/how-to-track-your-coworkers/"><meta property="article:published_time" content="2014-10-31T00:00:00+00:00"><meta property="article:modified_time" content="2014-10-31T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="How to track your coworkers"><meta name=twitter:description content="How much information do you bleed?
Ever wonder who is else is using your network? Or,who has actually showed up at the office?
Networking primer The simplest thing we can do to make this work is to check to see which devices have registered themselves on the network. As devices come and go, they connect automatically, so we will have a pretty good idea if people are there or not. Phones seem to attach and detach quite frequency, probably to conserve battery, so if we are want to answer the question &ldquo;is so-and-so in the office&rdquo; we&rsquo;ll need to add additional logic to determine how far spaced the &ldquo;sighting&rdquo; events are to mean that the person has left the office, rather than the phone has gone to sleep."><meta name=twitter:site content="@wschenk"><style>.article p,.article ul,.article ol,.article table{max-width:45em}.article pre p{max-width:none;margin-top:-1.5rem}article.article p:first-child,.article blockquote{font-size:1.25em;font-weight:300;max-width:36em}.half-height-scroll{max-height:32em;overflow:scroll}</style></head><body><nav class="container my-5"><h1 class="pt-md-5 display-3"><a class=text-dark href=../../../>Will Schenk</a></h1><p><a class="text-dark h4 mr-3 font-weight-light" href=../../../articles/>Articles</a>
<a class="text-dark h4 mr-3 font-weight-light" href=../../../contact>Contact</a>
<a class="text-dark h4 mr-3 font-weight-light" href=../../../tags/>Tags</a>
<a href=../../../feed.xml class="mr-3 h4 text-light"><img src=../../../img/rss.svg alt=rss height=20 width=20></a>
<a href=https://twitter.com/@wschenk class="mr-3 h4 text-light"><img src=../../../img/twitter.svg alt=twitter height=20 width=20></a>
<a href=https://instagram.com/wschenk class="mr-3 h4 text-light"><img src=../../../img/instagram.svg alt=instagram height=20 width=20></a>
<a href=https://github.com/wschenk class="mr-3 h4 text-light"><img src=../../../img/github.svg alt=github height=20 width=20></a>
<a href=https://linkedin.com/in/will-schenk-420266 class="mr-3 h4 text-light"><img src=../../../img/linkedin.svg alt=linkedin height=20 width=20></a></p></nav><div class=container><h1 class=mt-5>How to track your coworkers</h1><h2 class="font-weight-light font-italic mb-3">Simple passive network surveillance</h2><p class="text-muted mt-3"><a class=text-muted href=https://willschenk.com/articles/2014/how-to-track-your-coworkers/>Published October 31, 2014</a>
<a class=text-muted href=../../../tags/toys>#toys</a>
<a class=text-muted href=../../../tags/ruby>#ruby</a>
<a class=text-muted href=../../../tags/redis>#redis</a>
<a class=text-muted href=../../../tags/howto>#howto</a></p><article class="article mt-5"><p>How much information do you bleed?</p><p>Ever wonder who is else is using your network? Or,who has actually showed up at the office?</p><h2 id=networking-primer>Networking primer</h2><p>The simplest thing we can do to make this work is to check to see which devices have registered themselves on the network. As devices come and go, they connect automatically, so we will have a pretty good idea if people are there or not. Phones seem to attach and detach quite frequency, probably to conserve battery, so if we are want to answer the question &ldquo;is so-and-so in the office&rdquo; we&rsquo;ll need to add additional logic to determine how far spaced the &ldquo;sighting&rdquo; events are to mean that the person has left the office, rather than the phone has gone to sleep.</p><p>There are a couple of ways to do this. One is to log on you your router and look at the <code>DHCP</code> routing tables to see which devices have leased an IP address. Have you looked at those router webpages though? Pretty gross. You&rsquo;d need to do some scraping, something different for each of the router types, all together pretty gross.</p><p>Another thing to consider is <code>DNS multicast</code>, also called <code>Bonjour</code> or zero-config networking. This is pretty much the standard now for services announcing themselves on the human-used networks. (Server rooms have fancier service discovery mechanisms.) If you want to find a printer, or someone else&rsquo;s iTunes library it works great, but it doesn&rsquo;t do much for phones.</p><p>We are going to do this using ping. This is simple and works everywhere.</p><h2 id=the-plan>The plan</h2><p>The code below using <code>ruby</code> and <code>redis</code> to track which devices have been seen. You&rsquo;ll need to have <code>redis</code> installed and running for this code to work, but it should be easily portable to any Unix system, not just OSX. So if you have a <code>RaspberryPI</code>laying around, it would be run to run it on there.</p><p>This code does the following things:</p><ol><li>Find the local broadcast address. This is normally <code>192.168.1.255</code> on home routers but could be anything.</li><li>Send 4 pings to the broadcast address and listen for replies. It may take some time to return back,which is why we have multiple pings. Collect those IP addresses as a response.</li><li>Do a reverse DNS lookup on those IP addresses, and mark them as seen in <code>redis</code>.</li><li>(Commented out) Look at the arp table to see if any other devices have announced themselves. This will discover mode devices, but the ARP cache lasts an unknown amount of time, so this will not correctly track leaving events.</li><li>The <code>def seen</code> method will set a key in <code>redis</code> and expire it in <code>30</code> seconds. The scan runs every <code>10</code> seconds. So if we having seen a device in 2 or 3 scans then we assume it has left the network. We look at each of the keys in the redis set <code>hosts</code> to see if it still exists, and if not, assume that the device has left.</li></ol><h2 id=the-code>The Code</h2><p>The only <code>OSX</code> ism of this script is that its using <code>osascript</code> to push a notification to the desktop that a device name has come on or left. See below for further things to play with:</p><div class=highlight><pre class=chroma><code class=language-ruby data-lang=ruby><span class=ch>#!/usr/bin/env ruby -wKU</span>

<span class=nb>require</span> <span class=s1>&#39;resolv&#39;</span>
<span class=nb>require</span> <span class=s1>&#39;redis&#39;</span>

<span class=k>def</span> <span class=nf>notify</span><span class=p>(</span> <span class=n>text</span> <span class=p>)</span>
  <span class=nb>system</span><span class=p>(</span> <span class=s2>&#34;/usr/bin/osascript -e </span><span class=se>\&#34;</span><span class=s2>display notification </span><span class=se>\\\&#34;</span><span class=si>#{</span><span class=n>text</span><span class=si>}</span><span class=se>\\\&#34;\&#34;</span><span class=s2>&#34;</span> <span class=p>)</span>
<span class=k>end</span>

<span class=k>def</span> <span class=nf>scan</span>
  <span class=c1># Look for the network broadcast address</span>
  <span class=n>broadcast</span> <span class=o>=</span> <span class=sb>`ifconfig -a | grep broadcast`</span><span class=o>.</span><span class=n>split</span><span class=o>[-</span><span class=mi>1</span><span class=o>]</span>

  <span class=c1># puts &#34;Broadcast Address #{broadcast}&#34;</span>

  <span class=k>unless</span> <span class=n>broadcast</span> <span class=o>=~</span> <span class=sr>/\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}/</span>
    <span class=nb>puts</span> <span class=s2>&#34;</span><span class=si>#{</span><span class=n>broadcast</span><span class=si>}</span><span class=s2> doesn&#39;t look correct&#34;</span>
    <span class=nb>exit</span> <span class=mi>1</span>
  <span class=k>end</span>

  <span class=c1># Ping the broadcast address 4 times and wait for responses</span>
  <span class=n>ips</span> <span class=o>=</span> <span class=sb>`ping -t 4 </span><span class=si>#{</span><span class=n>broadcast</span><span class=si>}</span><span class=sb>`</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=sr>/\n/</span><span class=p>)</span><span class=o>.</span><span class=n>collect</span> <span class=k>do</span> <span class=o>|</span><span class=n>x</span><span class=o>|</span>
    <span class=k>if</span> <span class=n>x</span> <span class=o>=~</span> <span class=sr>/(\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}):/</span>
      <span class=vg>$1</span>
    <span class=k>else</span>
      <span class=kp>nil</span>
    <span class=k>end</span>
  <span class=k>end</span><span class=o>.</span><span class=n>select</span> <span class=p>{</span> <span class=o>|</span><span class=n>x</span><span class=o>|</span> <span class=n>x</span> <span class=o>&amp;&amp;</span> <span class=n>x</span> <span class=o>!=</span> <span class=n>broadcast</span><span class=p>}</span><span class=o>.</span><span class=n>sort</span><span class=o>.</span><span class=n>uniq</span>

  <span class=n>dns</span> <span class=o>=</span> <span class=no>Resolv</span><span class=o>.</span><span class=n>new</span>

  <span class=c1># Do a host name lookup on all of the addresses and put in redis</span>
  <span class=n>ips</span><span class=o>.</span><span class=n>each</span> <span class=k>do</span> <span class=o>|</span><span class=n>ip</span><span class=o>|</span>
    <span class=nb>name</span> <span class=o>=</span> <span class=n>dns</span><span class=o>.</span><span class=n>getname</span> <span class=n>ip</span>
    <span class=n>seen</span><span class=p>(</span> <span class=nb>name</span> <span class=p>)</span>
  <span class=k>end</span>

  <span class=c1># If you want to catch the other devices that don&#39;t respond to pings</span>
  <span class=c1># but have an arp, you can scan below.  However, arp addresses get</span>
  <span class=c1># cached for a while,</span>
  <span class=c1># Catch the other devices that don&#39;t respond to pings but have arp addresses</span>
  <span class=c1># (pinging the broadcast address will help populate the local arp table)</span>
  <span class=c1># `arp -a`.split( /\n/ ).collect do |x|</span>
  <span class=c1>#   if x =~ /^([^\s]*).*\((\d+\.\d+\.\d+\.\d+)\)/</span>
  <span class=c1>#     seen( $1 )</span>
  <span class=c1>#   end</span>
  <span class=c1># end</span>

  <span class=c1># Look through all of the members in redis, and for any ones that have</span>
  <span class=c1># expired say that they&#39;ve left the system</span>
  <span class=n>redis</span> <span class=o>=</span> <span class=no>Redis</span><span class=o>.</span><span class=n>new</span>

  <span class=n>redis</span><span class=o>.</span><span class=n>smembers</span><span class=p>(</span> <span class=s2>&#34;hosts&#34;</span> <span class=p>)</span><span class=o>.</span><span class=n>each</span> <span class=k>do</span> <span class=o>|</span><span class=n>host</span><span class=o>|</span>
    <span class=k>unless</span> <span class=n>redis</span><span class=o>.</span><span class=n>get</span> <span class=n>host</span>
      <span class=n>redis</span><span class=o>.</span><span class=n>srem</span> <span class=s2>&#34;hosts&#34;</span><span class=p>,</span> <span class=n>host</span>

      <span class=nb>puts</span> <span class=s2>&#34;</span><span class=si>#{</span><span class=no>Time</span><span class=o>.</span><span class=n>new</span><span class=si>}</span><span class=s2> </span><span class=si>#{</span><span class=n>host</span><span class=si>}</span><span class=s2> left the network&#34;</span>
      <span class=n>notify</span> <span class=s2>&#34;</span><span class=si>#{</span><span class=n>host</span><span class=si>}</span><span class=s2> left the network&#34;</span>
    <span class=k>end</span>
  <span class=k>end</span>
<span class=k>end</span>

<span class=c1># Mark the name as being seen.  Create a key with the name and expire it in</span>
<span class=c1># 30 seconds.  Also add it to the hosts set.  If we don&#39;t see the name again</span>
<span class=c1># in 3 sweeps, the key will expire.</span>
<span class=k>def</span> <span class=nf>seen</span><span class=p>(</span> <span class=nb>name</span> <span class=p>)</span>
  <span class=nb>name</span> <span class=o>=</span> <span class=nb>name</span><span class=o>.</span><span class=n>downcase</span>
  <span class=n>redis</span> <span class=o>=</span> <span class=no>Redis</span><span class=o>.</span><span class=n>new</span>
  <span class=k>unless</span> <span class=n>redis</span><span class=o>.</span><span class=n>get</span> <span class=nb>name</span>
    <span class=nb>puts</span> <span class=s2>&#34;</span><span class=si>#{</span><span class=no>Time</span><span class=o>.</span><span class=n>new</span><span class=si>}</span><span class=s2> </span><span class=si>#{</span><span class=nb>name</span><span class=si>}</span><span class=s2> joined the network&#34;</span>
    <span class=n>notify</span> <span class=s2>&#34;</span><span class=si>#{</span><span class=nb>name</span><span class=si>}</span><span class=s2> joined the network&#34;</span>
  <span class=k>end</span>
  <span class=n>redis</span><span class=o>.</span><span class=n>set</span> <span class=nb>name</span><span class=p>,</span> <span class=s2>&#34;1&#34;</span>
  <span class=n>redis</span><span class=o>.</span><span class=n>expire</span> <span class=nb>name</span><span class=p>,</span> <span class=s2>&#34;30&#34;</span>
  <span class=n>redis</span><span class=o>.</span><span class=n>sadd</span> <span class=s2>&#34;hosts&#34;</span><span class=p>,</span> <span class=nb>name</span>
<span class=k>end</span>

<span class=c1># Run forever</span>
<span class=k>while</span> <span class=kp>true</span>
  <span class=nb>scan</span>
  <span class=nb>sleep</span> <span class=mi>10</span>
<span class=k>end</span>
</code></pre></div><h2 id=next-steps>Next steps</h2><p>Other things to play around with:</p><ol><li><code>nmap -O hostname</code> will do a scan of the device to see what operation system it is. However, this is a little more intrusive, needs to run as root, and takes a while to run so it should be queued.</li><li>Instead of using osascript, post the device joined, left, or presence events to an internal website to make a better UI.</li><li>This would allow you to map multiple device names to a person. For example, I know that <code>willschiphone5s.home</code> is my phone and <code>combray.home</code> is my computer, but how do you keep a mapping of those names to people?</li><li><code>MAC addresses</code> should be stable for devices once they may contact to the site. We can get this from the <code>arp</code> tables, and those can&rsquo;t be changed like the computer names can.</li></ol><p>Remember, information can bleed and there&rsquo;s a whole lot you can do to see about the people around you.</p></article></div><div class="bg-light py-5"><div class=container><h2 class=text-center>Read next</h2><div class=row><div class="col-md-6 text-center">Next Post:
<a href=../../../articles/2014/bootstrap-advanced-grid-tricks/>Bootstrap: Advanced Grid Tricks</a></div><div class="col-md-6 text-center">Previous Post:
<a href=../../../articles/2020/inq_to_check_github_stats/></a></div></div></div></div><footer class="footer bg-dark text-light mt-3"><div class=container><h2 class="py-5 font-weight-light my-0">Made in Brooklyn, NY.</h2></div></footer></body></html>