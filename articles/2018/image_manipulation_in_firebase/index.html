<!DOCTYPE html>
<html><head>
  <title>Image Manipulation in Firebase</title>
  
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../../css/theme.css"/>
  <link rel="stylesheet" href="../../../css/syntax.css"/>

  
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-56296045-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

  <meta property="og:title" content="Image Manipulation in Firebase" />
<meta property="og:description" content="We can manipulate images using JavaScript directly, which can be run both on the server or browser environment. Lets take a look at how we&rsquo;d do this using create-react-app and firebase. We will deploy a function on firebase that will download the user&rsquo;s avatar, manipulate the image and overlay it with a mask, and then spit out an image.
Project Setup First make sure that you have nvm installed. We&rsquo;ll need a different version of node for create-react-app then we will for firebase functions." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://willschenk.com/articles/2018/image_manipulation_in_firebase/" />
<meta property="article:published_time" content="2018-11-23T00:00:00&#43;00:00"/>
<meta property="article:modified_time" content="2018-11-23T00:00:00&#43;00:00"/>

  <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Image Manipulation in Firebase"/>
<meta name="twitter:description" content="We can manipulate images using JavaScript directly, which can be run both on the server or browser environment. Lets take a look at how we&rsquo;d do this using create-react-app and firebase. We will deploy a function on firebase that will download the user&rsquo;s avatar, manipulate the image and overlay it with a mask, and then spit out an image.
Project Setup First make sure that you have nvm installed. We&rsquo;ll need a different version of node for create-react-app then we will for firebase functions."/>
<meta name="twitter:site" content="@wschenk"/>


  <style>
    .article p, .article ul, .article ol, .article table {
      max-width: 45em;
    }

    article.article p:first-child, .article blockquote {
      font-size: 1.25em;
      font-weight: 300;
      max-width: 36em;  
    }
  </style>
</head>
<body><nav class="container my-5">
  <h1 class="pt-md-5 display-3"><a class="text-dark" href="../../../">Will Schenk</a></h1>
  <p>
    
      <a class="text-dark h4 mr-3 font-weight-light" href="../../../articles/" title="">Articles</a>
    
      <a class="text-dark h4 mr-3 font-weight-light" href="../../../contact" title="">Contact</a>
    
      <a class="text-dark h4 mr-3 font-weight-light" href="../../../tags/" title="">Tags</a>
    
    <a href="../../../feed.xml" class="mr-3 h4 text-light"><img src="../../../img/rss.svg" alt="rss" height="20" width="20"/></a>
    
      <a href="https://twitter.com/@wschenk" class="mr-3 h4 text-light"><img src="../../../img/twitter.svg" alt="twitter" height="20" width="20"/></a>
    
    
      <a href="https://instagram.com/wschenk" class="mr-3 h4 text-light"><img src="../../../img/instagram.svg" alt="instagram" height="20" width="20"/></a>
    
    
      <a href="https://linkedin.com/in/will-schenk-420266" class="mr-3 h4 text-light"><img src="../../../img/linkedin.svg" alt="linkedin" height="20" width="20"/></a>
    
  </p>
</nav>

<div class="container">
  <h1 class="mt-5">Image Manipulation in Firebase</h1>

  
    <h2 class="font-weight-light font-italic mb-3">its all javascript</h2>
  

  <p class="text-muted mt-3">
    <a class="text-muted" href="https://willschenk.com/articles/2018/image_manipulation_in_firebase/">Published November 23, 2018</a>

    
      <a class="text-muted" href="../../../tags/firebase">#firebase</a>
    
      <a class="text-muted" href="../../../tags/howto">#howto</a>
    
      <a class="text-muted" href="../../../tags/javascript">#javascript</a>
    
      <a class="text-muted" href="../../../tags/images">#images</a>
    
  </p>

  

  <article class="article mt-5">
    

<p>We can manipulate images using JavaScript directly, which can be run both on the server or browser environment.  Lets take a look at how we&rsquo;d do this using create-react-app and firebase.  We will deploy a function on firebase that will download the user&rsquo;s avatar, manipulate the image and overlay it with a mask, and then spit out an image.</p>

<h2 id="project-setup">Project Setup</h2>

<p>First make sure that you have <code>nvm</code> installed.  We&rsquo;ll need a different version of node for <code>create-react-app</code> then we will for firebase functions.</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">$ npx create-react-app honey
$ <span class="nb">cd</span> honey
$ firebase login
$ firebase init</code></pre></div>
<ul>
<li>Select functions, hosting</li>
<li>Select your proejct if you&rsquo;ve already created it</li>
<li>JavaScript</li>
<li>Yes to ESLint</li>
<li>No to install dependancies</li>
<li><code>build</code> instead of <code>public</code> directory</li>
<li>Yes to single page app</li>
</ul>

<p>Now we will create our functions to generate the image.  Firebase only supports node 6, so we&rsquo;ll need to set that up.  If you don&rsquo;t already have node 6 installed, make sure you do that with <code>nvm install 6</code>.</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">$ <span class="nb">cd</span> functions
$ nvm use <span class="m">6</span>
$ npm install firebase-functions@latest firebase-admin@latest express jimp tempfile node-fetch blueimp-md5 --save</code></pre></div>
<p>Since that&rsquo;s installing another <code>node_modules</code> directory inside of the <code>functions</code> folder, be sure to add that to <code>.gitignore</code> in the project root:</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="nb">echo</span> /functions/node_modules &gt;&gt; ../.gitignore</code></pre></div>
<h2 id="write-and-test-our-function">Write and test our function</h2>

<p>We are going to combine an avatar.jpg like this:</p>

<p><img src="avatar.jpg"/></p>

<p>with a mask image like this:</p>

<div><span style="background:#aaa;height:480px;width:480px;display:inline-block"><img src="results_mask.png"/></span></div>

<p>to make an image like this:</p>

<p><img src="output.png"/></p>

<p>So right click and save the two images <code>avatar.jpg</code> and <code>results_mask.png</code> into your <code>functions</code> directory.  Then create the <code>functions/applyMask.js</code>:</p>
<div class="highlight"><pre class="chroma"><code class="language-js" data-lang="js"><span class="k">const</span> <span class="nx">Jimp</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span> <span class="s1">&#39;jimp&#39;</span> <span class="p">)</span>
<span class="k">const</span> <span class="nx">Tempfile</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span> <span class="s1">&#39;tempfile&#39;</span> <span class="p">)</span>

<span class="kd">var</span> <span class="nx">maskFile</span> <span class="o">=</span> <span class="nx">__dirname</span><span class="o">+</span><span class="s2">&#34;/results_mask.png&#34;</span><span class="p">;</span>

<span class="kd">var</span> <span class="nx">font</span> <span class="o">=</span> <span class="nx">Jimp</span><span class="p">.</span><span class="nx">loadFont</span><span class="p">(</span> <span class="nx">Jimp</span><span class="p">.</span><span class="nx">FONT_SANS_32_WHITE</span> <span class="p">);</span>

<span class="kd">function</span> <span class="nx">applyMask</span><span class="p">(</span> <span class="nx">text</span><span class="p">,</span> <span class="nx">avatarFile</span> <span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">Jimp</span><span class="p">.</span><span class="nx">read</span><span class="p">(</span> <span class="nx">maskFile</span> <span class="p">).</span><span class="nx">then</span><span class="p">(</span> <span class="p">(</span><span class="nx">mask</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">Jimp</span><span class="p">.</span><span class="nx">read</span><span class="p">(</span> <span class="nx">avatarFile</span> <span class="p">).</span><span class="nx">then</span><span class="p">(</span> <span class="p">(</span><span class="nx">image</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">Jimp</span><span class="p">.</span><span class="nx">loadFont</span><span class="p">(</span> <span class="nx">Jimp</span><span class="p">.</span><span class="nx">FONT_SANS_32_WHITE</span> <span class="p">).</span><span class="nx">then</span><span class="p">(</span> <span class="p">(</span><span class="nx">font</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">original</span> <span class="o">=</span> <span class="nx">image</span><span class="p">.</span><span class="nx">clone</span><span class="p">()</span>
        <span class="nx">original</span><span class="p">.</span><span class="nx">resize</span><span class="p">(</span> <span class="mi">215</span><span class="p">,</span> <span class="mi">215</span> <span class="p">)</span> <span class="c1">// Resize clean avatar to fit in the circle
</span><span class="c1"></span>
        <span class="nx">image</span><span class="p">.</span><span class="nx">resize</span><span class="p">(</span> <span class="mi">480</span><span class="p">,</span> <span class="mi">480</span> <span class="p">)</span> <span class="c1">// Resize avatar to fill larger square
</span><span class="c1"></span>        <span class="nx">image</span><span class="p">.</span><span class="nx">blur</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="c1">// Blur it
</span><span class="c1"></span>        <span class="nx">image</span><span class="p">.</span><span class="nx">color</span><span class="p">(</span> <span class="p">[{</span> <span class="nx">apply</span><span class="o">:</span> <span class="s1">&#39;darken&#39;</span><span class="p">,</span> <span class="nx">params</span><span class="o">:</span> <span class="p">[</span><span class="mi">60</span><span class="p">]}]</span> <span class="p">)</span> <span class="c1">// Darken the blurred colors
</span><span class="c1"></span>
        <span class="c1">// Center point is 238, 275
</span><span class="c1"></span>        <span class="c1">// Write the clean avatar into the &#34;center&#34; of the circle
</span><span class="c1"></span>        <span class="nx">image</span><span class="p">.</span><span class="nx">composite</span><span class="p">(</span> <span class="nx">original</span><span class="p">,</span> <span class="mi">238</span> <span class="o">-</span> <span class="p">(</span><span class="nx">original</span><span class="p">.</span><span class="nx">bitmap</span><span class="p">.</span><span class="nx">width</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span> <span class="mi">275</span> <span class="o">-</span> <span class="p">(</span><span class="nx">original</span><span class="p">.</span><span class="nx">bitmap</span><span class="p">.</span><span class="nx">height</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span> <span class="p">[</span><span class="nx">Jimp</span><span class="p">.</span><span class="nx">BLEND_DESTINATION_OVER</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="p">)</span>
        <span class="c1">// Write the mask on top
</span><span class="c1"></span>        <span class="nx">image</span><span class="p">.</span><span class="nx">composite</span><span class="p">(</span> <span class="nx">mask</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">[</span><span class="nx">Jimp</span><span class="p">.</span><span class="nx">BLEND_DESTINATION_OVER</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>

        <span class="c1">// Write the text onto the image fitting it into the box
</span><span class="c1"></span>        <span class="c1">// top left 156, 400 and 175 pixel across and 30 down
</span><span class="c1"></span>        <span class="nx">image</span><span class="p">.</span><span class="nx">print</span><span class="p">(</span> <span class="nx">font</span><span class="p">,</span> <span class="mi">156</span><span class="p">,</span> <span class="mi">400</span><span class="p">,</span> <span class="p">{</span>
          <span class="nx">text</span><span class="o">:</span> <span class="nx">text</span><span class="p">,</span>
          <span class="nx">alignmentX</span><span class="o">:</span> <span class="nx">Jimp</span><span class="p">.</span><span class="nx">HORIZONTAL_ALIGN_CENTER</span><span class="p">,</span>
          <span class="nx">alignmentY</span><span class="o">:</span> <span class="nx">Jimp</span><span class="p">.</span><span class="nx">VERTICAL_ALIGN_MIDDLE</span>
        <span class="p">},</span> <span class="mi">175</span><span class="p">,</span> <span class="mi">30</span><span class="p">);</span>

        <span class="kd">var</span> <span class="nx">outputFile</span> <span class="o">=</span> <span class="nx">Tempfile</span><span class="p">(</span> <span class="s2">&#34;.png&#34;</span> <span class="p">);</span>
        <span class="k">return</span> <span class="nx">image</span><span class="p">.</span><span class="nx">writeAsync</span><span class="p">(</span> <span class="nx">outputFile</span> <span class="p">).</span><span class="nx">then</span><span class="p">(</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">outputFile</span><span class="p">}</span> <span class="p">);</span>
      <span class="p">}</span> <span class="p">)</span>
    <span class="p">}</span> <span class="p">)</span>
  <span class="p">}</span> <span class="p">)</span>
<span class="p">}</span>

<span class="k">if</span><span class="p">(</span> <span class="nx">process</span><span class="p">.</span><span class="nx">argv</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">===</span> <span class="s1">&#39;--test&#39;</span> <span class="p">)</span> <span class="p">{</span>
  <span class="nx">applyMask</span><span class="p">(</span> <span class="s2">&#34;Will S&#34;</span><span class="p">,</span> <span class="nx">__dirname</span><span class="o">+</span><span class="s2">&#34;/avatar.jpg&#34;</span> <span class="p">)</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">(</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="p">)</span>
    <span class="p">.</span><span class="k">catch</span><span class="p">(</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="p">)</span>
<span class="p">}</span>

<span class="nx">exports</span><span class="p">.</span><span class="nx">applyMask</span> <span class="o">=</span> <span class="nx">applyMask</span>
</code></pre></div>
<p>We can test this function using <code>node avatarMask.js --test</code>, this will run the method directly so we can test out the results and print the output filename.  To open that file directly, you can do <code>open $(node avatarMask.js --test)</code></p>

<p>This uses Jimp to:</p>

<ol>
<li>Load in the mask using <code>Jimp.read</code></li>
<li>Load in the avatar again using <code>Jimp.read</code></li>
<li>Load in a font file that we will use for running</li>
<li>Clone the original image</li>
<li>Resize, blur and darken the avatar</li>
<li>Copy the original avatar onto the center point at 238, 275</li>
<li>Apply the mask on top</li>
<li>Write the user&rsquo;s name into the attached box</li>
<li>Create a tempfile to write the final image into</li>
<li>Resolve the promise at the end with the name of the tempfile.</li>
</ol>

<p>The <code>Jimp</code> library is written in pure JavaScript so this code should be runnable in the browser also with some limited modifications.</p>

<h2 id="write-a-firebase-function-that-returns-the-image">Write a Firebase function that returns the image</h2>

<p>Lets first create a simple express function just to make sure that we can get the firebase functions to run inside of the emulator and attach to a https handler.</p>

<p>In <code>functions/index.js</code>:</p>
<div class="highlight"><pre class="chroma"><code class="language-js" data-lang="js"><span class="k">const</span> <span class="nx">functions</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;firebase-functions&#39;</span><span class="p">);</span>
<span class="k">const</span> <span class="nx">express</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;express&#39;</span><span class="p">);</span>

<span class="k">const</span> <span class="nx">webApp</span> <span class="o">=</span> <span class="nx">express</span><span class="p">();</span>

<span class="nx">webApp</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span> <span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span> <span class="s2">&#34;Hello world&#34;</span><span class="p">)</span>
<span class="p">})</span>

<span class="nx">exports</span><span class="p">.</span><span class="nx">createImage</span> <span class="o">=</span> <span class="nx">functions</span><span class="p">.</span><span class="nx">https</span><span class="p">.</span><span class="nx">onRequest</span><span class="p">(</span> <span class="nx">webApp</span> <span class="p">)</span>
</code></pre></div>
<p>The run</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">$ npm run serve</code></pre></div>
<p>To run the function locally.  If it starts up correctly, you should see an <code>localhost</code> url that you can use, in my case <code>http://localhost:5000/honey-b6642/us-central1/createImage/</code></p>

<p>Once that works, lets actually wire up our function to use our method (again this is <code>functions/index.js</code>)</p>
<div class="highlight"><pre class="chroma"><code class="language-js" data-lang="js"><span class="k">const</span> <span class="nx">functions</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;firebase-functions&#39;</span><span class="p">);</span>
<span class="k">const</span> <span class="nx">express</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;express&#39;</span><span class="p">);</span>
<span class="k">const</span> <span class="p">{</span> <span class="nx">applyMask</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./merge&#39;</span><span class="p">);</span>

<span class="k">const</span> <span class="nx">webApp</span> <span class="o">=</span> <span class="nx">express</span><span class="p">();</span>

<span class="nx">webApp</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span> <span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span> <span class="s2">&#34;Generating image&#34;</span><span class="p">)</span>
  <span class="nx">applyMask</span><span class="p">(</span> <span class="s2">&#34;Will S&#34;</span><span class="p">,</span> <span class="nx">__dirname</span><span class="o">+</span><span class="s2">&#34;/avatar.jpg&#34;</span> <span class="p">).</span><span class="nx">then</span><span class="p">(</span> <span class="p">(</span><span class="nx">tempfile</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span> <span class="s2">&#34;Uploading file&#34;</span><span class="p">,</span> <span class="nx">tempfile</span><span class="p">)</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">sendFile</span><span class="p">(</span> <span class="nx">tempfile</span> <span class="p">)</span>
  <span class="p">}).</span><span class="k">catch</span><span class="p">(</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span> <span class="nx">err</span> <span class="p">)</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span> <span class="p">{</span><span class="nx">error</span><span class="o">:</span> <span class="nx">err</span><span class="p">})</span>
  <span class="p">}</span> <span class="p">)</span>
<span class="p">})</span>

<span class="nx">exports</span><span class="p">.</span><span class="nx">createImage</span> <span class="o">=</span> <span class="nx">functions</span><span class="p">.</span><span class="nx">https</span><span class="p">.</span><span class="nx">onRequest</span><span class="p">(</span> <span class="nx">webApp</span> <span class="p">)</span>
</code></pre></div>
<p>Again test with <code>node run serve</code>.  When you go the url, you should now see the image in the browser!</p>

<h2 id="check-to-see-that-it-works-on-firebase-itself">Check to see that it works on firebase itself</h2>

<p><code>firebase deploy</code> will push the code to the firebase servers.  If you don&rsquo;t get any errors, you can see where the function is deployed either in the output logs, or by going to the <a href="https://console.firebase.google.com">Firebase Console</a> and click on the <code>Functions</code> tab:</p>

<p><img src="functions.png" class="img-fluid"/></p>

<p>If you go to that url, <a href="https://us-central1-honey-b6642.cloudfunctions.net/createImage/">https://us-central1-honey-b6642.cloudfunctions.net/createImage/</a> in the image above, (add a / at the end if you have a problem) you should see the image generated and loaded from the firebase function.</p>

<h2 id="passing-in-the-email-and-name-and-loading-from-gravatar">Passing in the email and name and loading from gravatar</h2>

<p>Lets change the code a bit to pass in the email and name, load the avatar from gravatar, and customize the image:</p>
<div class="highlight"><pre class="chroma"><code class="language-js" data-lang="js"><span class="k">const</span> <span class="nx">functions</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;firebase-functions&#39;</span><span class="p">);</span>
<span class="k">const</span> <span class="nx">express</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;express&#39;</span><span class="p">);</span>
<span class="k">const</span> <span class="p">{</span> <span class="nx">applyMask</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./applyMask&#39;</span><span class="p">);</span>
<span class="k">const</span> <span class="nx">Tempfile</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;tempfile&#39;</span><span class="p">)</span>
<span class="k">const</span> <span class="nx">fetch</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;node-fetch&#39;</span><span class="p">)</span>
<span class="k">const</span> <span class="nx">md5</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;blueimp-md5&#39;</span><span class="p">)</span>
<span class="k">const</span> <span class="nx">fs</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;fs&#39;</span><span class="p">)</span>

<span class="k">const</span> <span class="nx">webApp</span> <span class="o">=</span> <span class="nx">express</span><span class="p">();</span>

<span class="kd">function</span> <span class="nx">downloadGravatar</span><span class="p">(</span> <span class="nx">email</span> <span class="p">)</span> <span class="p">{</span>
  <span class="k">const</span> <span class="nx">hash</span> <span class="o">=</span> <span class="nx">md5</span><span class="p">(</span><span class="nx">email</span><span class="p">);</span>
  <span class="k">return</span> <span class="nx">downloadUrl</span><span class="p">(</span><span class="s2">&#34;https://www.gravatar.com/avatar/&#34;</span> <span class="o">+</span> <span class="nx">hash</span> <span class="o">+</span> <span class="s2">&#34;.jpg&#34;</span> <span class="p">)</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">downloadUrl</span><span class="p">(</span> <span class="nx">url</span> <span class="p">)</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span> <span class="s2">&#34;downloading &#34;</span> <span class="o">+</span> <span class="nx">url</span> <span class="p">)</span>
  <span class="k">return</span> <span class="nx">fetch</span><span class="p">(</span> <span class="nx">url</span> <span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="nx">res</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="k">const</span> <span class="nx">outputFile</span> <span class="o">=</span> <span class="nx">Tempfile</span><span class="p">(</span> <span class="s2">&#34;.jpg&#34;</span> <span class="p">)</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span> <span class="s2">&#34;Streaming to &#34;</span><span class="p">,</span> <span class="nx">outputFile</span> <span class="p">)</span>
    <span class="k">const</span> <span class="nx">dest</span> <span class="o">=</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">createWriteStream</span><span class="p">(</span><span class="nx">outputFile</span><span class="p">);</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">dest</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">outputFile</span><span class="p">;</span>
  <span class="p">});</span>
<span class="p">}</span>

<span class="nx">webApp</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span> <span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="k">const</span> <span class="nx">email</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">query</span><span class="p">.</span><span class="nx">email</span><span class="p">;</span>
  <span class="kd">let</span> <span class="nx">name</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">query</span><span class="p">.</span><span class="nx">name</span><span class="p">;</span>

  <span class="k">if</span><span class="p">(</span> <span class="nx">email</span> <span class="o">===</span> <span class="s2">&#34;&#34;</span> <span class="o">||</span> <span class="nx">email</span> <span class="o">===</span> <span class="kc">undefined</span> <span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">404</span><span class="p">).</span><span class="nx">send</span><span class="p">(</span> <span class="s2">&#34;Email not passed in&#34;</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="k">if</span><span class="p">(</span> <span class="nx">name</span> <span class="o">===</span> <span class="s2">&#34;&#34;</span> <span class="o">||</span> <span class="nx">name</span> <span class="o">===</span> <span class="kc">undefined</span> <span class="p">)</span> <span class="p">{</span>
    <span class="nx">name</span> <span class="o">=</span> <span class="nx">email</span>
  <span class="p">}</span>

  <span class="nx">downloadGravatar</span><span class="p">(</span> <span class="nx">email</span> <span class="p">).</span><span class="nx">then</span><span class="p">(</span> <span class="p">(</span><span class="nx">avatarFile</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">applyMask</span><span class="p">(</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">avatarFile</span> <span class="p">)</span>
  <span class="p">}</span> <span class="p">).</span><span class="nx">then</span><span class="p">(</span> <span class="p">(</span><span class="nx">tempfile</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span> <span class="s2">&#34;Uploading file &#34;</span> <span class="o">+</span> <span class="nx">tempfile</span> <span class="p">)</span>
    <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">sendFile</span><span class="p">(</span> <span class="nx">tempfile</span> <span class="p">)</span>
  <span class="p">}).</span><span class="k">catch</span><span class="p">(</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span> <span class="nx">err</span> <span class="p">)</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span> <span class="p">{</span><span class="nx">error</span><span class="o">:</span> <span class="nx">err</span><span class="p">})</span>
  <span class="p">}</span> <span class="p">)</span>
<span class="p">})</span>

<span class="nx">exports</span><span class="p">.</span><span class="nx">createImage</span> <span class="o">=</span> <span class="nx">functions</span><span class="p">.</span><span class="nx">https</span><span class="p">.</span><span class="nx">onRequest</span><span class="p">(</span> <span class="nx">webApp</span> <span class="p">)</span>
</code></pre></div>
<p>Then start up your local firebase function with <code>npm run serve</code> and test it out with an email and name, for example: <a href="http://localhost:5000/honey-b6642/us-central1/createImage?email=wschenk@gmail.com&amp;name=Will+S">http://localhost:5000/honey-b6642/us-central1/createImage?email=wschenk@gmail.com&amp;name=Will+S</a></p>

<p>Finally, deploy it all to firebase!</p>

<pre><code>$ firebase deploy
</code></pre>

<p>The final code can be found <a href="https://github.com/wschenk/image_building_in_firebase">https://github.com/wschenk/image_building_in_firebase</a></p>

<hr />

<p>References</p>

<ol>
<li><a href="https://github.com/wschenk/image_building_in_firebase">https://github.com/wschenk/image_building_in_firebase</a></li>
<li><a href="https://github.com/oliver-moran/jimp">https://github.com/oliver-moran/jimp</a></li>
<li><a href="https://medium.com/@rossbulat/image-processing-in-nodejs-with-jimp-174f39336153">https://medium.com/@rossbulat/image-processing-in-nodejs-with-jimp-174f39336153</a></li>
<li><a href="https://stackoverflow.com/questions/43117124/how-to-read-local-files-in-the-google-cloud-functions-emulator">https://stackoverflow.com/questions/43117124/how-to-read-local-files-in-the-google-cloud-functions-emulator</a></li>
<li><a href="https://en.gravatar.com/site/implement/images/">https://en.gravatar.com/site/implement/images/</a></li>
</ol>

  </article>
</div>


  <div class="bg-light py-5">
    <div class="container">
      <h2 class="text-center">Read next</h2>

      <div class="row">
        <div class="col-md-6 text-center">
          
            Next Post:
            <a href="../../../articles/2019/setting_up_ipfs_on_chromebook/">Setting up IPFS on a chromebook</a>
          
        </div>
        <div class="col-md-6 text-center">
          
            Previous Post:
            <a href="../../../articles/2018/implementing_serverless_oauth/">Implementing Serverless OAuth</a>
          
        </div>
      </div>
    </div>
  </div>




<div class="container mt-5">
  <h2 class="text-center">See also</h2>
  <div class="row">
  	
      <div class="col-md mb-3">
        <p class="lead mb-0"><a class="text-body" href="../../../articles/2018/implementing_serverless_oauth/">Implementing Serverless OAuth</a></p>

        
          <p class="lead font-italic mb-0">for JAM Stacks and static sites</p>
        
        <p class="font-weight-light mt-3">Most of the serverless platforms have their own forms of authentication, but it might not support the specific service that you are looking to use. Lets go through how we can build a react single page app, hosting on firebase, that talks to the unsplash service directly. It will be hosted on firebase stoage, and with a tiny bit of firebase functions to tie it together.
How oauth works Here is the overall process:</p>
        <a href="../../../articles/2018/implementing_serverless_oauth/" class="btn btn-primary">Read more</a>
      </div>
    
      <div class="col-md mb-3">
        <p class="lead mb-0"><a class="text-body" href="../../../articles/2018/adding_facebook_login_with_react/">Adding Facebook Login with react</a></p>

        
          <p class="lead font-italic mb-0">you can&rsquo;t escape it</p>
        
        <p class="font-weight-light mt-3">Sometimes you just can&rsquo;t get away from facebook. Here&rsquo;s a quick tutorial on how to add facebook login to your react app.
First you need to create a facebook app, which is an involved process especially if you want to let, you know, other people log in to your app. Getting your app approved and otherwise up and running here is left as an excersize for you to figure out.</p>
        <a href="../../../articles/2018/adding_facebook_login_with_react/" class="btn btn-primary">Read more</a>
      </div>
    
      <div class="col-md mb-3">
        <p class="lead mb-0"><a class="text-body" href="../../../articles/2018/automating_hugo_with_circleci/">Automating hugo builds using CircleCI</a></p>

        
          <p class="lead font-italic mb-0">Let someone else run your build server</p>
        
        <p class="font-weight-light mt-3"><p class="lead">Here's a simple CircleCI configuration to pull down the latest version of your hugo site on GitHub commits, build it, and then push it to github pages.</p></p>
        <a href="../../../articles/2018/automating_hugo_with_circleci/" class="btn btn-primary">Read more</a>
      </div>
    
  </div>
</div>


<footer class="footer bg-dark text-light mt-3">
  <div class="container">
    <h2 class="py-5 font-weight-light my-0">Made in Brooklyn, NY.</h2>
  </div>
</footer>
</body>
</html>
