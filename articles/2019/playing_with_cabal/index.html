<!DOCTYPE html>
<html><head>
  <title>Playing with cabal</title>
  
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../../css/theme.css"/>
  <link rel="stylesheet" href="../../../css/syntax.css"/>

  
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-56296045-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

  <meta property="og:title" content="Playing with cabal" />
<meta property="og:description" content="Cabal is a &ldquo;experimental p2p community chat platform&rdquo;. It&rsquo;s fully distributed over the dat protocol. When you create a new chat area &ndash; something like a Slack &ndash; it allows anyone with the same key to post and view messages everywhere. When you post a message, everyone gets it and shares it with everyone else, so even when your computer drops off there will still be a coherent view of the data." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://willschenk.com/articles/2019/playing_with_cabal/" />
<meta property="article:published_time" content="2019-04-23T00:00:00&#43;00:00"/>
<meta property="article:modified_time" content="2019-04-23T00:00:00&#43;00:00"/>

  <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Playing with cabal"/>
<meta name="twitter:description" content="Cabal is a &ldquo;experimental p2p community chat platform&rdquo;. It&rsquo;s fully distributed over the dat protocol. When you create a new chat area &ndash; something like a Slack &ndash; it allows anyone with the same key to post and view messages everywhere. When you post a message, everyone gets it and shares it with everyone else, so even when your computer drops off there will still be a coherent view of the data."/>
<meta name="twitter:site" content="@wschenk"/>


  <style>
    .article p, .article ul, .article ol, .article table {
      max-width: 45em;
    }

    article.article p:first-child, .article blockquote {
      font-size: 1.25em;
      font-weight: 300;
      max-width: 36em;  
    }
  </style>
</head>
<body><nav class="container my-5">
  <h1 class="pt-md-5 display-3"><a class="text-dark" href="../../../">Will Schenk</a></h1>
  <p>
    
      <a class="text-dark h4 mr-3 font-weight-light" href="../../../articles/" title="">Articles</a>
    
      <a class="text-dark h4 mr-3 font-weight-light" href="../../../contact" title="">Contact</a>
    
      <a class="text-dark h4 mr-3 font-weight-light" href="../../../tags/" title="">Tags</a>
    
    <a href="../../../feed.xml" class="mr-3 h4 text-light"><img src="../../../img/rss.svg" alt="rss" height="20" width="20"/></a>
    
      <a href="https://twitter.com/@wschenk" class="mr-3 h4 text-light"><img src="../../../img/twitter.svg" alt="twitter" height="20" width="20"/></a>
    
    
      <a href="https://instagram.com/wschenk" class="mr-3 h4 text-light"><img src="../../../img/instagram.svg" alt="instagram" height="20" width="20"/></a>
    
    
      <a href="https://github.com/wschenk" class="mr-3 h4 text-light"><img src="../../../img/github.svg" alt="github" height="20" width="20"/></a>
    
    
      <a href="https://linkedin.com/in/will-schenk-420266" class="mr-3 h4 text-light"><img src="../../../img/linkedin.svg" alt="linkedin" height="20" width="20"/></a>
    
  </p>
</nav>

<div class="container">
  <h1 class="mt-5">Playing with cabal</h1>

  
    <h2 class="font-weight-light font-italic mb-3">serverless code</h2>
  

  <p class="text-muted mt-3">
    <a class="text-muted" href="https://willschenk.com/articles/2019/playing_with_cabal/">Published April 23, 2019</a>

    
      <a class="text-muted" href="../../../tags/p2p">#p2p</a>
    
      <a class="text-muted" href="../../../tags/node">#node</a>
    
      <a class="text-muted" href="../../../tags/cabal">#cabal</a>
    
  </p>

  

  
  <div class="alert alert-secondary">The code from this article can be found at <a href="https://github.com/wschenk/cabal-experiments">https://github.com/wschenk/cabal-experiments</a></div>
  

  <article class="article mt-5">
    

<p>Cabal is a &ldquo;experimental p2p community chat platform&rdquo;.  It&rsquo;s fully distributed over the <a href="https://www.datprotocol.com/">dat protocol</a>.  When you create a new chat area &ndash; something like a Slack &ndash; it allows anyone with the same key to post and view messages everywhere.  When you post a message, everyone gets it and shares it with everyone else, so even when your computer drops off there will still be a coherent view of the data.</p>

<h2 id="local-computer">Local computer</h2>

<p>You&rsquo;ll need at last two computers to really play with this.  But we can simulate the situation by running a docker container as well as a local instance of the cabal cli client.  We can then move that container (or at least the image) around to run it on a remote server if you don&rsquo;t want to mess with anything on the remote machine.  Lets first install it locally:</p>

<h2 id="on-the-terminal">On the terminal</h2>

<p>If you just want to play around you can use <code>npx</code>, or install the cabal cli command using <code>npm install --global cabal</code>.  Either way, lets start up a new cabal chat.</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">npx cabal --new</code></pre></div>
<p>Take a note of the cabal URI on the top right of the screen, we&rsquo;ll use that to connect with later.  Keep this window running and start up a new Terminal window.  Type in a test message such as &ldquo;this is the first message&rdquo; (or something less banal).  There are also slash commands available, <code>/help</code> will list them.  Change your display nickname with <code>/n local node</code> or something like that.</p>

<h2 id="dockerizing">Dockerizing</h2>

<p>This is optional, you can just repeat the same steps on the remote node if you want.  I have this in a Docker container because I don&rsquo;t want to install node on my remote server, but if you have you computers and aren&rsquo;t anal about it its super simple to just install node and just run <code>npx cabal</code> on them also.</p>

<p>I like keeping things in Docker containers when playing around so that no unnecessary packages get installed on the machine and the data files are nicely cleaned up when I exit out.</p>

<p>This is a very basic node-based Dockerfile.  Cabal/Dat uses port <code>3282</code> to communicate, so we&rsquo;ll need to expose and open that.</p>

<p><a href="Dockerfile"><code>Dockerfile</code></a></p>

<div class="highlight"><pre class="chroma"><code class="language-Dockerfile" data-lang="Dockerfile"><span class="k">FROM</span><span class="s"> node:11</span><span class="err">
</span><span class="err"></span><span class="k">MAINTAINER</span><span class="s"> Will Schenk &lt;wschenk@gmail.com&gt;</span><span class="err">
</span><span class="err">
</span><span class="err"></span><span class="k">EXPOSE</span><span class="s"> 3282</span><span class="err">
</span><span class="err">
</span><span class="err"></span>USER root<span class="err">
</span><span class="err"></span><span class="k">RUN</span> npm install -g cabal<span class="err">
</span><span class="err">
</span><span class="err"></span><span class="k">CMD</span><span class="s"> cabal</span></code></pre></div>

<p>Then build like so:</p>

<pre><code>docker build . -t $USER/cabal
</code></pre>

<p>Create a simple script to make it easier to run in the future.  (Note I&rsquo;m using <code>--network host</code> here because I was having trouble getting dat to punch through the Docker networking/NAT stuff.)</p>

<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="cp">#!/bin/bash
</span><span class="cp"></span>
docker run -it --rm --name cabal --network host wschenk/cabal cabal <span class="s2">&#34;</span><span class="nv">$@</span><span class="s2">&#34;</span></code></pre></div>

<p>This script is for running one off commands, and it throws away the container each time so you&rsquo;ll lose the history.  If you really wanted to use this for something more than an experiment you should mount the internal <code>/root/.cabal</code> directory to a docker volume and/or not make it a temporary container.</p>

<p>Push the container to the repository using <code>docker push $USER/cabal</code>, and then move everything to a different computer.  Then run:</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">bash run.sh cabal://f6e83732c84fe310515fe7162376e5420c6f4a27d015094ccc22be658b62d3c8</code></pre></div>
<p>If all goes well, after a few moments of network dancing you should be able to see the original message you sent.  Type away to see if things show up!</p>

<h2 id="using-cabal-core-in-code">Using <code>cabal-core</code> in code</h2>

<p>That&rsquo;s super cool already, but lets go a little deep and start writing our own handlers to see what we can do with <code>cabal</code> programmaticly.  <code>cabal</code> isn&rsquo;t secure at all so we probably shouldn&rsquo;t use this for anything real, but its a nifty way to communicate and discover without having to setup very much at all!</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">npm init
yarn add cabal-core tmp delay</code></pre></div>
<h2 id="printing-out-everything-that-is-in-a-swarm">Printing out everything that is in a swarm</h2>

<ol>
<li>First we create a <code>Cabal</code> instance with a storage directory and our key, using <code>cabel = Cabal(directoy,key)</code></li>
<li>Then we connect it to the swarm to start replicating using <code>swarm(cabal)</code></li>
<li>Once the local database has been loaded and processed, the <code>cabal.db.ready()</code> callback is called.  Events received after this are new.</li>
<li>We can watch peers join and disconnect using <code>cabal.on('peer-added')</code> and <code>cabal.on('peer-dropped')</code></li>
<li>We can listen for new messages and topics using <code>cabal.messages.events.on('message')</code></li>
<li>(We can also listen for messages just in a specific channel, not shown below)</li>
<li>We can listen for new channels <code>cabal.channels.events.on( 'add' )</code></li>
<li>We can get a current channel list using <code>cabal.channels.get()</code></li>
<li>We can listen for new nicknames using <code>cabal.users.events.on('update')</code></li>
</ol>

<p>Here&rsquo;s it in code form <a href="read.js"><code>dump.js</code></a>:</p>

<div class="highlight"><pre class="chroma"><code class="language-js" data-lang="js"><span class="k">const</span> <span class="nx">Cabal</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;cabal-core&#39;</span><span class="p">);</span>
<span class="k">const</span> <span class="nx">swarm</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;cabal-core/swarm.js&#39;</span><span class="p">);</span>
<span class="k">const</span> <span class="nx">tmp</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;tmp&#39;</span><span class="p">);</span>

<span class="k">if</span><span class="p">(</span> <span class="nx">process</span><span class="p">.</span><span class="nx">argv</span><span class="p">.</span><span class="nx">length</span> <span class="o">!=</span> <span class="mi">3</span> <span class="p">)</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span> <span class="s2">&#34;Usage&#34;</span> <span class="p">)</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span> <span class="s2">&#34;node dump.js cabalkey&#34;</span><span class="p">)</span>
  <span class="nx">process</span><span class="p">.</span><span class="nx">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// Strip out the awesome
</span><span class="c1"></span><span class="k">const</span> <span class="nx">key</span> <span class="o">=</span>  <span class="nx">process</span><span class="p">.</span><span class="nx">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="nx">replace</span><span class="p">(</span><span class="s1">&#39;cabal://&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">).</span><span class="nx">replace</span><span class="p">(</span><span class="s1">&#39;cbl://&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">).</span><span class="nx">replace</span><span class="p">(</span><span class="s1">&#39;dat://&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">).</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\//g</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span> <span class="s2">&#34;Connecting to&#34;</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span>

<span class="c1">// For testing to keep things clean
</span><span class="c1"></span><span class="k">const</span> <span class="nx">storage_dir</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">CABAL_DIR</span> <span class="o">||</span> <span class="nx">tmp</span><span class="p">.</span><span class="nx">dirSync</span><span class="p">().</span><span class="nx">name</span><span class="p">;</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span> <span class="s2">&#34;Storing our database in&#34;</span><span class="p">,</span> <span class="nx">storage_dir</span><span class="p">);</span>

<span class="c1">// Create a cabal instance
</span><span class="c1"></span><span class="k">const</span> <span class="nx">cabal</span> <span class="o">=</span> <span class="nx">Cabal</span><span class="p">(</span> <span class="nx">storage_dir</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="p">{</span><span class="nx">maxFeeds</span><span class="o">:</span><span class="mi">1000</span><span class="p">}</span> <span class="p">)</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span> <span class="s2">&#34;Connecting to swarm&#34;</span><span class="p">)</span>
<span class="nx">swarm</span><span class="p">(</span><span class="nx">cabal</span><span class="p">);</span>

<span class="c1">// This is called after the local database is loaded
</span><span class="c1"></span><span class="nx">cabal</span><span class="p">.</span><span class="nx">db</span><span class="p">.</span><span class="nx">ready</span><span class="p">(</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span> <span class="s2">&#34;Database is ready!&#34;</span><span class="p">)})</span>

<span class="c1">// Print out connect and disconnect messages
</span><span class="c1"></span><span class="nx">cabal</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;peer-added&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">key</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span> <span class="s2">&#34;Peer added&#34;</span><span class="p">,</span>  <span class="nx">key</span> <span class="p">)</span> <span class="p">);</span>
<span class="nx">cabal</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;peer-dropped&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">key</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span> <span class="s2">&#34;Peer dropped&#34;</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span> <span class="p">);</span>

<span class="c1">// Prints messages as they come in
</span><span class="c1"></span><span class="nx">cabal</span><span class="p">.</span><span class="nx">messages</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;message&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">message</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;Got a message&#34;</span><span class="p">,</span> <span class="nx">message</span><span class="p">))</span>

<span class="c1">// Print user messages as they come in
</span><span class="c1"></span><span class="nx">cabal</span><span class="p">.</span><span class="nx">users</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;update&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">message</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span> <span class="s2">&#34;user message&#34;</span><span class="p">,</span> <span class="nx">message</span> <span class="p">))</span>

<span class="c1">// Print out channel list
</span><span class="c1"></span><span class="nx">cabal</span><span class="p">.</span><span class="nx">channels</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span><span class="nx">channels</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span> <span class="s2">&#34;Channels&#34;</span><span class="p">,</span> <span class="nx">channels</span><span class="p">))</span>
<span class="nx">cabal</span><span class="p">.</span><span class="nx">channels</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span> <span class="s1">&#39;add&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">channel</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span> <span class="s2">&#34;new channel&#34;</span><span class="p">,</span> <span class="nx">channel</span><span class="p">))</span>

<span class="c1">// Process will hang waiting for events
</span></code></pre></div>

<p>Now lets restart everything and see what happens!  When I start up <code>node dump.js key</code> on my machine, and then start up the <code>cabal-cli</code> client on the other machine and:</p>

<ol>
<li>Type <code>hello everyone</code></li>
<li>Type <code>/n Will</code> - change my nickname to Will</li>
<li>Type <code>This is my new name</code></li>
<li>Type <code>/join new channel</code></li>
<li>Type <code>lets talk about this instead</code></li>
<li>Type <code>/topic Serious Stuff</code></li>
<li>Type <code>/quit</code></li>
</ol>

<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">Connecting to f6e83732c84fe310515fe7162376e5420c6f4a27d015094ccc22be658b62d3c8
Storing our database in /tmp/tmp-5029E7feUNe8UiyB
Connecting to swarm
Database is ready!
Channels <span class="o">[]</span>
Peer added 6a4ed8b325acf3cb4a7c47625d0e66610ebc9be75b775e934efdb5440bb09097
new channel default
Got a message <span class="o">{</span> key:
   <span class="s1">&#39;6a4ed8b325acf3cb4a7c47625d0e66610ebc9be75b775e934efdb5440bb09097&#39;</span>,
  seq: <span class="m">0</span>,
  value:
   <span class="o">{</span> type: <span class="s1">&#39;chat/text&#39;</span>,
     content: <span class="o">{</span> channel: <span class="s1">&#39;default&#39;</span>, text: <span class="s1">&#39;hello everyone&#39;</span> <span class="o">}</span>,
     timestamp: <span class="m">1556023954404</span> <span class="o">}</span> <span class="o">}</span>
user message <span class="o">{</span> key:
   <span class="s1">&#39;6a4ed8b325acf3cb4a7c47625d0e66610ebc9be75b775e934efdb5440bb09097&#39;</span>,
  seq: <span class="m">1</span>,
  value:
   <span class="o">{</span> type: <span class="s1">&#39;about&#39;</span>,
     content: <span class="o">{</span> name: <span class="s1">&#39;Will&#39;</span> <span class="o">}</span>,
     timestamp: <span class="m">1556023961901</span> <span class="o">}</span> <span class="o">}</span>
Got a message <span class="o">{</span> key:
   <span class="s1">&#39;6a4ed8b325acf3cb4a7c47625d0e66610ebc9be75b775e934efdb5440bb09097&#39;</span>,
  seq: <span class="m">2</span>,
  value:
   <span class="o">{</span> type: <span class="s1">&#39;chat/text&#39;</span>,
     content: <span class="o">{</span> channel: <span class="s1">&#39;default&#39;</span>, text: <span class="s1">&#39;This is my new name&#39;</span> <span class="o">}</span>,
     timestamp: <span class="m">1556023967911</span> <span class="o">}</span> <span class="o">}</span>
new channel new channel
Got a message <span class="o">{</span> key:
   <span class="s1">&#39;6a4ed8b325acf3cb4a7c47625d0e66610ebc9be75b775e934efdb5440bb09097&#39;</span>,
  seq: <span class="m">3</span>,
  value:
   <span class="o">{</span> type: <span class="s1">&#39;chat/text&#39;</span>,
     content:
      <span class="o">{</span> channel: <span class="s1">&#39;new channel&#39;</span>, text: <span class="s1">&#39;lets talk about this instead&#39;</span> <span class="o">}</span>,
     timestamp: <span class="m">1556023978198</span> <span class="o">}</span> <span class="o">}</span>
Got a message <span class="o">{</span> key:
   <span class="s1">&#39;6a4ed8b325acf3cb4a7c47625d0e66610ebc9be75b775e934efdb5440bb09097&#39;</span>,
  seq: <span class="m">4</span>,
  value:
   <span class="o">{</span> type: <span class="s1">&#39;chat/topic&#39;</span>,
     content: <span class="o">{</span> channel: <span class="s1">&#39;new channel&#39;</span>, text: <span class="s1">&#39;Serious Stuff&#39;</span> <span class="o">}</span>,
     timestamp: <span class="m">1556023983080</span> <span class="o">}</span> <span class="o">}</span>
Peer dropped 6a4ed8b325acf3cb4a7c47625d0e66610ebc9be75b775e934efdb5440bb09097</code></pre></div>

<h2 id="publishing-a-message">Publishing a message</h2>

<p>Publishing a message involves appending to your local feed and then synchronizing to the swarm.  Which means waiting for the swarm to connect, a peer to join, and then them downloading everything.  We don&rsquo;t really know how long it will take, and there&rsquo;s no real way to guarantee that it will show up.  But we want a CLI tool that will eventually return, and not sit around forever.  Here&rsquo;s the logic we&rsquo;ll use:</p>

<ol>
<li>Initialize cabal and try to connect to the swarm</li>
<li>Post the message to the local store</li>
<li>Once we get a peer connect message, wait 2 seconds for syncing and return success</li>
<li>If we don&rsquo;t get a peer connect in 10 seconds, then exit with error code.</li>
</ol>

<p>Of course, if you just want to publish a message and serve the swarm forever, we could just take out the timeouts.</p>

<p><a href="publish.js"><code>publish.js</code></a>:</p>

<div class="highlight"><pre class="chroma"><code class="language-js" data-lang="js"><span class="k">const</span> <span class="nx">Cabal</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;cabal-core&#39;</span><span class="p">);</span>
<span class="k">const</span> <span class="nx">swarm</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;cabal-core/swarm.js&#39;</span><span class="p">);</span>
<span class="k">const</span> <span class="nx">delay</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;delay&#39;</span><span class="p">);</span>
<span class="k">const</span> <span class="nx">tmp</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;tmp&#39;</span><span class="p">);</span>

<span class="k">if</span><span class="p">(</span> <span class="nx">process</span><span class="p">.</span><span class="nx">argv</span><span class="p">.</span><span class="nx">length</span> <span class="o">!=</span> <span class="mi">5</span> <span class="p">)</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span> <span class="s2">&#34;Usage&#34;</span> <span class="p">)</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span> <span class="s2">&#34;node publish.js cabalkey channel message&#34;</span><span class="p">)</span>
  <span class="nx">process</span><span class="p">.</span><span class="nx">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// Strip out the awesome
</span><span class="c1"></span><span class="k">const</span> <span class="nx">key</span> <span class="o">=</span>  <span class="nx">process</span><span class="p">.</span><span class="nx">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="nx">replace</span><span class="p">(</span><span class="s1">&#39;cabal://&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">).</span><span class="nx">replace</span><span class="p">(</span><span class="s1">&#39;cbl://&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">).</span><span class="nx">replace</span><span class="p">(</span><span class="s1">&#39;dat://&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">).</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\//g</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span> <span class="s2">&#34;Connecting to&#34;</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span>
<span class="k">const</span> <span class="nx">channel</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">argv</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
<span class="k">const</span> <span class="nx">message</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">argv</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>

<span class="c1">// For testing to keep things clean
</span><span class="c1"></span><span class="k">const</span> <span class="nx">storage_dir</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">CABAL_DIR</span> <span class="o">||</span> <span class="nx">tmp</span><span class="p">.</span><span class="nx">dirSync</span><span class="p">().</span><span class="nx">name</span><span class="p">;</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span> <span class="s2">&#34;Storing our database in&#34;</span><span class="p">,</span> <span class="nx">storage_dir</span><span class="p">);</span>

<span class="c1">// Create a cabal instance
</span><span class="c1"></span><span class="k">const</span> <span class="nx">cabal</span> <span class="o">=</span> <span class="nx">Cabal</span><span class="p">(</span> <span class="nx">storage_dir</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="p">{</span><span class="nx">maxFeeds</span><span class="o">:</span><span class="mi">1000</span><span class="p">}</span> <span class="p">)</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span> <span class="s2">&#34;Connecting to swarm&#34;</span><span class="p">)</span>
<span class="nx">swarm</span><span class="p">(</span><span class="nx">cabal</span><span class="p">);</span>

<span class="nx">cabal</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;peer-added&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">key</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span> <span class="s2">&#34;Peer added&#34;</span><span class="p">,</span>  <span class="nx">key</span> <span class="p">);</span>
  <span class="nx">delay</span><span class="p">(</span> <span class="mi">2000</span> <span class="p">).</span><span class="nx">then</span><span class="p">(</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span> <span class="s2">&#34;Quitting 2 seconds after peer connect&#34;</span> <span class="p">)</span>
    <span class="nx">process</span><span class="p">.</span><span class="nx">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
  <span class="p">})</span>
<span class="p">})</span>

<span class="kd">let</span> <span class="nx">messageStored</span> <span class="o">=</span> <span class="kc">false</span>
<span class="kd">function</span> <span class="nx">publishCallback</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">messageStored</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span> <span class="s2">&#34;Message stored locally&#34;</span> <span class="p">)</span>
<span class="p">}</span>

<span class="c1">// This is called after the local database is loaded
</span><span class="c1"></span><span class="nx">cabal</span><span class="p">.</span><span class="nx">db</span><span class="p">.</span><span class="nx">ready</span><span class="p">(</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span> <span class="s2">&#34;Database is ready!&#34;</span><span class="p">)</span>

  <span class="nx">cabal</span><span class="p">.</span><span class="nx">publish</span><span class="p">(</span> <span class="p">{</span><span class="nx">type</span><span class="o">:</span> <span class="s2">&#34;chat/text&#34;</span><span class="p">,</span> <span class="nx">content</span><span class="o">:</span> <span class="p">{</span> <span class="nx">text</span><span class="o">:</span> <span class="nx">message</span><span class="p">,</span> <span class="nx">channel</span><span class="p">}},</span> <span class="nx">publishCallback</span> <span class="p">);</span>
<span class="p">})</span>

<span class="nx">delay</span><span class="p">(</span> <span class="mi">10000</span> <span class="p">).</span><span class="nx">then</span><span class="p">(</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="k">if</span><span class="p">(</span> <span class="nx">messageStored</span> <span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span> <span class="s2">&#34;10 second time before swarm connect, stored locally&#34;</span><span class="p">);</span>
    <span class="nx">process</span><span class="p">.</span><span class="nx">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span> <span class="s2">&#34;10 second timeout before message was stored&#34;</span><span class="p">);</span>
    <span class="nx">process</span><span class="p">.</span><span class="nx">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">})</span>
</code></pre></div>

<p>Then try running this code with a running cabal node on the remote host and without one.  You&rsquo;ll notice that the messages that were stored locally will eventually be delivered once a connection is made.</p>

<h2 id="next-steps">Next steps</h2>

<p>One thing that I&rsquo;m interested in playing around with is using this as a message bus of sorts, to each have remote devices report in on what they are doing (raspberry pi&rsquo;s for example) or be able to script it, to have a bot listening that takes commands in and run actions on the server and then pushes the results out (to IPFS for example.)  But that&rsquo;s for another post.</p>

<hr />

<p>References</p>

<ol>
<li><a href="https://cabal-club.github.io/">https://cabal-club.github.io/</a></li>
<li><a href="https://www.datprotocol.com/">https://www.datprotocol.com/</a></li>
<li><a href="https://github.com/cabal-club">https://github.com/cabal-club</a></li>
<li><a href="https://github.com/cabal-club/cabal-core">https://github.com/cabal-club/cabal-core</a></li>
<li><a href="https://github.com/datproject/dat/issues/841">https://github.com/datproject/dat/issues/841</a></li>
<li><a href="https://github.com/datproject/dat/issues/858">https://github.com/datproject/dat/issues/858</a></li>
</ol>

  </article>

  
  <div class="alert alert-secondary">The code from this article can be found at <a href="https://github.com/wschenk/cabal-experiments">https://github.com/wschenk/cabal-experiments</a></div>
  
</div>


  <div class="bg-light py-5">
    <div class="container">
      <h2 class="text-center">Read next</h2>

      <div class="row">
        <div class="col-md-6 text-center">
          
            Next Post:
            <a href="../../../articles/2019/controlling_ikea_tradfri_with_node/">Controlling IKEA Tradfri devices from your computer</a>
          
        </div>
        <div class="col-md-6 text-center">
          
            Previous Post:
            <a href="../../../articles/2019/splitting_git_repos_and_workdirectories/">Splitting Git Repos and Work Directories</a>
          
        </div>
      </div>
    </div>
  </div>




<div class="container mt-5">
  <h2 class="text-center">See also</h2>
  <div class="row">
  	
      <div class="col-md mb-3">
        <p class="lead mb-0"><a class="text-body" href="../../../articles/2019/setting_up_indieweb/">Setting up Indieweb Homepage</a></p>

        
          <p class="lead font-italic mb-0">the dream of the nineties is alive on the indieweb</p>
        
        <div class="font-weight-light mt-3">
          
          
            <p>Remember <a href="http://microformats.org/">microformats</a>?  Me neither!
Back when the web was open and we were trying to find ways to interconnect independent things?
Let&rsquo;s bring them back!</p>
          
        </div>
        <a href="../../../articles/2019/setting_up_indieweb/" class="btn btn-primary">Read more</a>
      </div>
    
  </div>
</div>


<footer class="footer bg-dark text-light mt-3">
  <div class="container">
    <h2 class="py-5 font-weight-light my-0">Made in Brooklyn, NY.</h2>
  </div>
</footer>
</body>
</html>
