<!DOCTYPE html>
<html><head>
  <title>Building a slimmer go Docker container</title>
  
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../../css/theme.css"/>
  <link rel="stylesheet" href="../../../css/syntax.css"/>

  
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-56296045-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

  <meta property="og:title" content="Building a slimmer go Docker container" />
<meta property="og:description" content="Go binaries are self contained, which means that they don&rsquo;t need anything special installed in the environment to deploy them.  When people make Dockerfiles to build go projects, they often include the the golang compilers and build tools, which isn&rsquo;t necessary for running the container.  I&rsquo;m going to use healer Docker container that &ldquo;Automatically heal docker containers that report themselves unhealthy&rdquo; as an example of reducing the image size from 648MB to 17MB." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://willschenk.com/articles/2019/building_a_slimmer_go_docker_container/" />
<meta property="article:published_time" content="2019-04-09T00:00:00+00:00" />
<meta property="article:modified_time" content="2019-04-09T00:00:00+00:00" />

  <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Building a slimmer go Docker container"/>
<meta name="twitter:description" content="Go binaries are self contained, which means that they don&rsquo;t need anything special installed in the environment to deploy them.  When people make Dockerfiles to build go projects, they often include the the golang compilers and build tools, which isn&rsquo;t necessary for running the container.  I&rsquo;m going to use healer Docker container that &ldquo;Automatically heal docker containers that report themselves unhealthy&rdquo; as an example of reducing the image size from 648MB to 17MB."/>
<meta name="twitter:site" content="@wschenk"/>


  <style>
    .article p, .article ul, .article ol, .article table {
      max-width: 45em;
    }

    .article pre p {
    max-width: none;
    margin-top: -1.5rem;
    }

    article.article p:first-child, .article blockquote {
      font-size: 1.25em;
      font-weight: 300;
      max-width: 36em;  
    }
  </style>
</head>
<body><nav class="container my-5">
  <h1 class="pt-md-5 display-3"><a class="text-dark" href="../../../">Will Schenk</a></h1>
  <p>
    
      <a class="text-dark h4 mr-3 font-weight-light" href="../../../articles/" title="">Articles</a>
    
      <a class="text-dark h4 mr-3 font-weight-light" href="../../../contact" title="">Contact</a>
    
      <a class="text-dark h4 mr-3 font-weight-light" href="../../../tags/" title="">Tags</a>
    
    <a href="../../../feed.xml" class="mr-3 h4 text-light"><img src="../../../img/rss.svg" alt="rss" height="20" width="20"/></a>
    
      <a href="https://twitter.com/@wschenk" class="mr-3 h4 text-light"><img src="../../../img/twitter.svg" alt="twitter" height="20" width="20"/></a>
    
    
      <a href="https://instagram.com/wschenk" class="mr-3 h4 text-light"><img src="../../../img/instagram.svg" alt="instagram" height="20" width="20"/></a>
    
    
      <a href="https://github.com/wschenk" class="mr-3 h4 text-light"><img src="../../../img/github.svg" alt="github" height="20" width="20"/></a>
    
    
      <a href="https://linkedin.com/in/will-schenk-420266" class="mr-3 h4 text-light"><img src="../../../img/linkedin.svg" alt="linkedin" height="20" width="20"/></a>
    
  </p>
</nav>

<div class="container">
  <h1 class="mt-5">Building a slimmer go Docker container</h1>

  
    <h2 class="font-weight-light font-italic mb-3">All we need is the binary</h2>
  

  <p class="text-muted mt-3">
    <a class="text-muted" href="https://willschenk.com/articles/2019/building_a_slimmer_go_docker_container/">Published April 9, 2019</a>

    
      <a class="text-muted" href="../../../tags/howto">#howto</a>
    
      <a class="text-muted" href="../../../tags/docker">#docker</a>
    
      <a class="text-muted" href="../../../tags/golang">#golang</a>
    
  </p>

  

  

  <article class="article mt-5">
    <p>Go binaries are self contained, which means that they don&rsquo;t need anything special installed in the environment to deploy them.  When people make <code>Dockerfiles</code> to build go projects, they often include the the golang compilers and build tools, which isn&rsquo;t necessary for running the container.  I&rsquo;m going to use <a href="https://github.com/somarat/healer">healer</a> Docker container that &ldquo;Automatically heal docker containers that report themselves unhealthy&rdquo; as an example of reducing the image size from 648MB to 17MB.</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">$ docker images  <span class="p">|</span>grep healer
somarat/healer             latest              76313596c92a        <span class="m">15</span> months ago       642MB
wschenk/healer             latest              2502c0b68d5e        About a minute ago  17.4MB
</code></pre></div><h2 id="original-dockerfile">Original Dockerfile</h2>
<p>The original file uses a golang image, copies everything into the work dir, installs some additional packages
a configuration and then uses the <code>go-wrapper</code> command to build and run the app.</p>
<div class="highlight"><pre class="chroma"><code class="language-Dockerfile" data-lang="Dockerfile"><span class="k">FROM</span><span class="s"> golang:1.9.2-alpine3.7</span><span class="err">
</span><span class="err">
</span><span class="err"></span><span class="k">WORKDIR</span><span class="s"> /go/src/app</span><span class="err">
</span><span class="err"></span><span class="k">COPY</span> . .<span class="err">
</span><span class="err">
</span><span class="err"></span><span class="k">RUN</span> apk --no-cache add -t build-deps build-base git <span class="se">\
</span><span class="se"></span>	<span class="o">&amp;&amp;</span> apk --no-cache add ca-certificates <span class="se">\
</span><span class="se"></span>  <span class="o">&amp;&amp;</span> git config --global http.https://gopkg.in.followRedirects true<span class="err">
</span><span class="err">
</span><span class="err"></span><span class="k">RUN</span> go-wrapper download<span class="err">
</span><span class="err"></span><span class="k">RUN</span> go-wrapper install<span class="err">
</span><span class="err">
</span><span class="err"></span><span class="k">CMD</span> <span class="p">[</span><span class="s2">&#34;go-wrapper&#34;</span><span class="p">,</span> <span class="s2">&#34;run&#34;</span><span class="p">]</span><span class="err">
</span></code></pre></div><p>Lets change it around (also because new version of the golang images don&rsquo;t have <code>go-wrapper</code> anymore!)</p>
<h2 id="build-and-deploy-containers">Build and deploy containers</h2>
<p>The basic idea is that we first bring down a full development environment for the code, and build it using the standard ways of building go applications.  Once that is done we will use a very slimmed down container and copy the built artifacts to it.</p>
<p>While we still should create a <code>.dockerignore</code> file to slim down the docker build context, none of the files will inadvertantly make it to the final image.  (In this case we only really need to copy in one file at all, <code>healer.go</code>, but we&rsquo;re copying in everything.)</p>
<p>We skip the additional package installs completely because they aren&rsquo;t needed.  We are relying upone the golang image being up to date and copying the certificates there over.</p>
<p>To do the build, we simply run <code>go get -d</code> to install the depenancies and then <code>go build</code> to create final binary over.</p>
<div class="highlight"><pre class="chroma"><code class="language-Dockerfile" data-lang="Dockerfile"><span class="k">FROM</span><span class="s"> golang:1.12.3-stretch</span><span class="err">
</span><span class="err"></span><span class="k">MAINTAINER</span><span class="s"> Will Schenk &lt;wschenk@gmail.com&gt;</span><span class="err">
</span><span class="err">
</span><span class="err"></span><span class="c"># Get the TLS CA certificates, they&#39;re not provided by busybox.</span><span class="err">
</span><span class="err"></span><span class="k">RUN</span> apt-get update <span class="o">&amp;&amp;</span> apt-get install -y ca-certificates<span class="err">
</span><span class="err">
</span><span class="err"></span><span class="c"># Copy the single source file to the app directory</span><span class="err">
</span><span class="err"></span><span class="k">WORKDIR</span><span class="s"> /go/src/app</span><span class="err">
</span><span class="err"></span><span class="k">COPY</span> . .<span class="err">
</span><span class="err">
</span><span class="err"></span><span class="c"># Install depenancies</span><span class="err">
</span><span class="err"></span><span class="k">RUN</span> go get -d<span class="err">
</span><span class="err">
</span><span class="err"></span><span class="c"># Build the app</span><span class="err">
</span><span class="err"></span><span class="k">RUN</span> go build<span class="err">
</span><span class="err">
</span><span class="err"></span><span class="c"># Switch to a small base image</span><span class="err">
</span><span class="err"></span><span class="k">FROM</span><span class="s"> busybox:1-glibc</span><span class="err">
</span><span class="err"></span><span class="k">MAINTAINER</span><span class="s"> Will Schenk &lt;wschenk@gmail.com&gt;</span><span class="err">
</span><span class="err">
</span><span class="err"></span><span class="c"># Copy the binary over from the deploy container</span><span class="err">
</span><span class="err"></span><span class="k">COPY</span> --from<span class="o">=</span><span class="m">0</span> /go/src/app/app /usr/bin/healer<span class="err">
</span><span class="err">
</span><span class="err"></span><span class="c"># Get the TLS CA certificates from the build container, they&#39;re not provided by busybox.</span><span class="err">
</span><span class="err">
</span><span class="err"></span><span class="k">COPY</span> --from<span class="o">=</span><span class="m">0</span> /etc/ssl/certs /etc/ssl/certs<span class="err">
</span><span class="err">
</span><span class="err"></span><span class="k">CMD</span> healer<span class="err">
</span></code></pre></div><p>Then all we need to do is build and tag it:</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">docker build . -t wschenk/healer:latest
</code></pre></div><h2 id="verifying">Verifying</h2>
<p>I&rsquo;m using my docker hub user id, you should replace it with your own.</p>
<p>To test it out, you can start it up and make sure that you give it access to the <code>docker.sock</code> socket file.</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">docker run -d --name healer -v /var/run/docker.sock:/tmp/docker.sock --restart unless-stopped wschenk/healer
</code></pre></div><p>And then check out the logs:</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">$ docker logs healer
2019/04/09 20:07:05 Monitoring container health
</code></pre></div><p>To make sure that everything is good.</p>
<p>Finally, push it to the hub to be able to access it from other machines!</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">docker push wschenk/healer
</code></pre></div>
  </article>

  
</div>


  <div class="bg-light py-5">
    <div class="container">
      <h2 class="text-center">Read next</h2>

      <div class="row">
        <div class="col-md-6 text-center">
          
            Next Post:
            <a href="../../../articles/2019/easy_scraping_with_httpie_and_jq/">Easy scraping with httpie and jq</a>
          
        </div>
        <div class="col-md-6 text-center">
          
            Previous Post:
            <a href="../../../articles/2019/bootstrapping_a_react_app_with_bootstrap/">Bootstrapping a react app</a>
          
        </div>
      </div>
    </div>
  </div>




<div class="container mt-5">
  <h2 class="text-center">See also</h2>
  <div class="row">
  	
      <div class="col-md mb-3">
        <p class="lead mb-0"><a class="text-body" href="../../../articles/2019/setting_up_chromebook/">Setting up a chromebook for development</a></p>

        
          <p class="lead font-italic mb-0">Documenting my steps</p>
        
        <div class="font-weight-light mt-3">
          
          
            <p>I just switch my pixelbook back to the stable channel, and this is what I did to get back to developing on it.</p>
          
        </div>
        <a href="../../../articles/2019/setting_up_chromebook/" class="btn btn-primary">Read more</a>
      </div>
    
      <div class="col-md mb-3">
        <p class="lead mb-0"><a class="text-body" href="../../../articles/2019/bootstrapping_a_react_app_with_bootstrap/">Bootstrapping a react app</a></p>

        
          <p class="lead font-italic mb-0">with bootstrap and font awesome</p>
        
        <div class="font-weight-light mt-3">
          
          
            <p>Here&rsquo;s a quick recipe for getting a blank react project with bootstrap up and running.  We&rsquo;ll walk
though all of the steps that you&rsquo;ll need to get a basic bootstrap based framework up and running,
ready for theming and component implementation using redux.</p>
          
        </div>
        <a href="../../../articles/2019/bootstrapping_a_react_app_with_bootstrap/" class="btn btn-primary">Read more</a>
      </div>
    
      <div class="col-md mb-3">
        <p class="lead mb-0"><a class="text-body" href="../../../articles/2019/setting_up_ipfs_on_chromebook/">Setting up IPFS on a chromebook</a></p>

        
          <p class="lead font-italic mb-0">Connecting to the world</p>
        
        <div class="font-weight-light mt-3">
          
          
            <p>Lets look at how to run an ipfs node on a chromebook.  We are using the linux container for this, and in order to get the experience right we&rsquo;ll need to install some chrome extensions to make it work seamlessly.</p>
          
        </div>
        <a href="../../../articles/2019/setting_up_ipfs_on_chromebook/" class="btn btn-primary">Read more</a>
      </div>
    
  </div>
</div>


<footer class="footer bg-dark text-light mt-3">
  <div class="container">
    <h2 class="py-5 font-weight-light my-0">Made in Brooklyn, NY.</h2>
  </div>
</footer>
</body>
</html>
