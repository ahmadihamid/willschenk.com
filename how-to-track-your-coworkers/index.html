<!DOCTYPE html>
<html class='no-js'>
  <head>
    <meta charset='utf-8'>
    <meta content='IE=edge,chrome=1' http-equiv='X-UA-Compatible'>
    <title>How to track your coworkers</title>
    <meta content='' name='description'>
    <meta content='width=device-width' name='viewport'>
    <link href="../stylesheets/application-9a887a4b.css" rel="stylesheet" type="text/css" /><link href="../stylesheets/socicons-d8ab83dd.css" rel="stylesheet" type="text/css" /><link href="../stylesheets/animate-8335fea6.css" rel="stylesheet" type="text/css" />
    <link href='//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.3/styles/default.min.css' rel='stylesheet'>
    <link rel="alternate" type="application/atom+xml" title="Atom Feed" href="/feed.xml" />
  </head>
  <body>
    <div class='article-header '>
      <h1>How to track your coworkers</h1>
      <h2>Simple passive network surveillance</h2>
      <div class='avatar'>
        <a href='/'>
          <img class="img-responsive" src="../images/avatar-199162d8.jpg" />
        </a>
      </div>
      <h3><a href="/">Will Schenk</a></h3>
      <span class='disqus-comment-count' data-disqus-identifier='silvrback-wschenk-9332'></span>
      <!-- %p.social -->
      <!-- - (config.social || {}).each do |type,url| -->
      <!-- %a{ href: url } -->
      <!-- %span{ class: "socicon socicon-#{type.to_s} fgcolor" } -->
    </div>
    <div class='container-fluid content'>
      <div class='row'>
        <div class='article'>
          <p>How much information do you bleed?</p>
          
          <p>Ever wonder who is else is using your network?  Or,who has actually showed up at the office?</p>
          
          <p></p>
          
          <p>The simplest thing we can do to make this work is to check to see which devices have registered themselves on the network.  As devices come and go, they connect automatically, so we will have a pretty good idea if people are there or not.  Phones seem to attach and detach quite frequency, probably to conserve battery, so if we are want to answer the question &quot;is so-and-so in the office&quot; we&#39;ll need to add additional logic to determine how far spaced the &quot;sighting&quot; events are to mean that the person has left the office, rather than the phone has gone to sleep.</p>
          
          <p>There are a couple of ways to do this. One is to log on you your router and look at the <code>DHCP</code> routing tables to see which devices have leased an IP address.  Have you looked at those router webpages though?  Pretty gross.  You&#39;d need to do some scraping, something different for each of the router types, all together pretty gross.</p>
          
          <p>Another thing to consider is <code>DNS multicast</code>, also called <code>Bonjour</code> or zero-config networking.  This is pretty much the standard now for services announcing themselves on the human-used networks.  (Server rooms have fancier service discovery mechanisms.)  If you want to find a printer, or someone else&#39;s iTunes library it works great, but it doesn&#39;t do much for phones.</p>
          
          <p>We are going to do this using ping.   This is simple and works everywhere.</p>
          
          <p>The code below using <code>ruby</code> and <code>redis</code> to track which devices have been seen.  You&#39;ll need to have <code>redis</code> installed and running for this code to work, but it should be easily portable to any Unix system, not just OSX.  So if you have a <code>RaspberryPI</code>laying around, it would be run to run it on there.</p>
          
          <p>This code does the following things:</p>
          
          <ol>
          <li>Find the local broadcast address.  This is normally <code>192.168.1.255</code> on home routers but could be anything.</li>
          <li>Send 4 pings to the broadcast address and listen for replies.  It may take some time to return back,which is why we have multiple pings.  Collect those IP addresses as a response.</li>
          <li>Do a reverse DNS lookup on those IP addresses, and mark them as seen in <code>redis</code>.</li>
          <li>(Commented out) Look at the arp table to see if any other devices have announced themselves.  This will discover mode devices, but the ARP cache lasts an unknown amount of time, so this will not correctly track leaving events.</li>
          <li>The <code>def seen</code> method will set a key in <code>redis</code> and expire it in <code>30</code> seconds.  The scan runs every <code>10</code> seconds.  So if we having seen a device in 2 or 3 scans then we assume it has left the network.  We look at each of the keys in the redis set <code>hosts</code> to see if it still exists, and if not, assume that the device has left.</li>
          </ol>
          
          <p>The only <code>OSX</code> ism of this script is that its using <code>osascript</code> to push a notification to the desktop that a device name has come on or left.  See below for further things to play with:</p>
          
          <pre><code>#!/usr/bin/env ruby -wKU&#x000A;&#x000A;require &#39;resolv&#39;&#x000A;require &#39;redis&#39;&#x000A;&#x000A;def notify( text )&#x000A;  system( &quot;/usr/bin/osascript -e \&quot;display notification \\\&quot;#{text}\\\&quot;\&quot;&quot; )&#x000A;end&#x000A;&#x000A;def scan&#x000A;  # Look for the network broadcast address&#x000A;  broadcast = `ifconfig -a | grep broadcast`.split[-1]&#x000A;&#x000A;  # puts &quot;Broadcast Address #{broadcast}&quot;&#x000A;&#x000A;  unless broadcast =~ /\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}/&#x000A;    puts &quot;#{broadcast} doesn&#39;t look correct&quot;&#x000A;    exit 1&#x000A;  end&#x000A;&#x000A;  # Ping the broadcast address 4 times and wait for responses&#x000A;  ips = `ping -t 4 #{broadcast}`.split(/\n/).collect do |x|&#x000A;    if x =~ /(\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}):/&#x000A;      $1&#x000A;    else&#x000A;      nil&#x000A;    end&#x000A;  end.select { |x| x &amp;&amp; x != broadcast}.sort.uniq&#x000A;&#x000A;  dns = Resolv.new&#x000A;&#x000A;  # Do a host name lookup on all of the addresses and put in redis&#x000A;  ips.each do |ip|&#x000A;    name = dns.getname ip&#x000A;    seen( name )&#x000A;  end&#x000A;&#x000A;  # If you want to catch the other devices that don&#39;t respond to pings&#x000A;  # but have an arp, you can scan below.  However, arp addresses get&#x000A;  # cached for a while, &#x000A;  # Catch the other devices that don&#39;t respond to pings but have arp addresses&#x000A;  # (pinging the broadcast address will help populate the local arp table)&#x000A;  # `arp -a`.split( /\n/ ).collect do |x|&#x000A;  #   if x =~ /^([^\s]*).*\((\d+\.\d+\.\d+\.\d+)\)/&#x000A;  #     seen( $1 )&#x000A;  #   end&#x000A;  # end&#x000A;&#x000A;  # Look through all of the members in redis, and for any ones that have&#x000A;  # expired say that they&#39;ve left the system&#x000A;  redis = Redis.new&#x000A;&#x000A;  redis.smembers( &quot;hosts&quot; ).each do |host|&#x000A;    unless redis.get host&#x000A;      redis.srem &quot;hosts&quot;, host&#x000A;&#x000A;      puts &quot;#{Time.new} #{host} left the network&quot;&#x000A;      notify &quot;#{host} left the network&quot;&#x000A;    end&#x000A;  end&#x000A;end&#x000A;&#x000A;# Mark the name as being seen.  Create a key with the name and expire it in&#x000A;# 30 seconds.  Also add it to the hosts set.  If we don&#39;t see the name again&#x000A;# in 3 sweeps, the key will expire.&#x000A;def seen( name )&#x000A;  name = name.downcase&#x000A;  redis = Redis.new&#x000A;  unless redis.get name&#x000A;    puts &quot;#{Time.new} #{name} joined the network&quot;&#x000A;    notify &quot;#{name} joined the network&quot;&#x000A;  end&#x000A;  redis.set name, &quot;1&quot;&#x000A;  redis.expire name, &quot;30&quot;&#x000A;  redis.sadd &quot;hosts&quot;, name&#x000A;end&#x000A;&#x000A;# Run forever&#x000A;while true&#x000A;  scan&#x000A;  sleep 10&#x000A;end&#x000A;</code></pre>
          
          <p>Other things to play around with:</p>
          
          <ol>
          <li><code>nmap -O hostname</code> will do a scan of the device to see what operation system it is.  However, this is a little more intrusive, needs to run as root, and takes a while to run so it should be queued.</li>
          <li>Instead of using osascript, post the device joined, left, or presence events to an internal website to make a better UI.</li>
          <li>This would allow you to map multiple device names to a person.  For example, I know that <code>willschiphone5s.home</code> is my phone and <code>combray.home</code> is my computer, but how do you keep a mapping of those names to people?</li>
          <li><code>MAC addresses</code> should be stable for devices once they may contact to the site.  We can get this from the <code>arp</code> tables, and those can&#39;t be changed like the computer names can.</li>
          </ol>
          
          <p>Remember, information can bleed and there&#39;s a whole lot you can do to see about the people around you.</p>
        </div>
      </div>
      <div class="row article_footer">
        <div class="comments">
          October 31, 2014
          <a href="#" id="comment_shower">
            <span class="socicon socicon-disqus fgcolor"></span>
            <span class="disqus-comment-count" data-disqus-identifier="silvrback-wschenk-9332">Be the first to comment.</span>
          </a>
        </div>
        <div class="sharing">
          <a href="http://www.twitter.com/share?url=http://willschenk.com/how-to-track-your-coworkers/&amp;text=How to track your coworkers by @wschenk" title="Share this post on Twitter" data-lang="en" onclick="return !window.open(this.href, 'Twitter', 'width=640,height=300')"><span class="socicon socicon-twitter fgcolor"></span></a>
      
          <a target="_blank" onclick="return !window.open(this.href, 'Facebook', 'width=640,height=300')" href="http://www.facebook.com/sharer/sharer.php?u=http://willschenk.com/how-to-track-your-coworkers/" title="Share this post on Facebook"><span class="socicon socicon-facebook fgcolor"></span></a>
      
          <a href="http://plus.google.com/share?url=http://willschenk.com/how-to-track-your-coworkers/" target="_blank" onclick="return !window.open(this.href, 'Google +', 'width=640,height=300')" title="Share this post on Google +"><span class="socicon socicon-google fgcolor"></span></a>
        </div>
      </div>
      <div class="row comment_universe">
        <div id="disqus_thread" class="col-sm-10 col-sm-offset-1"></div>
      </div>
    </div>
    <footer class='footer '>
      <ul class='nav nav-pills header_links'>
        <li><a href="/">Articles</a></li>
        <!-- %li= link_to "About", "/about.html" -->
        <li><a href="/tags/overview/">Compleat</a></li>
        <li><a href="/tags/socialinvestigator/">Socialinvestigator</a></li>
        <li><a href="http://happyfuncorp.com">HappyFunCorp</a></li>
        <li><a href="/feed.xml">RSS</a></li>
      </ul>
      <p>
        You can also find me on
        <a href='http://twitter.com/wschenk'>
          Twitter,
        </a>
        <a href='http://sublimeguile.com/'>
          Tumblr,
        </a>
        <a href='http://instagram.com/wschenk'>
          Instagram,
        </a>
        <a href='http://www.linkedin.com/pub/will-schenk/0/266/420/'>
          Linkedin,
        </a>
        <a href='https://github.com/wschenk'>
          Github,
        </a>
        or on
        <a href='mailto: will@happyfuncorp'>Email.</a>
      </p>
      <p class='social'>
        <a href='http://twitter.com/wschenk'>
          <span class='socicon socicon-twitter bgcolor'></span>
        </a>
        <a href='http://sublimeguile.com/'>
          <span class='socicon socicon-tumblr bgcolor'></span>
        </a>
        <a href='http://instagram.com/wschenk'>
          <span class='socicon socicon-instagram bgcolor'></span>
        </a>
        <a href='http://www.linkedin.com/pub/will-schenk/0/266/420/'>
          <span class='socicon socicon-linkedin bgcolor'></span>
        </a>
        <a href='https://github.com/wschenk'>
          <span class='socicon socicon-github bgcolor'></span>
        </a>
      </p>
    </footer>
    <script src="../javascripts/application-f8812046.js" type="text/javascript"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.3/highlight.min.js"></script>
    <script type="text/javascript">
      hljs.initHighlightingOnLoad();
    
      $(".article img").addClass( "img-responsive");
    
      $("iframe").map( function(e) {
        $(this).css( "max-width", $(this).width() );
        $(this).width( "100%" );
    
      });
    
      var _gaq=[['_setAccount','UA-56296045-1'],['_trackPageview']];
      (function(d,t){var g=d.createElement(t),s=d.getElementsByTagName(t)[0];
      g.src=('https:'==location.protocol?'//ssl':'//www')+'.google-analytics.com/ga.js';
      s.parentNode.insertBefore(g,s)}(document,'script'));
    
      var disqus_shortname = 'willschenk';
        var disqus_identifier = 'silvrback-wschenk-9332';
            
      (function() {
          var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
          dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
          (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      })();
    
      (function () {
    var s = document.createElement('script'); s.async = true;
    s.type = 'text/javascript';
    s.src = 'http://' + disqus_shortname + '.disqus.com/count.js';
    (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
    </script>
  </body>
</html>
