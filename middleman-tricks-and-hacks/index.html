<!DOCTYPE html>
<html class='no-js'>
  <head>
    <meta charset='utf-8'>
    <meta content='IE=edge,chrome=1' http-equiv='X-UA-Compatible'>
    <title>Middleman Tricks and Hacks | Blank Page Tech</title>
    <meta name="site" content="Blank Page Tech" />
    <meta name="og:site_name" content="Blank Page Tech" />
    <meta name="title" content="Middleman Tricks and Hacks" />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="Middleman Tricks and Hacks" />
    <meta name="twitter:site" content="@wschenk" />
    <meta name="og:title" content="Middleman Tricks and Hacks" />
    <meta content='width=device-width' name='viewport'>
    <link href="../stylesheets/application-4c158d82.css" rel="stylesheet" type="text/css" /><link href="../stylesheets/webicons-da5ecace.css" rel="stylesheet" type="text/css" /><link href="../stylesheets/socicons-d8ab83dd.css" rel="stylesheet" type="text/css" /><link href="../stylesheets/animate-8335fea6.css" rel="stylesheet" type="text/css" /><link href="../stylesheets/googlecode-d3629bf4.css" rel="stylesheet" type="text/css" />
    <link href='//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.3/styles/default.min.css' rel='stylesheet'>
    <link rel="alternate" type="application/atom+xml" title="Atom Feed" href="/feed.xml" />
  </head>
  <body data-spy='scroll' data-target='.sidebar'>
    <nav class="navbar navbar-default navbar-fixed-top" role="navigation">
      <div class="container">
      <div class='visible-xs-block'>
      <div class="navbar-header">
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar-collapsable">
          <span class="sr-only">Toggle navigation</span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a href="/" class="navbar-brand">
        Blank Page Tech
      </a>
        
      </div>
    </div>
    <div class='hidden-xs'>
      <div class="navbar-header">
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar-collapsable">
          <span class="sr-only">Toggle navigation</span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a href="/" class="navbar-brand">
        Technology for the blank page
      </a>
        
      </div>
    </div>
    <div class="collapse navbar-collapse" id="navbar-collapsable">
      <ul class="nav navbar-nav navbar-right foo" id="menu">
      <li>
      <a href="/articles/">
        Articles
      </a>
    </li>
    <li class="dropdown">
      <a href="#" class="dropdown-toggle" data-toggle="dropdown">Topics <b class="caret"></b></a>
      <ul class="dropdown-menu">
        <li>
      <a href="/tags/howto/">
        Howtos
      </a>
    </li>
    <li>
      <a href="/tags/overview/">
        Overviews
      </a>
    </li>
    <li>
      <a href="/tags/tools/">
        Tools
      </a>
    </li>
    <li>
      <a href="/tags/socialinvestigator/">
        Social Investigator
      </a>
    </li>
    <li>
      <a href="/tags/ruby/">
        Ruby & Rails
      </a>
    </li>
    
      </ul>
    </li>
    <li class="dropdown">
      <a href="#" class="dropdown-toggle" data-toggle="dropdown">Tags <b class="caret"></b></a>
      <ul class="dropdown-menu">
        <li>
      <a href="/tags/bootstrap/">
        bootstrap (1)
      </a>
    </li>
    <li>
      <a href="/tags/bots/">
        bots (2)
      </a>
    </li>
    <li>
      <a href="/tags/data/">
        data (1)
      </a>
    </li>
    <li>
      <a href="/tags/happy_seed/">
        happy_seed (2)
      </a>
    </li>
    <li>
      <a href="/tags/howto/">
        howto (12)
      </a>
    </li>
    <li>
      <a href="/tags/middleman/">
        middleman (3)
      </a>
    </li>
    <li>
      <a href="/tags/oauth/">
        oauth (1)
      </a>
    </li>
    <li>
      <a href="/tags/osx/">
        osx (1)
      </a>
    </li>
    <li>
      <a href="/tags/overview/">
        overview (2)
      </a>
    </li>
    <li>
      <a href="/tags/product/">
        product (1)
      </a>
    </li>
    <li>
      <a href="/tags/rails/">
        rails (2)
      </a>
    </li>
    <li>
      <a href="/tags/rake/">
        rake (1)
      </a>
    </li>
    <li>
      <a href="/tags/redis/">
        redis (1)
      </a>
    </li>
    <li>
      <a href="/tags/ruby/">
        ruby (11)
      </a>
    </li>
    <li>
      <a href="/tags/socialinvestigator/">
        socialinvestigator (4)
      </a>
    </li>
    <li>
      <a href="/tags/sql/">
        sql (1)
      </a>
    </li>
    <li>
      <a href="/tags/startupmyths/">
        startupmyths (1)
      </a>
    </li>
    <li>
      <a href="/tags/thor/">
        thor (1)
      </a>
    </li>
    <li>
      <a href="/tags/tools/">
        tools (5)
      </a>
    </li>
    <li>
      <a href="/tags/toys/">
        toys (2)
      </a>
    </li>
    
      </ul>
    </li>
    <li class="dropdown">
      <a href="#" class="dropdown-toggle" data-toggle="dropdown">Archives <b class="caret"></b></a>
      <ul class="dropdown-menu">
        <li>
      <a href="/2015/01/">
        Jan 2015 (1)
      </a>
    </li>
    <li>
      <a href="/2014/12/">
        Dec 2014 (5)
      </a>
    </li>
    <li>
      <a href="/2014/11/">
        Nov 2014 (10)
      </a>
    </li>
    <li>
      <a href="/2014/10/">
        Oct 2014 (1)
      </a>
    </li>
    
      </ul>
    </li>
    
    </ul>
    
    </div>
    
    </div>
    </nav>
    <div class='article-header  '>
      <h1>Middleman Tricks and Hacks</h1>
      <h2>specific tricks I used to build this site</h2>
      <div class='tags'>
        <div class='tag'><a class="btn btn-primary" href="/tags/howto/">howto</a></div>
        <div class='tag'><a class="btn btn-primary" href="/tags/middleman/">middleman</a></div>
        <div class='tag'><a class="btn btn-primary" href="/tags/ruby/">ruby</a></div>
        <div class='tag'><a class="btn btn-primary" href="/tags/tools/">tools</a></div>
      </div>
      <a href='#comment_shower' id='comment_shower_scroll'>
        <span class='disqus-comment-count' data-disqus-identifier='2014-12-13-middleman-tricks-and-hacks.html'></span>
      </a>
    </div>
    <div class='content'>
      <div class='row'>
        <div class='sidebar'>
          <ul class='nav toc' data-offset-top='400' data-spy='affix'>
            <li><a href="#top">Middleman Tricks and Hacks</a></li>
            <li><a href="#partials">Partials</a></li>
            <li><a href="#layouts-and-partials-for-articles">Layouts and partials for articles</a></li>
            <li><a href="#communication-between-partials">Communication between partials</a></li>
            <li><a href="#markdown-with-toc-data">Markdown with toc data</a></li>
            <li><a href="#helpers-that-parse-the-source-file">Helpers that parse the source file</a></li>
            <li><a href="#helper-methods-to-do-query-ish-things">Helper methods to do query-ish things</a></li>
            <li><a href="#site-data-as-database">Site data as database</a></li>
            <li><a href="#directory-index-and-url_for">Directory index and url_for</a></li>
            <li><a href="#not-a-lot-of-tradeoffs">Not a lot of tradeoffs</a></li>
          </ul>
        </div>
        <div class='article' id='top'>
          <p>As part of the process of getting this site to work, I learned some more things about how to better build a site with middleman.  Building off of our <a href="/building-sites-with-middleman/">foundational article</a> here are a few other things that I found very useful when using middleman to build a static site with a bunch of dynamically generated content.</p>
          
          <h2 id="partials">Partials</h2>
          
          <p>The <code>index.html.haml</code>, <code>articles.html.haml</code>, <code>tag.html.haml</code> and <code>calendar.html.haml</code> pages all use the same partial to list out the post archives, which are mostly the same.</p>
          
          <p>On the <em>index</em> page it&#39;s called like this, where I&#39;m supressing the date heading:</p>
          
          <pre><code class="haml">= partial &quot;post_list&quot;, :locals =&gt; {:page_articles =&gt; blog.articles[1..4], :no_date =&gt; true }&#x000A;</code></pre>
          
          <p>and in the <em>articles</em> I&#39;m including draft posts for my own reference, and since they don&#39;t have a published date we need to check for that.</p>
          
          <pre><code class="haml">= partial &quot;post_list&quot;, :locals =&gt; {:page_articles =&gt; (drafts + page_articles)}&#x000A;</code></pre>
          
          <p>The <code>_post_list.haml</code> file then has some logic to show date headings based upon the published dates of the articles.  (This assumes that the posts are sorted by time, either ascending or descending.) </p>
          
          <pre><code class="haml">- last_date = nil&#x000A;- no_date = !!no_date&#x000A;%ul&#x000A;  - page_articles.each do |current_post|&#x000A;    - if !no_date &amp;&amp; current_post.date&#x000A;      - date_string = current_post.date.strftime(&#39;%b %Y&#39;)&#x000A;      - if last_date != date_string&#x000A;        %li.date&#x000A;          %h2= date_string&#x000A;      - last_date = date_string&#x000A;    %li&#x000A;      .more&#x000A;        - unless current_post.is_a? ::Middleman::Blog::Drafts::DraftArticle&#x000A;          = current_post.date.strftime( &#39;%b %e&#39; )&#x000A;        - else&#x000A;          Draft&#x000A;      %div= link_to current_post.title, current_post&#x000A;      %div&#x000A;        = current_post.data[&#39;subtitle&#39;]&#x000A;&#x000A;        .tags&#x000A;          - current_post.tags.sort.each do |tag|&#x000A;            .tag= link_to tag, tag_path( tag )&#x000A;</code></pre>
          
          <p>Partials also work better when using <a href="/bootstrap-advanced-grid-tricks/">semantic CSS classes</a> to define my layouts, since the same class can have different meaning depending upon what it is embedded in.</p>
          
          <h2 id="layouts-and-partials-for-articles">Layouts and partials for articles</h2>
          
          <p>Middleman posts are generally written in markdown, which translates into a series of <code>&lt;p&gt;</code> tags that are dumped into a layout file.  In order to create the table of contents on the left, the navigation to other articles on the right, the unique header and footer, I used a seperate <code>article_layout</code> for article pages.  Setting up <strong>Scrollspy</strong> and <strong>Affix</strong> means we need to change things on the <code>&lt;body&gt;</code> tag that we don&#39;t need to do for other pages, so it makes more sense to use a seperate file here rather than a <em>nested layout</em>.</p>
          
          <p>This means that all the things that are shared between the two layouts, the main layout for all the meta pages and the article layout for the content pages, should be factored into partials.  I put these partials in the <code>layouts/</code> directory.</p>
          
          <h2 id="communication-between-partials">Communication between partials</h2>
          
          <p>The top and the bottom of these pages change together.  If the page has a header image -- something I specify in the YAML preamble of my post -- then both the <code>article_header</code> and <code>footer</code> partials display slightly different things.  The logic for this check is in the <code>article_header</code>, where I set a <em>instance variable</em> that I use in a later partial to add a class.</p>
          
          <p>In <code>layouts/_article_header.haml</code>:</p>
          
          <pre><code>- @lighter ||= &quot;&quot;&#x000A;- @dark_header = &quot;dark_header&quot; if current_article.data[&#39;dark_header&#39;]&#x000A;- if !current_article.data[&#39;header_image&#39;].nil? &amp;&amp; current_article.data[&#39;header_image&#39;] != &quot;&quot;&#x000A;  - @lighter = &quot;lighter&quot;&#x000A;  .banner&#x000A;    = image_tag current_article.data[&#39;header_image&#39;], class: &quot;fadeInDown animated&quot;&#x000A;&#x000A;%div{ class: &quot;article-header #{@lighter} #{@dark_header}&quot; }&#x000A;</code></pre>
          
          <p>and then in <code>layouts/_footer.haml</code> I use the same variable to add a class to the <code>footer</code> element which changes the background.</p>
          
          <pre><code>%footer{ class: &quot;footer #{@lighter} #{@dark_header}&quot; }&#x000A;</code></pre>
          
          <h2 id="markdown-with-toc-data">Markdown with toc data</h2>
          
          <p>Inside of <code>config.rb</code> we can add some better markdown processing options.  I switched to redcarpet and enabled <code>with_toc_data</code>.  This generates id tags on the <code>&lt;h1&gt;</code>, <code>&lt;h2&gt;</code> etc elements that we can use as anchors.</p>
          
          <pre><code class="rb">set :markdown, :tables =&gt; true, :autolink =&gt; true, :gh_blockcode =&gt; true, :fenced_code_blocks =&gt; true, with_toc_data: true&#x000A;set :markdown_engine, :redcarpet&#x000A;</code></pre>
          
          <p>These ids are generated by sanitizing the text between the tags, but <code>redcarpet</code> only makes things lowercase and changes spaces to underscores, and unfortunately it doesn&#39;t strip out punctuation characters and will result in ids that aren&#39;t valid.  So I had to change my headers, at least until I can take a look at the redcarpet code in more detail.</p>
          
          <p><strong>Update</strong> This looks like it&#39;s fixed in the latest git version of redcarpet, but it hasn&#39;t been released as a gem yet.</p>
          
          <h2 id="helpers-that-parse-the-source-file">Helpers that parse the source file</h2>
          
          <p>Now that we have the anchors in there, we need to generate the links to those anchors.  This can be done by parsing the source file on the article page with a helper.  It&#39;s a poor man&#39;s markdown processor, but it does the job.  This code lives in <code>config.rb</code>:</p>
          
          <pre><code class="rb">helpers do&#x000A;  def chapters( post )&#x000A;    File.readlines( post.source_file ).collect do |x|&#x000A;      if x =~ /^##\s(.*)/&#x000A;        $1&#x000A;      else&#x000A;        nil&#x000A;      end&#x000A;    end.select { |x| x }&#x000A;  end&#x000A;end&#x000A;</code></pre>
          
          <p>And we can then use it to generate the list of links:</p>
          
          <pre><code class="haml">%ul.nav.toc&#x000A;  %li= link_to current_article.title, &quot;#top&quot;&#x000A;  - chapters( current_article ).each do |chapter|&#x000A;    %li= link_to chapter, &quot;##{chapter.downcase.gsub( /\s/, &quot;-&quot; )}&quot;&#x000A;</code></pre>
          
          <h2 id="helper-methods-to-do-query-ish-things">Helper methods to do query-ish things</h2>
          
          <p>The logic to calculate the <em>next</em> and <em>previous</em> articles in the series work using the tag system, and it cycles though all of the tags of the current article to find articles with corresponding tags.  Rather than showing the same article for multiple tags, I wanted to group the tags together if they all pointed to the same article.</p>
          
          <p>This is the type of logic that would normally be in a rails Model.  Either you&#39;d do it directly out of the database, or you would process the results somehow and return something that was easy to iterate over in the view.</p>
          
          <p>Moving this code into helper method isolated all of that logic out of the views themselves.</p>
          
          <h2 id="site-data-as-database">Site data as database</h2>
          
          <p>The other thing I wanted to do was to associate additional data with specific tags.  If this was an article, you could put it in the preamble, but since tags are generated dynamically from the article files we need to put them somewhere else.  That place is <code>data/topics.yml</code></p>
          
          <pre><code class="yml">---&#x000A;:howto:&#x000A;  :title: Howtos&#x000A;  :desc: In which we go through step by step to achieve a particular goal.&#x000A;:overview:&#x000A;  :title: Overviews&#x000A;  :desc: In which we cover a topic in depth to orient ourselves with the technology.&#x000A;</code></pre>
          
          <p>This is referenced in views like:</p>
          
          <pre><code class="haml">- data[&#39;topics&#39;].each do |k,d|&#x000A;  .track&#x000A;    %h2= link_to d[:title], &quot;/tags/#{k}.html&quot;&#x000A;</code></pre>
          
          <p>This data is also referenced in the tag page as well as the main header.  It&#39;s only stored in one place, which is nice and DRY.  If it got any more complicated than this, where we wanted to filter or sort it in some dynamic way then we implement that code in a helper so it could be shared across the site.</p>
          
          <h2 id="directory-index-and-url_for">Directory index and url_for</h2>
          
          <p>To make pretty urls work in the blog, you need to have <code>activate :directory_indexes</code> <em>after</em> <code>activate :blog</code> in your <code>config.rb</code> file.  <em>The order of middleman extensions in the config file matter.</em></p>
          
          <p>The plugin works by changing the way that the <code>link_to</code> helper works.  If you have a link that&#39;s generated in another way, you should use the <code>url_for</code> method to make sure that it get&#39;s rewritten.  For example</p>
          
          <pre><code class="rb">= navbar_item d[&#39;title&#39;], url_for( &quot;/tags/#{topic}.html&quot; )&#x000A;</code></pre>
          
          <h2 id="not-a-lot-of-tradeoffs">Not a lot of tradeoffs</h2>
          
          <p>Other than the one issue with redcarpet where I couldn&#39;t control the way that the ids were being generated, there hasn&#39;t been much that I haven&#39;t be able to achieve with a statically generated site.  The implementation is different, but overall most of the time was spent fiddling with the CSS rather than fighting the build system.</p>
          
          <p>Which is how it should be.</p>
        </div>
        <div class='navigation' data-offset-top='400' data-spy='affix'>
          <div class='next'>
            <p>
              Next in
              <a href="/tag/Chronological.html">Chronological</a>
              <a href="/tag/Middleman.html">Middleman</a>
              <a href="/tag/Ruby.html">Ruby</a>
              <a href="/tag/Howto.html">Howto</a>
            </p>
            <p class='title'><a href="/building-middleman-extensions/">Building Middleman Extensions</a></p>
            <p>
              Next in
              <a href="/tag/Tools.html">Tools</a>
            </p>
            <p class='title'><a href="/using-rake-for-dataflow-programming-and-data-science/">Using rake for dataflow programming and data science</a></p>
          </div>
          <div class='prev'>
            <p>
              Previously in
              <a href="/tag/Chronological.html">Chronological</a>
              <a href="/tag/Ruby.html">Ruby</a>
              <a href="/tag/Howto.html">Howto</a>
            </p>
            <p class='title'><a href="/dateslice-writing-rails-extensions/">Dateslice: Writing rails extensions</a></p>
            <p>
              Previously in
              <a href="/tag/Middleman.html">Middleman</a>
            </p>
            <p class='title'><a href="/building-sites-with-middleman/">Building Sites with Middleman</a></p>
            <p>
              Previously in
              <a href="/tag/Tools.html">Tools</a>
            </p>
            <p class='title'><a href="/new-happyseed-released/">New HappySeed released</a></p>
          </div>
        </div>
      </div>
      <div class="row article_footer">
        <div class="comments">
            <a href="#" id="comment_shower">
              <span class="socicon socicon-disqus fgcolor"></span>
              <span class="disqus-comment-count" data-disqus-identifier="2014-12-13-middleman-tricks-and-hacks.html">Be the first to comment.</span>
            </a>
        </div>
        <div class="sharing">
          <a href="http://www.twitter.com/share?url=http://willschenk.com//middleman-tricks-and-hacks/&amp;text=Middleman Tricks and Hacks by @wschenk" title="Share this post on Twitter" data-lang="en" onclick="return !window.open(this.href, 'Twitter', 'width=640,height=300')"><span class="socicon socicon-twitter fgcolor"></span></a>
      
          <a target="_blank" onclick="return !window.open(this.href, 'Facebook', 'width=640,height=300')" href="http://www.facebook.com/sharer/sharer.php?u=http://willschenk.com//middleman-tricks-and-hacks/" title="Share this post on Facebook"><span class="socicon socicon-facebook fgcolor"></span></a>
      
          <a href="http://plus.google.com/share?url=http://willschenk.com//middleman-tricks-and-hacks/" target="_blank" onclick="return !window.open(this.href, 'Google +', 'width=640,height=300')" title="Share this post on Google +"><span class="socicon socicon-google fgcolor"></span></a>
        </div>
      </div>
        <div class="comment_row">
          <div class="comment_universe">
            <div id="disqus_thread" class="col-sm-10 col-sm-offset-1"></div>
          </div>
        </div>
    </div>
    <footer class='academy'>
      <div class='container'>
        <div class='row'>
          <div class='logo'>
            <a href='http://hfcacademy.com'>
              <img class="img-responsive" src="../images/academy-logo-f112afa1.png" />
            </a>
          </div>
          <div class='body'>
            <h1>Come join us in person!</h1>
            <p>HFC Technology Academy is dedicated to teaching people the skills they need to succeed in the world of technology and startups.</p>
            <p>The Academy is for anyone with the passion to learn about entrepreneurship, development, product management and other skills within the start-up community.</p>
            <h2><a href="http://www.hfcacademy.com/events">Read about our free events</a></h2>
          </div>
        </div>
      </div>
    </footer>
    <footer class='footer  '>
      <div class='container'>
        <div class='row'>
          <div class='social'>
            <span>
              <a class='webicon twitter' href='http://twitter.com/wschenk'></a>
            </span>
            <span>
              <a class='webicon tumblr' href='http://sublimeguile.com/'></a>
            </span>
            <span>
              <a class='webicon instagram' href='http://instagram.com/wschenk'></a>
            </span>
            <span>
              <a class='webicon linkedin' href='http://www.linkedin.com/pub/will-schenk/0/266/420/'></a>
            </span>
            <span>
              <a class='webicon github' href='https://github.com/wschenk'></a>
            </span>
            <span>
              <a class='webicon rss' href='http://willschenk.com/feed.xml'></a>
            </span>
            <span>
              <a class='webicon mail' href='mailto:will@happyfuncorp.com'></a>
            </span>
          </div>
          <div class='made_in_bk'>
            <h3>Made in Brooklyn, NY</h3>
          </div>
        </div>
      </div>
    </footer>
    <script src="../javascripts/application-87c4840f.js" type="text/javascript"></script><script src="../javascripts/modernizr-84a49412.js" type="text/javascript"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.3/highlight.min.js"></script>
    <script type="text/javascript">
      var _gaq=[['_setAccount','UA-56296045-1'],['_trackPageview']];
      (function(d,t){var g=d.createElement(t),s=d.getElementsByTagName(t)[0];
      g.src=('https:'==location.protocol?'//ssl':'//www')+'.google-analytics.com/ga.js';
      s.parentNode.insertBefore(g,s)}(document,'script'));
    </script>
    
    <script type="text/javascript">
      hljs.initHighlightingOnLoad();
      $(".article img").addClass( "img-responsive");
      $("iframe").map( function(e) {
        $(this).css( "max-width", $(this).width() );
        $(this).width( "100%" );
      });
      var _gaq=[['_setAccount','UA-56296045-1'],['_trackPageview']];
      (function(d,t){var g=d.createElement(t),s=d.getElementsByTagName(t)[0];
      g.src=('https:'==location.protocol?'//ssl':'//www')+'.google-analytics.com/ga.js';
      s.parentNode.insertBefore(g,s)}(document,'script'));
      var disqus_shortname = 'willschenk';
        var disqus_identifier = '2014-12-13-middleman-tricks-and-hacks.html';
            
      (function() {
          var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
          dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
          (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      })();
      (function () {
    var s = document.createElement('script'); s.async = true;
    s.type = 'text/javascript';
    s.src = 'http://' + disqus_shortname + '.disqus.com/count.js';
    (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
    </script>
  </body>
</html>
